importScripts("../lib/crop.min.js"),importScripts("../lib/dairy.min.js");var round=Math.round,getGrazingCb=function(r){for(var e=r.sites,t=e.length,o=r.herd.nonDry,n=o.length,a=o.reduce(function(r,e){return r+e.no},0),s=r.timeAtPasture,i=1,h=r.monthStart,p=r.monthEnd,u=r.startYear,f=[],g=[],d=[],l=[],v=[],c=[],m=[],C=0;C<e.length;C++)v.push([]),c.push([]),m.push([]);var y=[],_=[];return function(r,C,b,w){for(var M,S,I,E=parseInt(C.split("-")[1],10),P=parseInt(C.split("-")[0],10),H=0;t>H;H++)if(M=b[H],S=M.isCropPlanted()){I=M.cropGrowth();var O=I.shootOrganicMatterDigestibility(),k=I.shootOrganicMatterContent(),F=I.shootCrudeProteinContent(),q=I.shootCrudeFibreContent(),B=I.height(),G=I.shootBiomassByHeight(.02),D=I.shootBiomass(),R=I.growthIncrement(1)+I.growthIncrement(2),V=I.waterStress(),R=0>R?0:R,j=[],z=0,A=180,L=-70,Q=[],Y=dairy.feed.evaluation.fr.QIL(O,F,A,"fresh",0);if(0===H&&E>=h&&p>=E&&V>.9)for(var x=0;n>x;x++){var J=o[x],K=(dairy.feed.evaluation.fr.E_f(O,k,F,q,"none",A/10,L,0,!1,J.req.fr.main.E,J.req.fr.total.E),dairy.intake.FV_f(Y,round(J.parity)));j[x]=dairy.intake.HI_rg(J.IC,K,1e4*e[H].ha*(J.no/a),100*B,G,R,i,J.no,s)*J.no,z+=j[x],Q.push(K)}else{I.setStockingRate(0);for(var N=0;n>N;N++){j[N]=0;var J=o[N],K=(dairy.feed.evaluation.fr.E_f(O,k,F,q,"none",A/10,L,0,!1,J.req.fr.main.E,J.req.fr.total.E),dairy.intake.FV_f(Y,round(J.parity)));Q.push(K)}}if(z/a>1){I.setStockingRate(a/e[H].ha);for(var T=I.harvestShootBiomass(z/e[H].ha)*e[H].ha,x=0;n>x;x++)j[x]>0&&(j[x]=T*j[x]/z/o[x].no)}else{z=0;for(var x=0;n>x;x++)j[x]=0}if(P>=u){v[H].push((10*R|0)/10);for(var U=[],x=0;n>x;x++)U.push(0===H?(10*j[x]|0)/10:0);f.push(U),y.push(Q),0===H&&(g.push(O),d.push(F),l.push(q),_.push(k)),c[H].push((10*G|0)/10),m[H].push((10*D|0)/10)}}var W=r/b.weather.noOfStepsPossible()*100|0;W%10===0&&postMessage({done:!1,progress:r/b.weather.noOfStepsPossible()*100}),w&&postMessage({done:!0,noCows:a,averageCows:o,HI_g:f,HGR:v,HM_2:c,HM:m,OMD_g:g,CP_g:d,CF_g:l,FV:y,OM_g:_})}};onmessage=function(r){var e=r.data,t=new crop.Configuration(e.weather,e.debug,e.verbose,getGrazingCb(e.grassland));t.run(e.cropConfig.simulation,e.cropConfig.siteAndProd)};