importScripts("../lib/crop.min.js"),importScripts("../lib/dairy.min.js");var round=Math.round,getGrazingCb=function(r){for(var e=r.sites,t=e.length,o=r.herd.nonDry,n=o.length,a=o.reduce(function(r,e){return r+e.no},0),s=r.timeAtPasture,i=1,h=r.monthStart,p=r.monthEnd,u=r.startYear,f=[],g=[],d=[],l=[],v=[],c=[],m=[],C=0;C<e.length;C++)v.push([]),c.push([]),m.push([]);var y=[],_=[];return function(r,C,b,w){for(var M,I,E,P=parseInt(C.split("-")[1],10),S=parseInt(C.split("-")[0],10),H=0;t>H;H++)if(M=b[H],I=M.isCropPlanted()){E=M.cropGrowth();var O=E.shootOrganicMatterDigestibility(),F=E.shootOrganicMatterContent(),q=E.shootCrudeProteinContent(),B=E.shootCrudeFibreContent(),G=E.height(),k=E.shootBiomassByHeight(.02),D=E.shootBiomass(),V=E.growthIncrement(1)+E.growthIncrement(2),j=E.waterStress(),V=0>V?0:V,z=[],A=0,L=180,Q=-70,R=[],Y=dairy.feed.evaluation.fr.QIL(O,q,L,"fresh",0);if(0===H&&P>=h&&p>=P&&j>.9)for(var x=0;n>x;x++){var J=o[x],K=(dairy.feed.evaluation.fr.E_f(O,F,q,B,"none",L/10,Q,0,!1,J.req.fr.main.E,J.req.fr.total.E),dairy.intake.FV_f(Y,round(J.parity)));z[x]=dairy.intake.HI_rg(J.IC,K,1e4*e[H].ha*(J.no/a),100*G,k,V,i,J.no,s)*J.no,A+=z[x],R.push(K)}else for(var N=0;n>N;N++){z[N]=0;var J=o[N],K=(dairy.feed.evaluation.fr.E_f(O,F,q,B,"none",L/10,Q,0,!1,J.req.fr.main.E,J.req.fr.total.E),dairy.intake.FV_f(Y,round(J.parity)));R.push(K)}if(A/a>1)for(var T=E.harvestShootBiomass(A/e[H].ha)*e[H].ha,x=0;n>x;x++)z[x]>0&&(z[x]=T*z[x]/A/o[x].no);else{A=0;for(var x=0;n>x;x++)z[x]=0}if(S>=u){v[H].push((10*V|0)/10);for(var U=[],x=0;n>x;x++)U.push(0===H?(10*z[x]|0)/10:0);f.push(U),y.push(R),0===H&&(g.push(O),d.push(q),l.push(B),_.push(F)),c[H].push((10*k|0)/10),m[H].push((10*D|0)/10)}}var W=r/b.weather.noOfStepsPossible()*100|0;W%10===0&&postMessage({done:!1,progress:r/b.weather.noOfStepsPossible()*100}),w&&postMessage({done:!0,noCows:a,averageCows:o,HI_g:f,HGR:v,HM_2:c,HM:m,OMD_g:g,CP_g:d,CF_g:l,FV:y,OM_g:_})}};onmessage=function(r){var e=r.data,t=new crop.Configuration(e.weather,e.debug,e.verbose,getGrazingCb(e.grassland));t.run(e.cropConfig.simulation,e.cropConfig.siteAndProd)};