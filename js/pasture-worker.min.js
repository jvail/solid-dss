importScripts("../lib/crop.min.js"),importScripts("../lib/dairy.min.js");var round=Math.round,getGrazingCb=function(r){for(var e=r.sites,t=e.length,o=r.herd.nonDry,s=o.length,n=o.reduce(function(r,e){return r+e.no},0),a=r.timeAtPasture,i=1,h=r.monthStart,p=r.monthEnd,u=r.startYear,g=[],f=[],d=[],l=[],v=[],c=[],C=[],m=0;m<e.length;m++)v.push([]),c.push([]),C.push([]);var b=[],w=[];return function(r,m,y,M){for(var _,I,P,S=parseInt(m.split("-")[1],10),H=parseInt(m.split("-")[0],10),O=0;t>O;O++)if(_=y[O],I=_.isCropPlanted()){P=_.cropGrowth();var B=P.shootOrganicMatterDigestibility(),E=P.shootOrganicMatterContent(),F=P.shootCrudeProteinContent(),G=P.shootCrudeFibreContent(),D=P.height(),j=P.shootBiomassByHeight(.02),k=P.shootBiomass(),q=P.growthIncrement(1)+P.growthIncrement(2),z=P.waterStress(),q=0>q?0:q,A=[],V=0,L=180,Q=80,R=[],Y=dairy.feed.evaluation.fr.QIL(B,F,L,"fresh",0);if(0===O&&S>=h&&p>=S&&z>.9)for(var x=0;s>x;x++){var J=o[x],K=(dairy.feed.evaluation.fr.E_f(B,E,F,G,"none",L/1e3,Q,0,!1,J.req.fr.main.E,J.req.fr.total.E),dairy.intake.FV_f(Y,round(J.parity)));A[x]=dairy.intake.HI_rg(J.IC,K,1e4*e[O].ha*(J.no/n),100*D,j,q,i,J.no,a)*J.no,V+=A[x],R.push(K)}else for(var N=0;s>N;N++)A[N]=0,R.push(0);if(V/n>1)for(var T=P.harvestShootBiomass(V/e[O].ha)*e[O].ha,x=0;s>x;x++)A[x]>0&&(A[x]=T*A[x]/V/o[x].no);else{V=0;for(var x=0;s>x;x++)A[x]=0}if(H>=u){v[O].push((10*q|0)/10);for(var U=[],x=0;s>x;x++)U.push(0===O?(10*A[x]|0)/10:0);g.push(U),b.push(R),0===O&&(f.push(B),d.push(F),l.push(G),w.push(E)),c[O].push((10*j|0)/10),C[O].push((10*k|0)/10)}}var W=r/y.weather.noOfStepsPossible()*100|0;W%10===0&&postMessage({done:!1,progress:r/y.weather.noOfStepsPossible()*100}),M&&postMessage({done:!0,noCows:n,averageCows:o,HI_g:g,HGR:v,HM_2:c,HM:C,OMD_g:f,CP_g:d,CF_g:l,FV:b,OM_g:w})}};onmessage=function(r){var e=r.data,t=new crop.Configuration(e.weather,e.debug,e.verbose,getGrazingCb(e.grassland));t.run(e.cropConfig.simulation,e.cropConfig.siteAndProd)};