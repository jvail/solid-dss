importScripts("../lib/crop.min.js");var getArableCb=function(e,t){for(var r=t.cutThreshhold,s=t.startYear,i=(t.hayShare,e.length),a=[],o=[],n=[],u=[],l=[],d=0;i>d;d++)n[d]={},u[d]={},o[d]={waterStress:[],nitrogenStress:[],irrigation:[],date:[],biomass:[],"yield":[]},l[d]={waterStress:[],nitrogenStress:[],irrigation:[],date:[],biomass:[]};return function(e,t,d,p){var C,g,h,c,f,m,M,y=(parseInt(t.split("-")[1],10),parseInt(t.split("-")[0],10)),S=0;if(!(s>y)){for(var D=0;i>D;D++){if(C=d[D],g=C.isCropPlanted()){if(h=C.cropGrowth(),h.relativeTotalDevelopment()<.9?(o[D].waterStress.push(1-h.waterStress()),o[D].nitrogenStress.push(1-h.nitrogenStress()),o[D].irrigation.push(C.dailySumIrrigationWater()),o[D].biomass.push(h.shootBiomass())):(o[D].waterStress.push(0),o[D].nitrogenStress.push(0),o[D].irrigation.push(C.dailySumIrrigationWater()),o[D].biomass.push(h.shootBiomass())),"grassland"===h.name()&&(void 0===n[D][y]&&(n[D][y]={firstCut:{DMyield:0,OM:0,OMD:0,CP:0,CF:0},lateCut:{DMyield:0,OM:0,OMD:0,CP:0,CF:0}}),C.getIsVegPeriod()&&h.shootBiomass()-800>=r)){if(S=h.harvestShootBiomass(h.shootBiomass()-800),M=h.shootOrganicMatterDigestibility(),c=h.shootOrganicMatterContent(),f=h.shootCrudeProteinContent(),m=h.shootCrudeFibreContent(),0===n[D][y].firstCut.DMyield)n[D][y].firstCut.DMyield=S,n[D][y].firstCut.OM=c,n[D][y].firstCut.OMD=M,n[D][y].firstCut.CP=f,n[D][y].firstCut.CF=m;else{var b=n[D][y].lateCut.DMyield+S,v=n[D][y].lateCut.DMyield/b,F=S/b;n[D][y].lateCut.DMyield=b,n[D][y].lateCut.OM=n[D][y].lateCut.OM*v+c*F,n[D][y].lateCut.OMD=n[D][y].lateCut.OMD*v+M*F,n[D][y].lateCut.CP=n[D][y].lateCut.CP*v+f*F,n[D][y].lateCut.CF=n[D][y].lateCut.CF*v+m*F}n[D][t]=S,void 0===o[D]["yield"][y-s]?o[D]["yield"][y-s]={DM:S,cropName:h.name()}:o[D]["yield"][y-s].DM+=S}}else o[D].waterStress.push(0),o[D].nitrogenStress.push(0),o[D].irrigation.push(0),o[D].biomass.push(0);o[D].date.push(t),C.resetDailyCounter()}var O=e/d.weather.noOfStepsPossible()*100|0;if(O%10===0&&postMessage({done:!1,progress:e/d.weather.noOfStepsPossible()*100}),p){for(var D=0;i>D;D++)a[D]=d[D].yields(),a[D].forEach(function(e){o[D]["yield"][e.year-s]={DM:e["yield"],cropName:e.crop},u[D][e.year]="maize-silage"===e.crop?e["yield"]:0});for(var w=10,P=o[0].date.length;P>w;){for(var D=0;i>D;D++)l[D].date.push(o[D].date[w-5]),l[D].waterStress.push(parseFloat(o[D].waterStress.slice(w-10,w).reduce(function(e,t){return e+t/10},0).toFixed(2))),l[D].nitrogenStress.push(parseFloat(o[D].nitrogenStress.slice(w-10,w).reduce(function(e,t){return e+t/10},0).toFixed(2))),l[D].irrigation.push(parseFloat(o[D].irrigation.slice(w-10,w).reduce(function(e,t){return e+t/10},0).toFixed(2))),l[D].biomass.push(parseFloat(o[D].biomass.slice(w-10,w).reduce(function(e,t){return e+t/10},0).toFixed(2)));w+=10}postMessage({done:!0,yields:a,grasslandDM:n,maizeDM:u,params:o,paramsAvg:l}),close()}}}};onmessage=function(e){var t=e.data,r=new crop.Configuration(t.weather,t.debug,t.verbose,getArableCb(t.cropConfig.siteAndProd,t.grassland));r.run(t.cropConfig.simulation,t.cropConfig.siteAndProd)};