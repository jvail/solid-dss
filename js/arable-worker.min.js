importScripts("../lib/crop.min.js");var getArableCb=function(e,t){for(var r=t.cutThreshhold,s=t.startYear,i=(t.hayShare,e.length),a=[],o=[],n=[],u=[],l=[],d=0;i>d;d++)n[d]={},u[d]={},o[d]={waterStress:[],nitrogenStress:[],irrigation:[],date:[],biomass:[],"yield":[]},l[d]={waterStress:[],nitrogenStress:[],irrigation:[],date:[],biomass:[]};return function(e,t,d,p){var C,g,h,c,f,m,M,y=(parseInt(t.split("-")[1],10),parseInt(t.split("-")[0],10)),S=0;if(!(s>y)){for(var b=0;i>b;b++){if(C=d[b],g=C.isCropPlanted()){if(h=C.cropGrowth(),h.relativeTotalDevelopment()<.9?(o[b].waterStress.push(1-h.waterStress()),o[b].nitrogenStress.push(1-h.nitrogenStress()),o[b].irrigation.push(C.dailySumIrrigationWater()),o[b].biomass.push(h.biomass())):(o[b].waterStress.push(0),o[b].nitrogenStress.push(0),o[b].irrigation.push(C.dailySumIrrigationWater()),o[b].biomass.push(h.biomass())),"grassland"===h.name()&&(void 0===n[b][y]&&(n[b][y]={firstCut:{DMyield:0,OM:0,OMD:0,CP:0,CF:0},lateCut:{DMyield:0,OM:0,OMD:0,CP:0,CF:0}}),C.getIsVegPeriod()&&h.shootBiomass()-800>=r)){if(S=h.harvestShootBiomass(h.shootBiomass()-800),M=h.shootOrganicMatterDigestibility(),c=h.shootOrganicMatterContent(),f=h.shootCrudeProteinContent(),m=h.shootCrudeFibreContent(),0===n[b][y].firstCut.DMyield)n[b][y].firstCut.DMyield=S,n[b][y].firstCut.OM=c,n[b][y].firstCut.OMD=M,n[b][y].firstCut.CP=f,n[b][y].firstCut.CF=m;else{var D=n[b][y].lateCut.DMyield+S,v=n[b][y].lateCut.DMyield/D,F=S/D;n[b][y].lateCut.DMyield=D,n[b][y].lateCut.OM=n[b][y].lateCut.OM*v+c*F,n[b][y].lateCut.OMD=n[b][y].lateCut.OMD*v+M*F,n[b][y].lateCut.CP=n[b][y].lateCut.CP*v+f*F,n[b][y].lateCut.CF=n[b][y].lateCut.CF*v+m*F}n[b][t]=S,void 0===o[b]["yield"][y-s]?o[b]["yield"][y-s]={DM:S,cropName:h.name()}:o[b]["yield"][y-s].DM+=S}}else o[b].waterStress.push(0),o[b].nitrogenStress.push(0),o[b].irrigation.push(0),o[b].biomass.push(0);o[b].date.push(t),C.resetDailyCounter()}var O=e/d.weather.noOfStepsPossible()*100|0;if(O%10===0&&postMessage({done:!1,progress:e/d.weather.noOfStepsPossible()*100}),p){for(var b=0;i>b;b++)a[b]=d[b].yields(),a[b].forEach(function(e){o[b]["yield"][e.year-s]={DM:e["yield"],cropName:e.crop},u[b][e.year]="maize-silage"===e.crop?e["yield"]:0});for(var w=10,P=o[0].date.length;P>w;){for(var b=0;i>b;b++)l[b].date.push(o[b].date[w-5]),l[b].waterStress.push(parseFloat(o[b].waterStress.slice(w-10,w).reduce(function(e,t){return e+t/10},0).toFixed(2))),l[b].nitrogenStress.push(parseFloat(o[b].nitrogenStress.slice(w-10,w).reduce(function(e,t){return e+t/10},0).toFixed(2))),l[b].irrigation.push(parseFloat(o[b].irrigation.slice(w-10,w).reduce(function(e,t){return e+t/10},0).toFixed(2))),l[b].biomass.push(parseFloat(o[b].biomass.slice(w-10,w).reduce(function(e,t){return e+t/10},0).toFixed(2)));w+=10}postMessage({done:!0,yields:a,grasslandDM:n,maizeDM:u,params:o,paramsAvg:l}),close()}}}};onmessage=function(e){var t=e.data,r=new crop.Configuration(t.weather,t.debug,t.verbose,getArableCb(t.cropConfig.siteAndProd,t.grassland));r.run(t.cropConfig.simulation,t.cropConfig.siteAndProd)};