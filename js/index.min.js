$(function(){var e=!1,a=!1,r=new Worker("lib/zee/zee-worker.js"),t=new Worker("lib/lmfit-worker.js"),s=new Worker("js/pasture-worker.min.js"),i=new Worker("js/grassland-worker.min.js"),n=[],o=[],l=null,d=30.5,u={"sandy clay loam":{sand:60,clay:20,textureClass_DE:"Ls4"},"clay loam":{sand:30,clay:35,textureClass_DE:"Lt2"},loam:{sand:40,clay:20,textureClass_DE:"Ls2"},"sandy loam":{sand:65,clay:10,textureClass_DE:"Sl3"},"loamy sand":{sand:80,clay:5,textureClass_DE:"Sl2"},"silt loam":{sand:20,clay:10,textureClass_DE:"Ut2"},"silty clay loam":{sand:10,clay:30,textureClass_DE:"Lu"}},c=[];r.onmessage=function(e){if("function"!=typeof c[e.data.callbackID])throw new Error(c[e.data.callbackID]);c[e.data.callbackID](e.data.data),c[e.data.callbackID]=null},dss.parameter={wood:null},dss.herd={},dss.model={location:{},soil:{},herd:{},feed:{},crop:{},rotation:[],grassland:{},fertilizer:{},simulation:{}},dss.schema={location:{},soil:{},herd:{},feed:{},crop:{},grassland:{},fertilizer:{},simulation:{}},dss.weather={tmin:[],tmax:[],tavg:[],globrad:[],wind:[],sunhours:[],relhumid:[],precip:[],ppf:[],daylength:[],f_directrad:[],date:[],doy:[],exrad:[]},dss.feeds=null,dss.fn={updateModel:function(e,a){var r=dss.ui.model().model[e],t=dss.model[e];if(Array.isArray(a))for(var s=0,i=a.length;i>s;s++)t[a[s]]=r[a[s]];else dss.model[e]=r},modelChanged:function(e,a){var r=dss.ui.model().model[e],t=dss.model[e];if("rotation"===e){if("length"===a)return r.length!==t.length}else{var s=Object.keys(r);if(Array.isArray(a)){for(var i=0,n=a.length;n>i;i++)if(!t.hasOwnProperty(a[i])||r[a[i]]!==t[a[i]])return!0}else for(var i=0,n=s.length;n>i;i++)if(!t.hasOwnProperty(s[i])||r[s[i]]!==t[s[i]])return!0}return!1},updateWeather:function(){var e=parseFloat(Number($("#latitude").prop("value")).toFixed(3)),a=parseFloat(Number($("#longitude").prop("value")).toFixed(3));if(dss.fn.modelChanged("location")||dss.fn.modelChanged("rotation","length")||dss.fn.modelChanged("simulation",["start-year"])||!(dss.ui.charts.weather.data().length>0)){dss.fn.updateModel("location"),dss.fn.updateModel("simulation",["start-year"]),dss.fn.updateModel("rotation");{(new Spinner).spin($("#weather-charts")[0])}dss.fn.weather(e,a,function(e,a){if($("#weather-charts .spinner").remove(),null===e&&a)return void $(getAlert("Error.",a.text,"danger")).prependTo($("body")).delay(6e3).fadeOut(500,function(){$(this).remove()});var r=parseInt(dss.model.simulation["start-year"],10),t=365*(r-1995),s=dss.model.rotation.length,i={date:e.date.slice(t,t+365*s),precip:e.precip.slice(t,t+365*s),tavg:e.tavg.slice(t,t+365*s),daylength:e.daylength.slice(t,t+365*s),globrad:e.globrad.slice(t,t+365*s)},n=i.date.reduce(function(e,a){var r=a.substring(0,7);return r+"-01"!==e[e.length-1]&&e.push(r+"-01"),e},["x"]),o=i.precip.reduce(function(e,a,r){var t=i.date[r].substring(0,7);return t+"-01"!==n[e.length-1]?e.push(a):e[e.length-1]+=a,e},["precipitation"]),l=i.tavg.reduce(function(e,a,r){var t=i.date[r].substring(0,7);return 0===e.length||t!==e[e.length-1].month?e.push({month:t,value:a,count:1}):(e[e.length-1].value+=a,e[e.length-1].count+=1),e},[]).reduce(function(e,a){return e.push(a.value/a.count),e},["temperature"]),d=i.globrad.reduce(function(e,a,r){var t=i.date[r].substring(0,7);return 0===e.length||t!==e[e.length-1].month?e.push({month:t,value:a,count:1}):(e[e.length-1].value+=a,e[e.length-1].count+=1),e},[]).reduce(function(e,a){return e.push(a.value/a.count),e},["radiation"]),u=i.daylength.reduce(function(e,a,r){var t=i.date[r].substring(0,7);return 0===e.length||t!==e[e.length-1].month?e.push({month:t,value:a,count:1}):(e[e.length-1].value+=a,e[e.length-1].count+=1),e},[]).reduce(function(e,a){return e.push(a.value/a.count),e},["daylength"]);dss.ui.charts.weather.load({columns:[n,o,l,u,d]})})}},solar:weather.solar,rh:weather.rh,weather:function(e,a,t){function s(e,a,t){r.postMessage({filename:e,data:a,callbackID:c.length}),c.push(t)}for(var i=[.125,.375,.625,.875],n=0,o=0,l=Number("0."+e.toFixed(3).split(".")[1]),d=Number("0."+a.toFixed(3).split(".")[1]),u=0|e,g=0|a,f=0;f<i.length;f++)Math.abs(i[f]-l)<=.125&&(n=Number(u.toString()+"."+i[f].toString().split(".")[1])),Math.abs(i[f]-d)<=.125&&(o=Number(g.toString()+"."+i[f].toString().split(".")[1]));var f=0,p={rr:null,tn:null,tg:null,tx:null},h=["rr_"+n+"_"+o+".json.gz","tn_"+n+"_"+o+".json.gz","tg_"+n+"_"+o+".json.gz","tx_"+n+"_"+o+".json.gz"],m=["https://zalf-lse.github.io/rr/rr_"+n+"_"+o+".json.gz","https://zalf-lse.github.io/tn/tn_"+n+"_"+o+".json.gz","https://zalf-lse.github.io/tg/tg_"+n+"_"+o+".json.gz","https://zalf-lse.github.io/tx/tx_"+n+"_"+o+".json.gz"],y=new XMLHttpRequest;y.open("GET",m[f],!0),y.responseType="arraybuffer",y.onload=function(){200===y.status?(!function(r,t,i){s(h[t],new Uint8Array(y.response),function(s){for(var n="",o=0,l=s.byteLength;l>o;o++)n+=String.fromCharCode(s[o]);if(p[r]=JSON.parse(n),t===m.length-1){var d=dss.weather;Object.keys(d).forEach(function(e){d[e]=[]});for(var u=0;u<p.tx.values.length;u++)d.tmax.push(p.tx.values[u]*p.tx.scale),d.tmin.push(p.tn.values[u]*p.tn.scale),d.tavg.push(p.tg.values[u]*p.tg.scale),d.precip.push(p.rr.values[u]*p.rr.scale),d.tmax[u]<d.tmin[u]&&(d.tmax[u]=2*d.tavg[u]-d.tmin[u]),d.precip[u]<0&&(d.precip[u]=0);for(var c=dss.fn.solar(e,d.tmin,d.tmax,"1995-01-01"),u=0,g=c.PPF.length;g>u;u++)d.globrad[u]=c.R_s[u],d.f_directrad[u]=c.f_s[u],d.daylength[u]=c.N[u],d.sunhours[u]=c.N[u],d.relhumid[u]=dss.fn.rh(d.tmin[u],d.tmax[u]),d.date[u]=c.date[u],d.doy[u]=c.doy[u],d.exrad[u]=c.R_a[u],d.wind[u]=2;dss.model.location.latitude=e,dss.model.location.longitude=a,i&&i(d)}})}(h[f].split("_")[0],f,t),f++,f<m.length&&(y.open("GET",m[f],!0),y.send(null))):t(null,{text:"No weather data available for coordinates: latitude: "+e+" / longitude: "+a})},y.send(null)},fitWood:function(e,a){t.onmessage=function(e){Array.isArray(e.data)&&(dss.parameter.wood=e.data),a&&a(e.data)},t.postMessage({f:{},n:3,par:[17,.149,-.034],m:e.t.length,t:e.t,y:e.y})},wood:function(e,a){return a[0]*Math.pow(e,a[1])*Math.exp(a[2]*e)},herdStructure:function(e){var a=dss.ui.model().model,r=a.herd,t=r["calving-season"];dss.herd=dairy.herd.get({ageFirstCalving:r["age-first-calving"],femaleCalfRate:.47,stillBirthRate:.07,youngStockCullRate:r["young-stock-cull-rate"]/100,replacementRate:r["replacement-rate"]/100,calvingInterval:t>0?12:r["calving-interval"],herdSize:r["herd-size"],dryPeriode:r["dry-periode"]/(30.5/7)}),e&&e([["parity1",dss.herd.cowsPerLac[0]],["parity2",dss.herd.cowsPerLac[1]],["parity3",dss.herd.cowsPerLac[2]],["heifers_in",dss.herd.heifersBought],["heifers_out",dss.herd.heifersSold]])},herdDevelopment:function(){},cowProperties:function(){for(var e=dss.ui.model().model.herd,a=dss.ui.model().model.feed,r=dss.parameter.wood,t=e["is-dual-purpose"],s=e["mature-bodyweight"],i=e["age-first-calving"],n=e["weight-first-calving"],o=e["milk-fat"],l=e["milk-protein"],u=e["calving-interval"],c=e["dry-periode"],g=dairy.body.weightAtBirth(s),f=0===a["concentrate-share"]?1:.5,p=0,h=dss.herd.cows.length;h>p;p++){var m=dss.herd.cows[p];m.req={de:{},fi:{},gb:{},fr:{}},m.d_mx=dairy.milk.d_mx(r[1],r[2],m.P),m.BW=dairy.body.BW(m.DPP,m.d_mx,m.AGE_days,u,s,i,g,n,t),m.BWC=dairy.body.BWC(m.DPP,m.d_mx,m.AGE_days,u,s,i,g,n,t),m.BCS=dairy.body.BCS(m.DPP,u,7*c,m.P,m.d_mx),m.BW_c=dairy.body.BW_c(m.DPP,m.AGE_days,s,i,g,n),m.PLPOT=dairy.milk.milk(r[0],r[1],r[2],m.DPP/7,m.P,m.BW_c,s),m.milk=m.isDry?0:m.PLPOT;var y=dairy.milk.fat_a(o,m.P,m.d_mx/7),v=dairy.milk.protein_a(l,m.P,m.d_mx/7);m.fat=m.isDry?0:dairy.milk.fat(y,m.DIM/7,m.P,m.d_mx/7),m.protein=m.isDry?0:dairy.milk.protein(v,m.DIM/7,m.P,m.d_mx/7),m.milk305=dairy.milk.milk_305(r[0],r[1],r[2],m.P,m.BW_c,s),m.IC=dairy.intake.IC(m.BW,m.milk,m.BCS,m.DIM/7,m.DG/7,m.AGE_days/d,m.P),m.req.fi={main:dairy.requirements.fi.main(m.BW,m.IC,f,m.P),prod:m.isDry?{E:0,P:0}:dairy.requirements.fi.prod(m.milk,m.fat,m.protein,m.P),gest:dairy.requirements.fi.gest(m.DG/7,m.P),weit:dairy.requirements.fi.weit(m.BWC,m.P),total:{E:0,P:0}},m.req.fi.total.E=m.req.fi.main.E+m.req.fi.prod.E+m.req.fi.gest.E+m.req.fi.weit.E,m.req.fi.total.P=m.req.fi.main.P+m.req.fi.prod.P+m.req.fi.gest.P+m.req.fi.weit.P;var b=195;m.req.gb={main:dairy.requirements.gb.main(m.BW,m.IC,b,f,null,null,m.BWC,m.P),prod:m.isDry?{E:0,P:0}:dairy.requirements.gb.prod(m.milk,m.fat,m.protein,m.P),gest:dairy.requirements.gb.gest(m.DG/7,s,m.P),weit:dairy.requirements.gb.weit(m.BWC,m.P),total:{E:0,P:0}},m.req.gb.total.E=m.req.gb.main.E+m.req.gb.prod.E+m.req.gb.gest.E+m.req.gb.weit.E,m.req.gb.total.P=m.req.gb.main.P+m.req.gb.prod.P+m.req.gb.gest.P+m.req.gb.weit.P,m.req.gb.main=dairy.requirements.gb.main(m.BW,m.IC,m.req.gb.total.E,f,null,null,m.BWC,m.P),m.req.gb.total.E=m.req.gb.main.E+m.req.gb.prod.E+m.req.gb.gest.E+m.req.gb.weit.E,m.req.gb.total.P=m.req.gb.main.P+m.req.gb.prod.P+m.req.gb.gest.P+m.req.gb.weit.P,m.req.fr={main:dairy.requirements.fr.main(m.BW,m.IC,f,m.P),prod:m.isDry?{E:0,P:0}:dairy.requirements.fr.prod(m.milk,m.fat,m.protein,m.P),gest:dairy.requirements.fr.gest(m.DG/7,g,m.P),weit:dairy.requirements.fr.weit(m.BW,m.BWC,m.DPP/7,m.P),total:{E:0,P:0}},m.req.fr.total.E=m.req.fr.main.E+m.req.fr.prod.E+m.req.fr.gest.E+m.req.fr.weit.E,m.req.fr.total.P=m.req.fr.main.P+m.req.fr.prod.P+m.req.fr.gest.P+m.req.fr.weit.P,m.req.de={main:dairy.requirements.de.main(m.BW,m.IC,f,m.P),prod:m.isDry?{E:0,P:0}:dairy.requirements.de.prod(m.milk,m.fat,m.protein,m.P),gest:dairy.requirements.de.gest(m.DG/7,m.DIM,m.P),weit:dairy.requirements.de.weit(m.BWC,m.BW,m.P),total:{E:0,P:0}},m.req.de.total.E=m.req.de.main.E+m.req.de.prod.E+m.req.de.gest.E+m.req.de.weit.E,m.req.de.total.P=m.req.de.main.P+m.req.de.prod.P+m.req.de.gest.P+m.req.de.weit.P,m.FV_c=dairy.intake.FV_cs_diet(m.req.fr.total.E,m.IC,settings.CC,m.PLPOT,m.P,m.BWC)}},cropGrowth:function(r,t){function l(){for(var e=!0,a=0;a<_.arable.length;a++)void 0===_.arable[a]&&(e=!1);var r=_.arable.length===q.length;return r&&e&&null!==_.pasture&&null!==_.grassland}function d(){setTimeout(function(){t(_)},1e3)}function c(e,a){return f.rotation[e].filter(function(e){return e.id===a})}function g(e,a,r){if(!(e+1>f.rotation.length-1)){if(a.to.length>1)throw new Error(a);var t=JSON.parse(JSON.stringify(c(e+1>f.rotation.length-1?0:e+1,a.to[0]))),s=JSON.parse(JSON.stringify(t[0].to));t[0].to=[s[0]],r.area=r.area/s.length,r.push(t[0]);for(var i=1;i<s.length;i++){var n=JSON.parse(JSON.stringify(r));n.area=r.area,n[n.length-1].to=[s[i]];var o=F.push(n);g(e+1,n[n.length-1],F[o-1])}g(e+1,t[0],r)}}dss.fn.updateWeather();for(var f=dss.model=dss.ui.model().model,p=f.grassland["grassland-area"],h=f.grassland["pasture-share"],m="rotational",y=f.grassland["time-at-pasture"],v=(f.grassland["cut-threshhold"],f.herd["herd-size"],parseInt(f.simulation["start-year"],10)),b=dss.model.rotation.length,_=(dss.ui.rotation.splitted().length,{pasture:null,grassland:null,arable:[]}),F=[],E=0;E<f.rotation[0].length;E++)for(var C=f.rotation[0][E],P=JSON.parse(JSON.stringify(C.to)),D=0;D<P.length;D++){var w=JSON.parse(JSON.stringify(C));w.to=[P[D]];var O=[w];O.area=1/P.length,F.push(O),g(0,w,O)}F.forEach(function(e){n.push(e.area)});for(var M=[],q=[],S=[],E=0;E<F.length;E++){var k=[];S.push(k);for(var N=0;N<F[E].length;N++)k.push(F[E].slice(N,F[E].length).concat(F[E].slice(0,N)));q.push(new Worker("js/arable-worker.min.js"))}o=[];for(var E=0;E<S.length;E++){k=S[E],M.push([]),o.push([]);for(var N=0;N<k.length;N++){var O=k[N],x=[];M[E].push({crops:x}),o[E].push([]);for(var I=0;I<O.length;I++){var A=O[I].crop;if("grass-legume"!==A.name){var j=[];switch(A.name){case"wheat":default:j=[148,f.crop["wheat-emergence-to-double-ridge"],f.crop["wheat-double-ridge-to-flowering"],f.crop["wheat-flowering-to-begin-grain-filling"],f.crop["wheat-grain-filling"],25];break;case"barley":j=[108,f.crop["barley-emergence-to-double-ridge"],f.crop["barley-double-ridge-to-flowering"],f.crop["barley-flowering-to-begin-grain-filling"],f.crop["barley-grain-filling"],25];break;case"rye":j=[148,f.crop["rye-emergence-to-double-ridge"],f.crop["rye-double-ridge-to-flowering"],f.crop["rye-flowering-to-begin-grain-filling"],f.crop["rye-grain-filling"],25];break;case"oats":j=[100,f.crop["oats-emergence-to-double-ridge"],f.crop["oats-double-ridge-to-flowering"],f.crop["oats-flowering-to-begin-grain-filling"],f.crop["oats-grain-filling"],25];break;case"maize-silage":j=[68,f.crop["maize-emergence-to-shooting"],f.crop["maize-shooting-to-tasseling"],f.crop["maize-tasseling-to-flowering"],f.crop["maize-flowering-to-corn-filling"],f.crop["maize-corn-filling"],25]}x.push({model:"generic",species:[{name:A.name,dryMatterFraction:1}],options:{plantDryWeight:225,pc_StageTemperatureSum:j,autoIrrigationOn:"Yes"===A.parameter.irrigation.value[0]},sowingDate:["beet","soy","maize-silage"].indexOf(A.name)<0?v+I-1+"-10-16":v+I+"-05-15",finalHarvestDate:["beet","soy","maize-silage"].indexOf(A.name)<0?v+I+"-08-01":v+I+"-10-01",harvestDates:[],residuesRemoval:.85,tillageOperations:[],irrigations:[],organicFertilisers:[],mineralFertilisers:[{name:"...",date:["beet","soy","maize-silage"].indexOf(A.name)<0?v+I+"-04-01":v+I+"-05-15",method:"Fixed",amount:parseFloat(A.parameter["N-input"].value),no3:1}]}),o[E][N].push({cropName:A.name,seed:x[x.length-1].sowingDate,harvest:x[x.length-1].finalHarvestDate})}else if(0===I||O[I-1]&&O[I-1].crop.name!==A.name){for(var L=1,z=[{name:"...",date:v+I+"-04-01",method:"Fixed",amount:parseFloat(A.parameter["N-input"].value),no3:1}],D=I+1;D<O.length&&O[D].crop.name===A.name;D++)z.push({name:"...",date:v+D+"-04-01",method:"Fixed",amount:parseFloat(A.parameter["N-input"].value),no3:1}),L++;x.push({model:"grassland",species:[{name:"grass",dryMatterFraction:1-parseFloat(A.parameter["legume-share"].value)/100,constants:{part:{GDD_flower:f.crop["grass-flowering"],"ρ_shoot_ref":.75,"ρ_l_max":.7}}},{name:"clover",dryMatterFraction:parseFloat(A.parameter["legume-share"].value)/100}],sowingDate:v+I-1+"-10-17",plantDryWeight:0===I&&O[O.length-1].crop.name===A.name?2e3:225,finalHarvestDate:v+I-1+L+"-09-01",harvestDates:[],residuesRemoval:.85,autoIrrigationOn:"Yes"===A.parameter.irrigation.value[0],tillageOperations:[{date:v+I-1+L+"-09-02",method:"Plough",depth:30}],irrigations:[],organicFertilisers:[],mineralFertilisers:z}),o[E][N].push({cropName:A.name,seed:x[x.length-1].sowingDate,harvest:x[x.length-1].finalHarvestDate})}}}}for(var G=[{thickness:.2,Corg:.01,sand:u[f.soil["topsoil-texture"]].sand/100,clay:u[f.soil["topsoil-texture"]].clay/100,sceleton:0},{thickness:1.8,Corg:.01,sand:u[f.soil["subsoil-texture"]].sand/100,clay:u[f.soil["subsoil-texture"]].clay/100,sceleton:0}],B={latitude:f.location.latitude,slope:0,heightNN:1,horizons:G},Q={time:{startDate:v-1+"-01-01",endDate:dss.weather.date[365*(v-1-1995)+365*(b+1)]},switches:{useSecondaryYieldOn:!1,nitrogenResponseOn:!0,waterDeficitResponseOn:!0,emergenceMoistureControlOn:!1,emergenceFloodingControlOn:!1},init:{percentageFC:1,soilNitrate:.001,soilAmmonium:1e-4}},W={latitude:f.location.latitude,slope:0,heightNN:1,horizons:G},R={crops:[{model:"grassland",species:[{name:"grass",dryMatterFraction:1-parseFloat(f.grassland["grassland-legume-share"])/100,constants:{part:{GDD_flower:f.crop["grass-flowering"],"ρ_shoot_ref":.75,"ρ_l_max":.7}}},{name:"clover",dryMatterFraction:parseFloat(f.grassland["grassland-legume-share"])/100}],sowingDate:null,plantDryWeight:2e3,finalHarvestDate:null,tillageOperations:[],irrigations:[],organicFertilisers:[],mineralFertilisers:[]}]},E=0;b>E;E++)R.crops[0].mineralFertilisers.push({name:"...",date:v+E+"-04-01",method:"Fixed",amount:parseFloat(f.grassland["grassland-N-input"]),no3:1});arableConfigs=[];for(var T="",E=0;E<M.length;E++){var J={simulation:Q,siteAndProd:[]};arableConfigs.push(J);for(var N=0;N<M[E].length;N++)J.siteAndProd.push({site:B,production:M[E][N]});var H=M[E][0].crops.reduce(function(e,a){return e.push(a.species[0].name),e},[]).join(" - ");T+="<p>Arable ("+H+')<p>          <div class="progress">            <div id="progress-arable-'+E+'" class="progress-bar progress-bar-warning" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;">            </div>          </div>\n'}var V={simulation:{time:{startDate:v-1+"-01-01",endDate:dss.weather.date[365*(v-1-1995)+365*(b+1)]},switches:{useSecondaryYieldOn:!1,nitrogenResponseOn:!0,waterDeficitResponseOn:!0,emergenceMoistureControlOn:!1,emergenceFloodingControlOn:!1},init:{percentageFC:1,soilNitrate:.001,soilAmmonium:1e-4}},siteAndProd:[{site:W,production:R}]},Y=({simulation:{time:{startDate:v-1+"-01-01",endDate:dss.weather.date[365*(v-1-1995)+365*(b+1)]},switches:{useSecondaryYieldOn:!1,nitrogenResponseOn:!0,waterDeficitResponseOn:!0,emergenceMoistureControlOn:!1,emergenceFloodingControlOn:!1},init:{percentageFC:1,soilNitrate:.001,soilAmmonium:1e-4}},siteAndProd:[{site:W,production:R}]},[{ha:p*(1-h/100)}]),U=[{ha:p*(h/100)}];$("#progress-dlg .modal-body").empty().html(T+'<p>Grassland<p>          <div class="progress">            <div id="progress-grassland" class="progress-bar progress-bar-success" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;">            </div>          </div>          <p>Pasture<p>          <div class="progress">            <div id="progress-pasture" class="progress-bar progress-bar-success" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;">            </div>          </div>          <p>Diets<p>          <div class="progress">            <div id="progress-diets" class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;">            </div>          </div>'),s.onmessage=function(){var a=$("#progress-pasture");return function(r){e&&console.log(r.data);var t=r.data;a.css("width",t.progress+"%").attr("aria-valuenow",t.progress),t.done&&(_.pasture=t,l()&&d(_))}}(),i.onmessage=function(){var a=$("#progress-grassland");return function(r){e&&console.log(r.data);var t=r.data;a.css("width",t.progress+"%").attr("aria-valuenow",t.progress),t.done&&(_.grassland=t,l()&&d(_))}}();for(var E=0;E<q.length;E++)q[E].onmessage=function(a){var r=$("#progress-arable-"+a);return function(t){e&&console.log(t.data);var s=t.data;r.css("width",s.progress+"%").attr("aria-valuenow",s.progress),s.done&&(_.arable[a]=s,l()&&d(_))}}(E);dss.ui.progress.modal("show"),s.postMessage({weather:dss.weather,debug:e,verbose:a,grassland:{sites:U,monthStart:f.grassland["grazing-start"],monthEnd:f.grassland["grazing-end"],grazingSystem:m,timeAtPasture:y,herd:r,startYear:v},cropConfig:V}),i.postMessage({weather:dss.weather,debug:e,verbose:a,grassland:{sites:Y,cutThreshhold:f.grassland["cut-threshhold"],hayShare:f.grassland["hay-share"]/100,startYear:v},cropConfig:V});for(var E=0;E<q.length;E++)q[E].postMessage({weather:dss.weather,debug:e,verbose:a,grassland:{cutThreshhold:f.grassland["cut-threshhold"],hayShare:f.grassland["hay-share"]/100,startYear:v},cropConfig:arableConfigs[E]})},feedEvaluation:function(e){for(var a=0,r=e.length;r>a;a++){var t=e[a],s={};s.GE=dairy.feed.evaluation.de.GE(t.CP,t.EE,t.CF,t.OM),s.ME=dairy.feed.evaluation.de.ME(t.CP,t.EE,t.EED,t.CF,t.CFD,t.OM,t.OMD),s.E=dairy.feed.evaluation.de.E_f(s.ME,s.GE),s.P=dairy.feed.evaluation.de.uCP(s.ME,t.CP),s.RNB=dairy.feed.evaluation.de.RNB(t.CP,s.P);var i={};i.E="concentrate"===t.type?dairy.feed.evaluation.fi.E_c(t.CP,t.CPD,t.CF,t.CFD,t.EE,t.EED,t.NFE,t.NFED):dairy.feed.evaluation.fi.E_f(t.OMD,t.OM,t.type);var n={};n.E="concentrate"===t.type?dairy.feed.evaluation.gb.E_c(t.OM,t.OMD,!1):dairy.feed.evaluation.gb.E_f(t.OM,t.OMD,"fresh"===t.type||"hay"===t.type);var o={};"concentrate"===t.type?(o.E=dairy.feed.evaluation.fr.E_c(t.OMD,t.OM,t.CP,t.EE,t.CF,t.NDF,t.ash,t.delta_C1,1,1),o.QIL=null,o.FV=null):(o.E=dairy.feed.evaluation.fr.E_f(t.OMD,t.OM,t.CP,t.CF,t.type,t.DM/10,t.delta_FR1_QIL,null,!0,1,1),o.QIL=dairy.feed.evaluation.fr.QIL(t.OMD,t.CP,t.DM,t.type,t.delta_FR1_QIL,t.delta_S1_QIL,t.delta_H1_QIL,t.delta_S2_QIL,t.delta_H2_QIL),o.FV=dairy.intake.FV_f(o.QIL)),t.de=s,t.fi=i,t.gb=n,t.fr=o}return e},purchasedFeed:function(){function e(e){var a=dairy.feed.feeds.reduce(function(a,r){return r.id===e&&a.push(r),a},[])[0];return"object"==typeof a&&null!==a&&(a=JSON.parse(JSON.stringify(a))),a}function a(a){var r=null;a>=500?(r=e(60),r.id=a,r.name_de="Eigenes Futtermittel"):r=e(a),r.amount=0;for(var s=Object.keys(t),i=0,n=s.length;n>i;i++){var o=s[i];if(0===o.indexOf("feed-")){var l=parseInt(o.split("-")[1],10),d=o.split("-")[2],u=t[o];if(l===a)switch(d){case"name":r.name=u;break;case"dm":r.DM=u;break;case"om":r.OM=u,r.ash=1e3-r.OM;break;case"omd":r.OMD=u/100;break;case"cp":r.CP=u;break;case"cpd":r.CPD=u/100;break;case"ee":r.EE=u;break;case"eed":r.EED=u/100;break;case"cf":r.CF=u;break;case"cfd":r.CFD=u/100;break;case"nfe":r.NFE=u;break;case"nfed":r.NFED=u/100;break;case"amount":r.amount=u}}}return r}for(var r=dss.ui.model().model,t=r.feed,s=[],i=Object.keys(t),n=0,o=i.length;o>n;n++){var l=i[n];if(0===l.indexOf("feed-")){var d=-1;l.indexOf("amount")>0&&t[l]>0&&(d=parseInt(l.split("-")[1],10),s.push(a(d)))}}return dss.fn.feedEvaluation(s)},groupCowsForGrazingIntake:function(){var e=dss.ui.model().model,a=e.herd["calving-season"],r=e.feed["eval-system"],t=dss.herd.cows.reduce(function(e,a){return a.isDry?e[3].push(a):e[a.P-1].push(a),e},[[],[],[],[]]);if(0===a){t.reduce(function(e,a,t){return 3>t&&(e[t]=a.reduce(function(e,a){return e.push(a.req[r].total.E/a.req[r].main.E),e},[])),e},[]).reduce(function(e,a){return e.push(ss.jenks(a,3)),e},[])}},groupCowsForTMRfeeding:function(){for(var e=dss.ui.model().model,a=e.herd["no-groups"],r=e.feed["eval-system"],t=[],s=[],i=0,n=dss.herd.cows.length;n>i;i++){var o=dss.herd.cows[i];o.E_density=o.req[r].total.E/o.IC,o.P_density=o.req.de.total.P/o.IC,o.isDry?s.push(o):t.push(o)}if(a>1)dairy.group.get(t,{k:a,runs:15,normalize:!0,xAttribute:"E_density",yAttribute:"P_density"});else for(var l=0;l<t.length;l++)t[l].k=0;if(s.length>2)dairy.group.get(s,{k:2,runs:15,normalize:!0,xAttribute:"E_density",yAttribute:"P_density"});else for(var l=0;l<s.length;l++)s[l].k=0},getAverageTMRcows:function(){for(var e=dss.ui.model().model,a=e.herd["no-groups"],r=dss.herd.cows,t=[],s=[],i=0;a>i;i++)t.push(r.filter(function(e){return e.k===i&&!e.isDry}).reduce(function(e,a,r,t){var s=t.length;return e.no=s,e.IC+=a.IC/s,e.FV_c+=a.FV_c/s,e.parity+=a.P/s,e.req.fi.total.E+=a.req.fi.total.E/s,e.req.de.total.E+=a.req.de.total.E/s,e.req.de.total.P+=a.req.de.total.P/s,e.req.gb.total.E+=a.req.gb.total.E/s,e.req.fr.total.E+=a.req.fr.total.E/s,e.req.fi.main.E+=a.req.fi.main.E/s,e.req.de.main.E+=a.req.de.main.E/s,e.req.de.main.P+=a.req.de.main.P/s,e.req.gb.main.E+=a.req.gb.main.E/s,e.req.fr.main.E+=a.req.fr.main.E/s,e},{IC:0,FV_c:0,no:0,parity:0,req:{de:{total:{E:0,P:0},main:{E:0,P:0}},fi:{total:{E:0},main:{E:0}},gb:{total:{E:0},main:{E:0}},fr:{total:{E:0},main:{E:0}}}}));for(var i=0;2>i;i++)s.push(r.filter(function(e){return e.k===i&&e.isDry}).reduce(function(e,a,r,t){var s=t.length;return e.no=s,e.IC+=a.IC/s,e.FV_c+=a.FV_c/s,e.parity+=a.P/s,e.req.fi.total.E+=a.req.fi.total.E/s,e.req.de.total.E+=a.req.de.total.E/s,e.req.de.total.P+=a.req.de.total.P/s,e.req.gb.total.E+=a.req.gb.total.E/s,e.req.fr.total.E+=a.req.fr.total.E/s,e.req.fi.main.E+=a.req.fi.main.E/s,e.req.de.main.E+=a.req.de.main.E/s,e.req.de.main.P+=a.req.de.main.P/s,e.req.gb.main.E+=a.req.gb.main.E/s,e.req.fr.main.E+=a.req.fr.main.E/s,e},{IC:0,FV_c:0,no:0,parity:0,req:{de:{total:{E:0,P:0},main:{E:0,P:0}},fi:{total:{E:0},main:{E:0}},gb:{total:{E:0},main:{E:0}},fr:{total:{E:0},main:{E:0}}}}));return dss.herd.average={nonDry:t,dry:s},{nonDry:t,dry:s}},runLP:function(e,a,r,t){for(var s=[],i=[],n=!1,o=2,l=1,d=2,u=3,c=4,g=5,f=4,p=5,h=dss.ui.model().model,m=h.rotation.length,y="monthly"===h.simulation["time-step"]?30:14,v=parseInt(h.simulation["start-year"],10),b=Math.floor(365/y),_="Infinity"===h.feed["rnb-ub"]?1/0:parseFloat(h.feed["rnb-ub"]),F="-Infinity"===h.feed["rnb-lb"]?-1/0:parseFloat(h.feed["rnb-lb"]),E=h.feed["concentrate-share"]/100,C=parseFloat(h.feed["straw-max"]),P=h.feed["eval-system"],D=(e.dry.length,e.nonDry.length),w=[],O=0;m>O;O++)w.push(v+O);w.unshift(w.pop());for(var O=0;m>O;O++){var M=w[O],q=[];r.grassSilageFirstCutFromArable[M]&&q.push(r.grassSilageFirstCutFromArable[M]),r.grassSilageLateCutFromArable[M]&&q.push(r.grassSilageLateCutFromArable[M]),r.hayFromArable[M]&&q.push(r.hayFromArable[M]),r.grassSilageFirstCutFromGrassland[M]&&q.push(r.grassSilageFirstCutFromGrassland[M]),r.grassSilageLateCutFromGrassland[M]&&q.push(r.grassSilageLateCutFromGrassland[M]),r.hayFromGrassland[M]&&q.push(r.hayFromGrassland[M]),r.maize[M]&&q.push(r.maize[M]),q.push(r.straw),q=q.concat(r.purchasedFeed);var S={name:"diet",objective:{direction:o,name:"obj",vars:[]},subjectTo:[],bounds:[]},k=S.objective,N=S.subjectTo,x=(S.bounds,l);F===_?x=g:F===-1/0&&1/0===_?x=l:F===-1/0&&1/0>_?x=u:F>-1/0&&1/0===_?x=d:F!=-1/0&&1/0!=_&&(x=c);var I=[];if(r.purchasedFeed.forEach(function(e){I.push({name:"Amount_"+e.lp_name,vars:[],bnds:{type:0===e.amount?g:u,ub:e.amount*e.DM,lb:-1/0}})}),r.grassSilageFirstCutFromArable[M])var A={name:"grassSilageFirstCutFromArable_const",vars:[],bnds:{type:0===r.grassSilageFirstCutFromArable[M]["yield"]?g:u,ub:r.grassSilageFirstCutFromArable[M]["yield"],lb:-1/0}};if(r.grassSilageLateCutFromArable[M])var j={name:"grassSilageLateCutFromArable_const",vars:[],bnds:{type:0===r.grassSilageLateCutFromArable[M]["yield"]?g:u,ub:r.grassSilageLateCutFromArable[M]["yield"],lb:-1/0}};if(r.hayFromArable[M])var L={name:"hayFromArable_const",vars:[],bnds:{type:0===r.hayFromArable[M]["yield"]?g:u,ub:r.hayFromArable[M]["yield"],lb:-1/0}};if(r.grassSilageFirstCutFromGrassland[M])var z={name:"grassSilageFirstCutFromGrassland_const",vars:[],bnds:{type:0===r.grassSilageFirstCutFromGrassland[M]["yield"]?g:u,ub:r.grassSilageFirstCutFromGrassland[M]["yield"],lb:-1/0}};if(r.grassSilageLateCutFromGrassland[M])var G={name:"grassSilageLateCutFromGrassland_const",vars:[],bnds:{type:0===r.grassSilageLateCutFromGrassland[M]["yield"]?g:u,ub:r.grassSilageLateCutFromGrassland[M]["yield"],lb:-1/0}};if(r.hayFromGrassland[M])var B={name:"hayFromGrassland_const",vars:[],bnds:{type:0===r.hayFromGrassland[M]["yield"]?g:u,ub:r.hayFromGrassland[M]["yield"],lb:-1/0}};if(r.maize[M])var Q={name:"maize_const",vars:[],bnds:{type:0===r.maize[M]["yield"]?g:c,ub:r.maize[M]["yield"],lb:-1/0}};for(var W=0;b>W;W++)for(var R=0;D>R;R++){var T=e.nonDry[R],J=T.no;k.vars.push({name:"dE_"+W+"_"+R,coef:-10*J}),k.vars.push({name:"sE_"+W+"_"+R,coef:-10*J}),k.vars.push({name:"dP_"+W+"_"+R,coef:-1*J}),k.vars.push({name:"sP_"+W+"_"+R,coef:-1*J});var H={name:"E_"+W+"_"+R,vars:[{name:"dE_"+W+"_"+R,coef:1},{name:"sE_"+W+"_"+R,coef:-1}],bnds:{type:g,ub:1,lb:1}},V={name:"P_"+W+"_"+R,vars:[{name:"dP_"+W+"_"+R,coef:1},{name:"sP_"+W+"_"+R,coef:-1}],bnds:{type:g,ub:1,lb:1}},Y={name:"IC_"+W+"_"+R,vars:[],bnds:{type:g,ub:T.IC-a.DMI[W][R]*a.FV[W][R],lb:T.IC-a.DMI[W][R]*a.FV[W][R]}},U={name:"CC_"+W+"_"+R,vars:[],bnds:{type:u,ub:a.DMI[W][R],lb:-1/0}},X={name:"RNB_"+W+"_"+R,vars:[],bnds:{type:x,ub:_,lb:F}},K={name:"STRAW_"+W+"_"+R,vars:[],bnds:{type:c,ub:C,lb:0}};r.purchasedFeed.forEach(function(e,a){I[a].vars.push({name:"F_"+e.lp_name+"_"+W+"_"+R,coef:1*J*y})}),r.grassSilageFirstCutFromArable[M]&&A.vars.push({name:"F_"+r.grassSilageFirstCutFromArable[M].lp_name+"_"+W+"_"+R,coef:1*J*y}),r.grassSilageLateCutFromArable[M]&&j.vars.push({name:"F_"+r.grassSilageLateCutFromArable[M].lp_name+"_"+W+"_"+R,coef:1*J*y}),r.hayFromArable[M]&&L.vars.push({name:"F_"+r.hayFromArable[M].lp_name+"_"+W+"_"+R,coef:1*J*y}),r.grassSilageFirstCutFromGrassland[M]&&z.vars.push({name:"F_"+r.grassSilageFirstCutFromGrassland[M].lp_name+"_"+W+"_"+R,coef:1*J*y}),r.grassSilageLateCutFromGrassland[M]&&G.vars.push({name:"F_"+r.grassSilageLateCutFromGrassland[M].lp_name+"_"+W+"_"+R,coef:1*J*y}),r.hayFromGrassland[M]&&B.vars.push({name:"F_"+r.hayFromGrassland[M].lp_name+"_"+W+"_"+R,coef:1*J*y}),r.maize[M]&&Q.vars.push({name:"F_"+r.maize[M].lp_name+"_"+W+"_"+R,coef:1*J*y});for(var Z=0,ea=q.length;ea>Z;Z++){var aa=q[Z];if(void 0!==aa&&null!==aa){if(void 0===aa.lp_name)throw new Error;H.vars.push({name:"F_"+aa.lp_name+"_"+W+"_"+R,coef:aa[P].E/(T.req[P].total.E-a.DMI[W][R]*a.attr[W][P].E)}),V.vars.push({name:"F_"+aa.lp_name+"_"+W+"_"+R,coef:aa.de.P/(T.req.de.total.P-a.DMI[W][R]*a.attr[W].de.P)}),X.vars.push({name:"F_"+aa.lp_name+"_"+W+"_"+R,coef:aa.de.RNB}),"straw"===aa.type&&K.vars.push({name:"F_"+aa.lp_name+"_"+W+"_"+R,coef:1}),"concentrate"===aa.type?(Y.vars.push({name:"F_"+aa.lp_name+"_"+W+"_"+R,coef:T.FV_c}),U.vars.push({name:"F_"+aa.lp_name+"_"+W+"_"+R,coef:(1-E)/E})):(Y.vars.push({name:"F_"+aa.lp_name+"_"+W+"_"+R,coef:aa.fr.FV}),U.vars.push({name:"F_"+aa.lp_name+"_"+W+"_"+R,coef:-1}))}}N.push(H),N.push(V),0===a.DMI[W][R]&&N.push(X),N.push(Y),E>0&&N.push(U),N.push(K)}S.subjectTo=S.subjectTo.concat(I),r.grassSilageFirstCutFromArable[M]&&S.subjectTo.push(A),r.grassSilageLateCutFromArable[M]&&S.subjectTo.push(j),r.hayFromArable[M]&&S.subjectTo.push(L),r.grassSilageFirstCutFromGrassland[M]&&S.subjectTo.push(z),r.grassSilageLateCutFromGrassland[M]&&S.subjectTo.push(G),r.hayFromGrassland[M]&&S.subjectTo.push(B),r.maize[M]&&S.subjectTo.push(Q),i.push(S)}var ra=$("#progress-diets");dairy.diet.glpk.onmessage=function(e){var a=e.data;if("string"==typeof a)console.log(a);else{a.result.status!==p&&(n=!0,$(dss.ui.alert("Error.","Diet optimization in "+(v+s.length)+" failed.","danger")).prependTo($("body")).delay(6e3).fadeOut(500,function(){$(this).remove()}),dss.ui.failedLP(v+s.length)),s.push(a);var r=s.length/i.length*100;ra.css("width",r+"%").attr("aria-valuenow",r),s.length<i.length?dairy.diet.glpk.postMessage({lp:i[s.length],msg_lev:f}):t(s,b,n)}},dairy.diet.glpk.postMessage({lp:i[0],msg_lev:f})},runModel:function(){var e=dss.ui.model().model,a=function(a){dss.fn.cropGrowth(a,function(r){function t(e,a,r){var t={},s=.75,i=43,n=.61,o="hay"===a?85:35;if(t.GE=dairy.feed.evaluation.de.GE(e.CP,i,e.CF,e.OM),t.ME=dairy.feed.evaluation.de.ME(e.CP,i,n,e.CF,s,e.OM,e.OMD),t.E=dairy.feed.evaluation.de.E_f(t.ME,t.GE),t.P=dairy.feed.evaluation.de.uCP(t.ME,e.CP),t.RNB=dairy.feed.evaluation.de.RNB(e.CP,t.P),isNaN(t.E))throw new Error("isNaN(de.E)");var l={E:dairy.feed.evaluation.fi.E_f(e.OMD,e.OM)},d={E:dairy.feed.evaluation.gb.E_f(e.OM,e.OMD,!1)},u=0,c="grasssilage"===a?-1.4:0,g="grasssilage"===a?1.6:0,f="hay"===a?2.6:0,p="hay"===a?5.5:0,h=dairy.feed.evaluation.fr.QIL(e.OMD,e.CP,e.DM,a,u,c,f,g,p),m={E:dairy.feed.evaluation.fr.E_f(e.OMD,e.OM,e.CP,e.CF,a,o,0,null,!0,1,1),FV:dairy.intake.FV_f(h)};return{lp_name:r,"yield":e["yield"],OM:e.OM,OMD:e.OMD,CP:e.CP,CF:e.CF,de:t,fi:l,fr:m,gb:d}}function s(e){var a=dairy.feed.feeds.reduce(function(a,r){return r.id===e&&a.push(r),a},[])[0];return"object"==typeof a&&null!==a&&(a=JSON.parse(JSON.stringify(a))),a}l=r;for(var i=dss.model.rotation.length,u="monthly"===e.simulation["time-step"]?30:14,c=0,g=l.pasture,f=g.noCows,p=g.averageCows,h=l.arable,m=l.grassland,y=e.grassland["grassland-area"],v=e.crop["arable-area"],b=e.grassland["pasture-share"]/100,_=e.grassland["hay-share"]/100,F=parseInt(e.simulation["start-year"],10),E=365*i/u|0,C=parseInt(e.herd["no-groups"],10),P=dss.weather.date.slice(365*(F-1995),365*(F+i-1995)),D=["x"],w=0;E>w;w++)D.push(P[w*u+u/2]);if(g)for(var O=g.HI_g,M=g.FV,q=g.OMD_g,S=g.OM_g,k=g.CP_g,N=g.CF_g,x=[],I=[],A=[],j=[],L=[],z=[],G=[];c<O.length;){var B=O.slice(c,c+u),Q=M.slice(c,c+u),W=q.slice(c,c+u),R=S.slice(c,c+u),T=k.slice(c,c+u),J=N.slice(c,c+u),H=B.reduce(function(e,a){for(var r=0;C>r;r++)a[r]=a[r],void 0===e[r]&&(e[r]=0),void 0!=a[r]&&(e[r]+=a[r]/u),e[r]=parseFloat(e[r].toFixed(1));return e},[]);x.push(H);var V=Q.reduce(function(e,a){for(var r=0;C>r;r++)void 0===e[r]&&(e[r]=0),void 0!=a[r]&&(e[r]+=a[r]/u);return e},[]);I.push(V);var Y=W.reduce(function(e,a){return void 0!=a&&(e+=a/u),e},0);A.push(Y);var U=R.reduce(function(e,a){return void 0!=a&&(e+=a/u),e},0);j.push(U);var X=T.reduce(function(e,a){return void 0!=a&&(e+=a/u),e},0);L.push(X);
var K=J.reduce(function(e,a){return void 0!=a&&(e+=a/u),e},0);z.push(K);var Z={},ea=.75,aa=43,ra=.61,ta=35;if(Z.GE=dairy.feed.evaluation.de.GE(X,aa,K,U),Z.ME=dairy.feed.evaluation.de.ME(X,aa,ra,K,ea,U,Y),Z.E=dairy.feed.evaluation.de.E_f(Z.ME,Z.GE),Z.P=dairy.feed.evaluation.de.uCP(Z.ME,X),Z.RNB=dairy.feed.evaluation.de.RNB(X,Z.P),isNaN(Z.E))throw new Error("isNaN(de.E)");var sa={E:dairy.feed.evaluation.fi.E_f(Y,U)},ia={E:dairy.feed.evaluation.gb.E_f(U,Y,!1)},na={E:dairy.feed.evaluation.fr.E_f(Y,U,X,K,"grasssilage",ta,0,null,!0,1,1)};G.push({de:Z,fr:na,gb:ia,fi:sa}),c+=u}var oa={},la={},da={},ua=y*(1-b);Object.keys(m.grasslandDM).forEach(function(e){"object"==typeof m.grasslandDM[e]&&(oa[e]=JSON.parse(JSON.stringify(m.grasslandDM[e].firstCut)),oa[e]["yield"]*=ua,la[e]=JSON.parse(JSON.stringify(m.grasslandDM[e].lateCut)),la[e]["yield"]*=ua*(1-_),da[e]=JSON.parse(JSON.stringify(m.grasslandDM[e].lateCut)),da[e]["yield"]*=ua*_)});for(var ca={grassSilageFirstCutFromArable:{},grassSilageLateCutFromArable:{},hayFromArable:{},maize:{}},ga={},fa=[],pa=[],ha=[],w=0;w<h.length;w++){fa[w]={},pa[w]={},ha[w]={};var ma=v*n[w]/i;h[w].maizeDM.forEach(function(e){Object.keys(e).forEach(function(a){void 0===ca.maize[a]?(ca.maize[a]=e[a]*ma,ga[a]=e[a]*ma):(ca.maize[a]+=e[a]*ma,ga[a]+=e[a]*ma)})});var ya=h[w].grasslandDM.reduce(function(e,a){return Object.keys(a).forEach(function(r){"object"==typeof a[r]&&(void 0===e[r]?e[r]={first:a[r].firstCut.DMyield,late:a[r].lateCut.DMyield,count:a[r].firstCut.DMyield>0||a[r].lateCut.DMyield>0?1:0}:(e[r].first+=a[r].firstCut.DMyield,e[r].late+=a[r].lateCut.DMyield,(a[r].firstCut.DMyield>0||a[r].lateCut.DMyield>0)&&(e[r].count=e[r].count+1)))}),e},{});h[w].grasslandDM.forEach(function(e){Object.keys(e).forEach(function(a){if("object"==typeof e[a]){var r=e[a].firstCut.DMyield/ya[a].first;isNaN(r)&&(r=0);var t=e[a].lateCut.DMyield/ya[a].late;isNaN(t)&&(t=0),void 0===fa[w][a]?fa[w][a]={"yield":e[a].firstCut.DMyield*ma,OMD:e[a].firstCut.OMD*r,OM:e[a].firstCut.OM*r,CP:e[a].firstCut.CP*r,CF:e[a].firstCut.CF*r}:(fa[w][a]["yield"]+=e[a].firstCut.DMyield*ma,fa[w][a].OMD+=e[a].firstCut.OMD*r,fa[w][a].OM+=e[a].firstCut.OM*r,fa[w][a].CP+=e[a].firstCut.CP*r,fa[w][a].CF+=e[a].firstCut.CF*r),void 0===pa[w][a]?pa[w][a]={"yield":e[a].lateCut.DMyield*ma,OMD:e[a].lateCut.OMD*t,OM:e[a].lateCut.OM*t,CP:e[a].lateCut.CP*t,CF:e[a].lateCut.CF*t}:(pa[w][a]["yield"]+=e[a].lateCut.DMyield*ma,pa[w][a].OMD+=e[a].lateCut.OMD*t,pa[w][a].OM+=e[a].lateCut.OM*t,pa[w][a].CP+=e[a].lateCut.CP*t,pa[w][a].CF+=e[a].lateCut.CF*t),void 0===ca.grassSilageFirstCutFromArable[a]?ca.grassSilageFirstCutFromArable[a]=e[a].firstCut.DMyield*ma:ca.grassSilageFirstCutFromArable[a]+=e[a].firstCut.DMyield*ma,void 0===ca.hayFromArable[a]&&(ca.hayFromArable[a]=0),void 0===ca.grassSilageLateCutFromArable[a]&&(ca.grassSilageLateCutFromArable[a]=0)}})}),Object.keys(pa[w]).forEach(function(e){ha[w][e]=JSON.parse(JSON.stringify(pa[w][e])),ha[w][e]["yield"]*=_,pa[w][e]["yield"]*=1-_,ca.hayFromArable[e]+=ha[w][e]["yield"],ca.grassSilageLateCutFromArable[e]+=pa[w][e]["yield"]})}fa=fa.reduce(function(e,a){return Object.keys(a).forEach(function(r){var t=a[r]["yield"]/ca.grassSilageFirstCutFromArable[r];isNaN(t)&&(t=0),void 0===e[r]?e[r]={"yield":a[r]["yield"],OMD:a[r].OMD*t,OM:a[r].OM*t,CP:a[r].CP*t,CF:a[r].CF*t}:(e[r].OMD+=a[r].OMD*t,e[r].OM+=a[r].OM*t,e[r].CP+=a[r].CP*t,e[r].CF+=a[r].CF*t)}),e},{}),pa=pa.reduce(function(e,a){return Object.keys(a).forEach(function(r){var t=a[r]["yield"]/ca.grassSilageLateCutFromArable[r];if(1/0===t)throw new Error;isNaN(t)&&(t=0),void 0===e[r]?e[r]={"yield":a[r]["yield"],OMD:a[r].OMD*t,OM:a[r].OM*t,CP:a[r].CP*t,CF:a[r].CF*t}:(e[r].OMD+=a[r].OMD*t,e[r].OM+=a[r].OM*t,e[r].CP+=a[r].CP*t,e[r].CF+=a[r].CF*t)}),e},{}),ha=ha.reduce(function(e,a){return Object.keys(a).forEach(function(r){var t=a[r]["yield"]/ca.hayFromArable[r];isNaN(t)&&(t=0),void 0===e[r]?e[r]={"yield":a[r]["yield"],OMD:a[r].OMD*t,OM:a[r].OM*t,CP:a[r].CP*t,CF:a[r].CF*t}:(e[r].OMD+=a[r].OMD*t,e[r].OM+=a[r].OM*t,e[r].CP+=a[r].CP*t,e[r].CF+=a[r].CF*t)}),e},{}),Object.keys(fa).forEach(function(e){fa[e]=t(fa[e],"grasssilage","grasssilage-arable-1st")}),Object.keys(pa).forEach(function(e){pa[e]=t(pa[e],"grasssilage","grasssilage-arable-late")}),Object.keys(ha).forEach(function(e){ha[e]=t(ha[e],"hay","hay-arable")}),Object.keys(oa).forEach(function(e){oa[e]=t(oa[e],"grasssilage","grasssilage-1st")}),Object.keys(la).forEach(function(e){la[e]=t(la[e],"grasssilage","grasssilage-late")}),Object.keys(da).forEach(function(e){da[e]=t(da[e],"hay","hay")}),Object.keys(ga).forEach(function(e){ga[e]=t({"yield":ga[e],DM:270,OM:948,OMD:.72,CP:88,CF:212},"maizesilage","maizesilage")});var va,ba=e.feed["straw-type"];if(va=(ba="barley")?{id:50,lp_name:"straw",type:"straw",name:"Barley, straw",name_de:"Gerste, Stroh",delta_F1:0,delta_C1:0,delta_FR1_QIL:0,delta_S1_QIL:0,delta_S2_QIL:0,delta_H1_QIL:0,delta_H2_QIL:0,delta_FR1_QIB:0,delta_S1_QIB:0,delta_S2_QIB:0,delta_H1_QIB:0,delta_H2_QIB:0,eco:1,DM:860,ash:59,OM:941,OMD:.5,CP:39,CPD:.1,EE:16,EED:.41,CF:442,CFD:.55,NFE:444,NFED:.48,NDF:798,starch:0,sugar:7}:"oats"===ba?{id:51,lp_name:"straw",type:"straw",name:"Oats, straw",name_de:"Hafer, Stroh",delta_F1:0,delta_C1:0,delta_FR1_QIL:0,delta_S1_QIL:0,delta_S2_QIL:0,delta_H1_QIL:0,delta_H2_QIL:0,delta_FR1_QIB:0,delta_S1_QIB:0,delta_S2_QIB:0,delta_H1_QIB:0,delta_H2_QIB:0,eco:1,DM:860,ash:66,OM:934,OMD:.5,CP:35,CPD:.3,EE:15,EED:.34,CF:440,CFD:.58,NFE:444,NFED:.44,NDF:796,starch:0,sugar:14}:{id:52,lp_name:"straw",type:"straw",name:"Wheat, straw",name_de:"Weizen, Stroh",delta_F1:0,delta_C1:0,delta_FR1_QIL:0,delta_S1_QIL:0,delta_S2_QIL:0,delta_H1_QIL:0,delta_H2_QIL:0,delta_FR1_QIB:0,delta_S1_QIB:0,delta_S2_QIB:0,delta_H1_QIB:0,delta_H2_QIB:0,eco:1,DM:860,ash:78,OM:922,OMD:.47,CP:37,CPD:.27,EE:13,EED:.43,CF:429,CFD:.56,NFE:443,NFED:.42,NDF:798,starch:0,sugar:8},va=dss.fn.feedEvaluation([va])[0],h.length>0){for(var _a=[],Fa={},Ea={},Ca=[],w=0;w<h.length;w++){var Pa=h[w].yields.reduce(function(e,a){return a.forEach(function(a){void 0===e[a.year]&&(e[a.year]={}),void 0===e[a.year][a.crop]?e[a.year][a.crop]=1:e[a.year][a.crop]+=1,Ca.indexOf(a.crop)<0&&Ca.push(a.crop)}),e},{}),Da=h[w].yields.reduce(function(e,a){return a.forEach(function(a){void 0===e[a.year]&&(e[a.year]={}),void 0===e[a.year][a.crop]?e[a.year][a.crop]=a["yield"]/Pa[a.year][a.crop]:e[a.year][a.crop]+=a["yield"]/Pa[a.year][a.crop]}),e},{});Object.keys(Da).forEach(function(e){void 0===Ea[e]&&(Ea[e]={}),Object.keys(Da[e]).forEach(function(a){void 0===Ea[e][a]?Ea[e][a]=Da[e][a]*n[w]*dss.model.crop["arable-area"]:Ea[e][a]+=Da[e][a]*n[w]*dss.model.crop["arable-area"]})});var wa=h[w].grasslandDM.map(function(e){var a={};return Object.keys(e).forEach(function(r){var t=r.substring(0,4);void 0===a[t]?a[t]=e[r]:a[t]+=e[r]}),a}),Oa={};wa.forEach(function(e){Object.keys(e).forEach(function(e){void 0===Oa[e]?Oa[e]=1:Oa[e]+=1})});var Ma=wa.reduce(function(e,a){return Object.keys(a).forEach(function(r){void 0===e[r]?e[r]=a[r]/Oa[r]:e[r]+=a[r]/Oa[r]}),e},{});_a.push(Ma)}_a.reduce(function(e,a,r){return Object.keys(a).forEach(function(t){void 0===e[t]?e[t]=a[t]*n[r]*dss.model.crop["arable-area"]:e[t]+=a[t]*n[r]*dss.model.crop["arable-area"]}),e},Fa)}m&&Object.keys(m.grasslandDM).forEach(function(e){var a=parseInt(e.substring(0,4),10);a>F&&(void 0===Fa[a]?Fa[a]=m.grasslandDM[e]*y*(1-b):Fa[a]+=m.grasslandDM[e]*y*(1-b))});var qa=dss.fn.feedEvaluation(dss.fn.purchasedFeed());Ca.push("grasssilage");for(var Sa={},w=0;w<Ca.length;w++){var ka=0;switch(Ca[w]){case"wheat":ka=60;break;case"grasssilage":ka=22;break;case"maize-silage":ka=32;break;case"barley":ka=53;break;case"oats":ka=56;break;case"rye":ka=58}if(!(ka>0))throw new Error("Unknown feed");Sa[Ca[w]]=dss.fn.feedEvaluation([s(ka)])[0]}for(var Na=[],w=0;w<qa.length;w++)qa[w].lp_name=qa[w].name;var ka=2e3;Object.keys(Ea).sort(function(e,a){return e-a}).forEach(function(e){Object.keys(Ea[e]).forEach(function(a){if("maize-silage"===a){var r=(Ea[e][a],JSON.parse(JSON.stringify(Sa[a])));r.id=ka,r.source=e,r.startPeriod=356*(e-F+1)/u|0,r.endPeriod=r.startPeriod+12*d/u|0,r.endPeriod>E&&(r.startPeriod=0,r.endPeriod=r.startPeriod+12*d/u|0),ka--,Na.push(r)}})}),Object.keys(Fa).sort(function(e,a){return e-a}).forEach(function(e){var a=(Fa[e],JSON.parse(JSON.stringify(Sa.grasssilage)));a.id=ka,a.source=e,a.startPeriod=-1/0,a.endPeriod=1/0,ka--,Na.push(a)}),dss.fn.runLP(a,{FV:I,DMI:x,attr:G},{grassSilageFirstCutFromArable:fa,grassSilageLateCutFromArable:pa,hayFromArable:ha,grassSilageFirstCutFromGrassland:oa,grassSilageLateCutFromGrassland:la,hayFromGrassland:da,maize:ga,purchasedFeed:qa,straw:va},function(e,r,t){$("#result-water-select").empty().selectpicker("refresh");var s="";o.forEach(function(e,a){s+='<optgroup label="Rotation '+(a+1)+'">',e.forEach(function(e,r){s+='<option data-id=\'{"rotation":'+a+', "shift":'+r+"}'>"+e.map(function(e){return e.cropName}).join(" &gt; ")+"</option>"}),s+="</optgroup>"}),$("#result-water-select").append(s).selectpicker("refresh").on("change",function(){var e=$(this).find("option")[$(this).prop("selectedIndex")],a=$(e).data("id"),r=l.arable[a.rotation].paramsAvg[a.shift],t=["x"].concat(r.date),s=["water deficit"].concat(r.waterStress),i=["nitrogen deficit"].concat(r.nitrogenStress),n=["irrigation"].concat(r.irrigation),d=o[a.rotation][a.shift].map(function(e,a){return{axis:"x",start:e.seed,end:e.harvest,"class":a%2===0?"region-grey1":"region-grey2",opacity:.25}});dss.ui.charts.results.water.load({columns:[t,s,i,n]}),dss.ui.charts.results.water.regions.remove(),dss.ui.charts.results.water.regions.add(d)}).trigger("change"),$("#result-yield-select").empty().selectpicker("refresh");var s="";o.forEach(function(e,a){s+='<option data-id=\'{"rotation":'+a+"}'>"+e[0].map(function(e){return e.cropName}).join(" &gt; ")+"</option>"}),$("#result-yield-select").append(s).selectpicker("refresh").on("change",function(){var e=$(this).find("option")[$(this).prop("selectedIndex")],a=$(e).data("id"),r=(l.arable[a.rotation].params[a.shift],["x"]),t=[r],s=l.arable[a.rotation].params.reduce(function(e,a){var r=a["yield"].reduce(function(e,a){return void 0===e[a.cropName]?e[a.cropName]=1:e[a.cropName]+=1,e},{});return a["yield"].forEach(function(a,t){void 0===e[a.cropName]&&(e[a.cropName]=[]),void 0===e[a.cropName][t]&&(e[a.cropName][t]=0),e[a.cropName][t]+=Math.round(a.DM/r[a.cropName])}),e},{});Object.keys(s).forEach(function(e){t.push([e].concat(s[e]))});for(var n=0;i>n;n++)r.push(F+n);dss.ui.charts.results["yield"].data().forEach(function(e){e.values.forEach(function(e){e.value=0})}),dss.ui.charts.results["yield"].load({columns:t})}).trigger("change");var n=["intake"].concat(x.map(function(e){return e.reduce(function(e,a,r){return parseFloat((e+a*p[r].no/f).toFixed(1))},0)}));if(dss.ui.charts.results.intake.load({columns:[n,D]}),$("#diet-charts").empty(),!t){for(var d=0;C>d;d++)$("#diet-charts").append("<h4>Diets</h4>                    <p></p>                    <p>Group "+(d+1)+'</p>                    <p>Energy and protein deficit and surplus in % requirements</p>                    <p>                      <div id="diet-budget-chart-'+d+'" class="chart"></div>                    </p>                    <p>Diets</p>                    <p>                      <div id="diet-chart-'+d+'" class="chart"></div>                    </p>');for(var c=[],g=[],h=[],m=0;C>m;m++)c.push(["Energy"]),g.push(["Protein"]),h.push({});e.forEach(function(e){var a,t=e.result.vars,s=Object.keys(t);if(5===e.result.status){for(var i=0;r>i;i++)for(var n=0;C>n;n++){var o=t["sP_"+i+"_"+n],l=t["dP_"+i+"_"+n],d=t["sE_"+i+"_"+n],u=t["sE_"+i+"_"+n];g[n].push(Math.round(l?100*-l:100*o)),c[n].push(Math.round(u?100*-u:100*d))}var f=1,p=2,m=3;s.forEach(function(e){{var r=e.split("_");r[p]}"F"===r[0]&&(a=t[e],void 0===h[r[m]][r[f]]&&(h[r[m]][r[f]]=[]),h[r[m]][r[f]].push(parseFloat(a.toFixed(1))))})}}),dss.ui.charts.results.diet.forEach(function(e){e.destroy()}),dss.ui.charts.results.diet=[],dss.ui.charts.results.dietBudget.forEach(function(e){e.destroy()}),dss.ui.charts.results.dietBudget=[],h.forEach(function(a,t){var s=Object.keys(h[t]).map(function(e){return[e].concat(h[t][e])});x.length>0&&s.push(["grazing"].concat(x.slice(0,r*e.length).map(function(e){return e[t]}))),s.push(D);var i=c3.generate({bindto:"#diet-budget-chart-"+t,data:{x:"x",columns:[c[t],g[t],D],axes:{Energy:"y",Protein:"y2"},type:"line"},axis:{x:{type:"timeseries",tick:{format:"%Y/%m",values:["1995-06-01","1996-06-01","1997-06-01","1998-06-01","1999-06-01","2000-06-01","2001-06-01","2002-06-01","2003-06-01","2004-06-01","2005-06-01","2006-06-01","2007-06-01","2008-06-01","2009-06-01","2010-06-01","2011-06-01","2012-06-01","2013-06-01"]}},y:{show:!0,label:"[%]"},y2:{show:!0,label:"[%]"}},point:{show:!1}});dss.ui.charts.results.dietBudget.push(i);var n=c3.generate({bindto:"#diet-chart-"+t,data:{x:"x",columns:s,types:Object.keys(h[t]).concat(["grazing"]).reduce(function(e,a){return e[a]="area",e},{}),groups:[Object.keys(h[t]).concat(["grazing"])]},axis:{x:{type:"timeseries",tick:{format:"%Y/%m",values:["1995-06-01","1996-06-01","1997-06-01","1998-06-01","1999-06-01","2000-06-01","2001-06-01","2002-06-01","2003-06-01","2004-06-01","2005-06-01","2006-06-01","2007-06-01","2008-06-01","2009-06-01","2010-06-01","2011-06-01","2012-06-01","2013-06-01"]}},y:{show:!0,label:"[kg DM / cow]"}},point:{show:!1}});dss.ui.charts.results.diet.push(n)});for(var y=[],d=0;d<e.length;d++)y.push(F+d);y.unshift(y.pop());var v=h.reduce(function(t,s,i){var n=a.nonDry[i].no;return Object.keys(s).forEach(function(a){if(void 0===t[a]){t[a]=[];for(var i=0;i<e.length;i++)t[a][i]=0}for(var i=0;i<e.length;i++){for(var o=i*r;(i+1)*r>o;o++)t[a][i]-=s[a][o]*n*u/1e3;t[a][i]=parseFloat(t[a][i].toFixed(1))}}),t},{}),b=[];Object.keys(v).forEach(function(e){v[e].forEach(function(a,r){var t=y[r];fa[t]&&e===fa[t].lp_name&&(v[e][r]=parseFloat((a+fa[t]["yield"]/1e3).toFixed(1))),pa[t]&&e===pa[t].lp_name&&(v[e][r]=parseFloat((a+pa[t]["yield"]/1e3).toFixed(1))),ha[t]&&e===ha[t].lp_name&&(v[e][r]=parseFloat((a+ha[t]["yield"]/1e3).toFixed(1))),oa[t]&&e===oa[t].lp_name&&(v[e][r]=parseFloat((a+oa[t]["yield"]/1e3).toFixed(1))),la[t]&&e===la[t].lp_name&&(v[e][r]=parseFloat((a+la[t]["yield"]/1e3).toFixed(1))),da[t]&&e===da[t].lp_name&&(v[e][r]=parseFloat((a+da[t]["yield"]/1e3).toFixed(1))),ga[t]&&e===ga[t].lp_name&&(v[e][r]=parseFloat((a+ga[t]["yield"]/1e3).toFixed(1)))}),b.push([e].concat(v[e]))}),y.push(y.shift()),dss.ui.charts.results.feedSurplus.load({columns:b.concat([["x"].concat(y)])}),setTimeout(function(){dss.ui.progress.modal("hide")},1e3)}})})};dss.fn.fitWood(dss.ui.milkYieldData(),function(e){if(Array.isArray(e)){dss.fn.herdStructure(),dss.fn.cowProperties(),dss.fn.groupCowsForTMRfeeding();var r=dss.fn.getAverageTMRcows();if(dss.fn.modelChanged("location")||0===dss.weather.date.length){var t=parseFloat(Number($("#latitude").prop("value")).toFixed(3)),s=parseFloat(Number($("#longitude").prop("value")).toFixed(3));dss.fn.weather(t,s,function(e,t){null===e&&t?$(getAlert("Error.",t.text,"danger")).prependTo($("body")).delay(6e3).fadeOut(500,function(){$(this).remove()}):a(r)})}else a(r)}})}}});