$(function(){var e=!1,a=!1,r=new Worker("lib/zee/zee-worker.js"),t=new Worker("lib/lmfit-worker.js"),s=new Worker("js/pasture-worker.min.js"),n=new Worker("js/grassland-worker.min.js"),i=[],o=[],l=null,d=30.5,u={"sandy clay loam":{sand:60,clay:20,textureClass_DE:"Ls4"},"clay loam":{sand:30,clay:35,textureClass_DE:"Lt2"},loam:{sand:40,clay:20,textureClass_DE:"Ls2"},"sandy loam":{sand:65,clay:10,textureClass_DE:"Sl3"},"loamy sand":{sand:80,clay:5,textureClass_DE:"Sl2"},"silt loam":{sand:20,clay:10,textureClass_DE:"Ut2"},"silty clay loam":{sand:10,clay:30,textureClass_DE:"Lu"}},c=[];r.onmessage=function(e){if("function"!=typeof c[e.data.callbackID])throw new Error(c[e.data.callbackID]);c[e.data.callbackID](e.data.data),c[e.data.callbackID]=null},dss.parameter={wood:null},dss.herd={},dss.model={location:{},soil:{},herd:{},feed:{},crop:{},rotation:[],grassland:{},fertilizer:{},simulation:{}},dss.schema={location:{},soil:{},herd:{},feed:{},crop:{},grassland:{},fertilizer:{},simulation:{}},dss.weather={tmin:[],tmax:[],tavg:[],globrad:[],wind:[],sunhours:[],relhumid:[],precip:[],ppf:[],daylength:[],f_directrad:[],date:[],doy:[],exrad:[]},dss.feeds=null,dss.fn={updateModel:function(e,a){var r=dss.ui.model().model[e],t=dss.model[e];if(Array.isArray(a))for(var s=0,n=a.length;n>s;s++)t[a[s]]=r[a[s]];else dss.model[e]=r},modelChanged:function(e,a){var r=dss.ui.model().model[e],t=dss.model[e];if("rotation"===e){if("length"===a)return r.length!==t.length}else{var s=Object.keys(r);if(Array.isArray(a)){for(var n=0,i=a.length;i>n;n++)if(!t.hasOwnProperty(a[n])||r[a[n]]!==t[a[n]])return!0}else for(var n=0,i=s.length;i>n;n++)if(!t.hasOwnProperty(s[n])||r[s[n]]!==t[s[n]])return!0}return!1},updateWeather:function(){var e=parseFloat(Number($("#latitude").prop("value")).toFixed(3)),a=parseFloat(Number($("#longitude").prop("value")).toFixed(3));if(dss.fn.modelChanged("location")||dss.fn.modelChanged("rotation","length")||dss.fn.modelChanged("simulation",["start-year"])||!(dss.ui.charts.weather.data().length>0)){dss.fn.updateModel("location"),dss.fn.updateModel("simulation",["start-year"]),dss.fn.updateModel("rotation");{(new Spinner).spin($("#weather-charts")[0])}dss.fn.weather(e,a,function(e,a){if($("#weather-charts .spinner").remove(),null===e&&a)return void $(getAlert("Error.",a.text,"danger")).prependTo($("body")).delay(6e3).fadeOut(500,function(){$(this).remove()});var r=parseInt(dss.model.simulation["start-year"],10),t=365*(r-1995),s=dss.model.rotation.length,n={date:e.date.slice(t,t+365*s),precip:e.precip.slice(t,t+365*s),tavg:e.tavg.slice(t,t+365*s),daylength:e.daylength.slice(t,t+365*s),globrad:e.globrad.slice(t,t+365*s)},i=n.date.reduce(function(e,a){var r=a.substring(0,7);return r+"-01"!==e[e.length-1]&&e.push(r+"-01"),e},["x"]),o=n.precip.reduce(function(e,a,r){var t=n.date[r].substring(0,7);return t+"-01"!==i[e.length-1]?e.push(a):e[e.length-1]+=a,e},["precipitation"]),l=n.tavg.reduce(function(e,a,r){var t=n.date[r].substring(0,7);return 0===e.length||t!==e[e.length-1].month?e.push({month:t,value:a,count:1}):(e[e.length-1].value+=a,e[e.length-1].count+=1),e},[]).reduce(function(e,a){return e.push(a.value/a.count),e},["temperature"]),d=n.globrad.reduce(function(e,a,r){var t=n.date[r].substring(0,7);return 0===e.length||t!==e[e.length-1].month?e.push({month:t,value:a,count:1}):(e[e.length-1].value+=a,e[e.length-1].count+=1),e},[]).reduce(function(e,a){return e.push(a.value/a.count),e},["radiation"]),u=n.daylength.reduce(function(e,a,r){var t=n.date[r].substring(0,7);return 0===e.length||t!==e[e.length-1].month?e.push({month:t,value:a,count:1}):(e[e.length-1].value+=a,e[e.length-1].count+=1),e},[]).reduce(function(e,a){return e.push(a.value/a.count),e},["daylength"]);dss.ui.charts.weather.load({columns:[i,o,l,u,d]})})}},solar:weather.solar,rh:weather.rh,weather:function(e,a,t){function s(e,a,t){r.postMessage({filename:e,data:a,callbackID:c.length}),c.push(t)}for(var n=[.125,.375,.625,.875],i=0,o=0,l=Number("0."+e.toFixed(3).split(".")[1]),d=Number("0."+a.toFixed(3).split(".")[1]),u=0|e,g=0|a,f=0;f<n.length;f++)Math.abs(n[f]-l)<=.125&&(i=Number(u.toString()+"."+n[f].toString().split(".")[1])),Math.abs(n[f]-d)<=.125&&(o=Number(g.toString()+"."+n[f].toString().split(".")[1]));var f=0,p={rr:null,tn:null,tg:null,tx:null},h=["rr_"+i+"_"+o+".json.gz","tn_"+i+"_"+o+".json.gz","tg_"+i+"_"+o+".json.gz","tx_"+i+"_"+o+".json.gz"],m=["https://zalf-lse.github.io/rr/rr_"+i+"_"+o+".json.gz","https://zalf-lse.github.io/tn/tn_"+i+"_"+o+".json.gz","https://zalf-lse.github.io/tg/tg_"+i+"_"+o+".json.gz","https://zalf-lse.github.io/tx/tx_"+i+"_"+o+".json.gz"],y=new XMLHttpRequest;y.open("GET",m[f],!0),y.responseType="arraybuffer",y.onload=function(){200===y.status?(!function(r,t,n){s(h[t],new Uint8Array(y.response),function(s){for(var i="",o=0,l=s.byteLength;l>o;o++)i+=String.fromCharCode(s[o]);if(p[r]=JSON.parse(i),t===m.length-1){var d=dss.weather;Object.keys(d).forEach(function(e){d[e]=[]});for(var u=0;u<p.tx.values.length;u++)d.tmax.push(p.tx.values[u]*p.tx.scale),d.tmin.push(p.tn.values[u]*p.tn.scale),d.tavg.push(p.tg.values[u]*p.tg.scale),d.precip.push(p.rr.values[u]*p.rr.scale),d.tmax[u]<d.tmin[u]&&(d.tmax[u]=2*d.tavg[u]-d.tmin[u]),d.precip[u]<0&&(d.precip[u]=0);for(var c=dss.fn.solar(e,d.tmin,d.tmax,"1995-01-01"),u=0,g=c.PPF.length;g>u;u++)d.globrad[u]=c.R_s[u],d.f_directrad[u]=c.f_s[u],d.daylength[u]=c.N[u],d.sunhours[u]=c.N[u],d.relhumid[u]=dss.fn.rh(d.tmin[u],d.tmax[u]),d.date[u]=c.date[u],d.doy[u]=c.doy[u],d.exrad[u]=c.R_a[u],d.wind[u]=2;dss.model.location.latitude=e,dss.model.location.longitude=a,n&&n(d)}})}(h[f].split("_")[0],f,t),f++,f<m.length&&(y.open("GET",m[f],!0),y.send(null))):t(null,{text:"No weather data available for coordinates: latitude: "+e+" / longitude: "+a})},y.send(null)},fitWood:function(e,a){t.onmessage=function(e){Array.isArray(e.data)&&(dss.parameter.wood=e.data),a&&a(e.data)},t.postMessage({f:{},n:3,par:[17,.149,-.034],m:e.t.length,t:e.t,y:e.y})},wood:function(e,a){return a[0]*Math.pow(e,a[1])*Math.exp(a[2]*e)},herdStructure:function(e){var a=dss.ui.model().model,r=a.herd,t=r["calving-season"];dss.herd=dairy.herd.get({ageFirstCalving:r["age-first-calving"],femaleCalfRate:.47,stillBirthRate:.07,youngStockCullRate:r["young-stock-cull-rate"]/100,replacementRate:r["replacement-rate"]/100,calvingInterval:t>0?12:r["calving-interval"],herdSize:r["herd-size"],dryPeriode:r["dry-periode"]/(30.5/7)}),e&&e([["parity1",dss.herd.cowsPerLac[0]],["parity2",dss.herd.cowsPerLac[1]],["parity3",dss.herd.cowsPerLac[2]],["heifers_in",dss.herd.heifersBought],["heifers_out",dss.herd.heifersSold]])},herdDevelopment:function(){},cowProperties:function(){for(var e=dss.ui.model().model.herd,a=dss.ui.model().model.feed,r=dss.parameter.wood,t=e["is-dual-purpose"],s=e["mature-bodyweight"],n=e["age-first-calving"],i=e["weight-first-calving"],o=e["milk-fat"],l=e["milk-protein"],u=e["calving-interval"],c=e["dry-periode"],g=dairy.body.weightAtBirth(s),f=0===a["concentrate-share"]?1:.5,p=0,h=dss.herd.cows.length;h>p;p++){var m=dss.herd.cows[p];m.req={de:{},fi:{},gb:{},fr:{}},m.d_mx=dairy.milk.d_mx(r[1],r[2],m.P),m.BW=dairy.body.BW(m.DPP,m.d_mx,m.AGE_days,u,s,n,g,i,t),m.BWC=dairy.body.BWC(m.DPP,m.d_mx,m.AGE_days,u,s,n,g,i,t),m.BCS=dairy.body.BCS(m.DPP,u,7*c,m.P,m.d_mx),m.BW_c=dairy.body.BW_c(m.DPP,m.AGE_days,s,n,g,i),m.PLPOT=dairy.milk.milk(r[0],r[1],r[2],m.DPP/7,m.P,m.BW_c,s),m.milk=m.isDry?0:m.PLPOT;var y=dairy.milk.fat_a(o,m.P,m.d_mx/7),v=dairy.milk.protein_a(l,m.P,m.d_mx/7);m.fat=m.isDry?0:dairy.milk.fat(y,m.DIM/7,m.P,m.d_mx/7),m.protein=m.isDry?0:dairy.milk.protein(v,m.DIM/7,m.P,m.d_mx/7),m.milk305=dairy.milk.milk_305(r[0],r[1],r[2],m.P,m.BW_c,s),m.IC=dairy.intake.IC(m.BW,m.milk,m.BCS,m.DIM/7,m.DG/7,m.AGE_days/d,m.P),m.req.fi={main:dairy.requirements.fi.main(m.BW,m.IC,f,m.P),prod:m.isDry?{E:0,P:0}:dairy.requirements.fi.prod(m.milk,m.fat,m.protein,m.P),gest:dairy.requirements.fi.gest(m.DG/7,m.P),weit:dairy.requirements.fi.weit(m.BWC,m.P),total:{E:0,P:0}},m.req.fi.total.E=m.req.fi.main.E+m.req.fi.prod.E+m.req.fi.gest.E+m.req.fi.weit.E,m.req.fi.total.P=m.req.fi.main.P+m.req.fi.prod.P+m.req.fi.gest.P+m.req.fi.weit.P;var b=195;m.req.gb={main:dairy.requirements.gb.main(m.BW,m.IC,b,f,null,null,m.BWC,m.P),prod:m.isDry?{E:0,P:0}:dairy.requirements.gb.prod(m.milk,m.fat,m.protein,m.P),gest:dairy.requirements.gb.gest(m.DG/7,s,m.P),weit:dairy.requirements.gb.weit(m.BWC,m.P),total:{E:0,P:0}},m.req.gb.total.E=m.req.gb.main.E+m.req.gb.prod.E+m.req.gb.gest.E+m.req.gb.weit.E,m.req.gb.total.P=m.req.gb.main.P+m.req.gb.prod.P+m.req.gb.gest.P+m.req.gb.weit.P,m.req.gb.main=dairy.requirements.gb.main(m.BW,m.IC,m.req.gb.total.E,f,null,null,m.BWC,m.P),m.req.gb.total.E=m.req.gb.main.E+m.req.gb.prod.E+m.req.gb.gest.E+m.req.gb.weit.E,m.req.gb.total.P=m.req.gb.main.P+m.req.gb.prod.P+m.req.gb.gest.P+m.req.gb.weit.P,m.req.fr={main:dairy.requirements.fr.main(m.BW,m.IC,f,m.P),prod:m.isDry?{E:0,P:0}:dairy.requirements.fr.prod(m.milk,m.fat,m.protein,m.P),gest:dairy.requirements.fr.gest(m.DG/7,g,m.P),weit:dairy.requirements.fr.weit(m.BW,m.BWC,m.DPP/7,m.P),total:{E:0,P:0}},m.req.fr.total.E=m.req.fr.main.E+m.req.fr.prod.E+m.req.fr.gest.E+m.req.fr.weit.E,m.req.fr.total.P=m.req.fr.main.P+m.req.fr.prod.P+m.req.fr.gest.P+m.req.fr.weit.P,m.req.de={main:dairy.requirements.de.main(m.BW,m.IC,f,m.P),prod:m.isDry?{E:0,P:0}:dairy.requirements.de.prod(m.milk,m.fat,m.protein,m.P),gest:dairy.requirements.de.gest(m.DG/7,m.DIM,m.P),weit:dairy.requirements.de.weit(m.BWC,m.BW,m.P),total:{E:0,P:0}},m.req.de.total.E=m.req.de.main.E+m.req.de.prod.E+m.req.de.gest.E+m.req.de.weit.E,m.req.de.total.P=m.req.de.main.P+m.req.de.prod.P+m.req.de.gest.P+m.req.de.weit.P,m.FV_c=dairy.intake.FV_cs_diet(m.req.fr.total.E,m.IC,settings.CC,m.PLPOT,m.P,m.BWC)}},cropGrowth:function(r,t){function l(){for(var e=!0,a=0;a<_.arable.length;a++)void 0===_.arable[a]&&(e=!1);var r=_.arable.length===q.length;return r&&e&&null!==_.pasture&&null!==_.grassland}function d(){setTimeout(function(){t(_)},1e3)}function c(e,a){return f.rotation[e].filter(function(e){return e.id===a})}function g(e,a,r){if(!(e+1>f.rotation.length-1)){if(a.to.length>1)throw new Error(a);var t=JSON.parse(JSON.stringify(c(e+1>f.rotation.length-1?0:e+1,a.to[0]))),s=JSON.parse(JSON.stringify(t[0].to));t[0].to=[s[0]],r.area=r.area/s.length,r.push(t[0]);for(var n=1;n<s.length;n++){var i=JSON.parse(JSON.stringify(r));i.area=r.area,i[i.length-1].to=[s[n]];var o=F.push(i);g(e+1,i[i.length-1],F[o-1])}g(e+1,t[0],r)}}dss.fn.updateWeather();for(var f=dss.model=dss.ui.model().model,p=f.grassland["grassland-area"],h=f.grassland["pasture-share"],m="rotational",y=f.grassland["time-at-pasture"],v=(f.grassland["cut-threshhold"],f.herd["herd-size"],parseInt(f.simulation["start-year"],10)),b=dss.model.rotation.length,_=(dss.ui.rotation.splitted().length,{pasture:null,grassland:null,arable:[]}),F=[],E=0;E<f.rotation[0].length;E++)for(var C=f.rotation[0][E],P=JSON.parse(JSON.stringify(C.to)),D=0;D<P.length;D++){var O=JSON.parse(JSON.stringify(C));O.to=[P[D]];var w=[O];w.area=1/P.length,F.push(w),g(0,O,w)}F.forEach(function(e){i.push(e.area)});for(var M=[],q=[],S=[],E=0;E<F.length;E++){var k=[];S.push(k);for(var N=0;N<F[E].length;N++)k.push(F[E].slice(N,F[E].length).concat(F[E].slice(0,N)));q.push(new Worker("js/arable-worker.min.js"))}o=[];for(var E=0;E<S.length;E++){k=S[E],M.push([]),o.push([]);for(var N=0;N<k.length;N++){var w=k[N],x=[];M[E].push({crops:x}),o[E].push([]);for(var I=0;I<w.length;I++){var A=w[I].crop;if("grass-legume"!==A.name){var j=[];switch(A.name){case"wheat":default:j=[148,f.crop["wheat-emergence-to-double-ridge"],f.crop["wheat-double-ridge-to-flowering"],f.crop["wheat-flowering-to-begin-grain-filling"],f.crop["wheat-grain-filling"],25];break;case"barley":j=[108,f.crop["barley-emergence-to-double-ridge"],f.crop["barley-double-ridge-to-flowering"],f.crop["barley-flowering-to-begin-grain-filling"],f.crop["barley-grain-filling"],25];break;case"rye":j=[148,f.crop["rye-emergence-to-double-ridge"],f.crop["rye-double-ridge-to-flowering"],f.crop["rye-flowering-to-begin-grain-filling"],f.crop["rye-grain-filling"],25];break;case"oats":j=[100,f.crop["oats-emergence-to-double-ridge"],f.crop["oats-double-ridge-to-flowering"],f.crop["oats-flowering-to-begin-grain-filling"],f.crop["oats-grain-filling"],25];break;case"maize-silage":j=[68,f.crop["maize-emergence-to-shooting"],f.crop["maize-shooting-to-tasseling"],f.crop["maize-tasseling-to-flowering"],f.crop["maize-flowering-to-corn-filling"],f.crop["maize-corn-filling"],25]}x.push({model:"generic",species:[{name:A.name,dryMatterFraction:1}],options:{plantDryWeight:225,pc_StageTemperatureSum:j,autoIrrigationOn:"Yes"===A.parameter.irrigation.value[0]},sowingDate:["beet","soy","maize-silage"].indexOf(A.name)<0?v+I-1+"-10-16":v+I+"-05-15",finalHarvestDate:["beet","soy","maize-silage"].indexOf(A.name)<0?v+I+"-08-01":v+I+"-10-01",harvestDates:[],residuesRemoval:.85,tillageOperations:[],irrigations:[],organicFertilisers:[],mineralFertilisers:[{name:"...",date:["beet","soy","maize-silage"].indexOf(A.name)<0?v+I+"-04-01":v+I+"-05-15",method:"Fixed",amount:parseFloat(A.parameter["N-input"].value),no3:1}]}),o[E][N].push({cropName:A.name,seed:x[x.length-1].sowingDate,harvest:x[x.length-1].finalHarvestDate})}else if(0===I||w[I-1]&&w[I-1].crop.name!==A.name){for(var z=1,L=[{name:"...",date:v+I+"-04-01",method:"Fixed",amount:parseFloat(A.parameter["N-input"].value),no3:1}],D=I+1;D<w.length&&w[D].crop.name===A.name;D++)L.push({name:"...",date:v+D+"-04-01",method:"Fixed",amount:parseFloat(A.parameter["N-input"].value),no3:1}),z++;x.push({model:"grassland",species:[{name:"grass",dryMatterFraction:1-parseFloat(A.parameter["legume-share"].value)/100,constants:{part:{GDD_flower:f.crop["grass-flowering"],"ρ_shoot_ref":.75,"ρ_l_max":.7}}},{name:"clover",dryMatterFraction:parseFloat(A.parameter["legume-share"].value)/100}],sowingDate:v+I-1+"-10-17",plantDryWeight:0===I&&w[w.length-1].crop.name===A.name?2e3:225,finalHarvestDate:v+I-1+z+"-09-01",harvestDates:[],residuesRemoval:.85,autoIrrigationOn:"Yes"===A.parameter.irrigation.value[0],tillageOperations:[{date:v+I-1+z+"-09-02",method:"Plough",depth:30}],irrigations:[],organicFertilisers:[],mineralFertilisers:L}),o[E][N].push({cropName:A.name,seed:x[x.length-1].sowingDate,harvest:x[x.length-1].finalHarvestDate})}}}}for(var G=[{thickness:.2,Corg:.01,sand:u[f.soil["topsoil-texture"]].sand/100,clay:u[f.soil["topsoil-texture"]].clay/100,sceleton:0},{thickness:1.8,Corg:.01,sand:u[f.soil["subsoil-texture"]].sand/100,clay:u[f.soil["subsoil-texture"]].clay/100,sceleton:0}],B={latitude:f.location.latitude,slope:0,heightNN:1,horizons:G},Q={time:{startDate:v-1+"-01-01",endDate:dss.weather.date[365*(v-1-1995)+365*(b+1)]},switches:{useSecondaryYieldOn:!1,nitrogenResponseOn:!0,waterDeficitResponseOn:!0,emergenceMoistureControlOn:!1,emergenceFloodingControlOn:!1},init:{percentageFC:1,soilNitrate:.001,soilAmmonium:1e-4}},R={latitude:f.location.latitude,slope:0,heightNN:1,horizons:G},W={crops:[{model:"grassland",species:[{name:"grass",dryMatterFraction:1-parseFloat(f.grassland["grassland-legume-share"])/100,constants:{part:{GDD_flower:f.crop["grass-flowering"],"ρ_shoot_ref":.75,"ρ_l_max":.7}}},{name:"clover",dryMatterFraction:parseFloat(f.grassland["grassland-legume-share"])/100}],sowingDate:null,plantDryWeight:2e3,finalHarvestDate:null,tillageOperations:[],irrigations:[],organicFertilisers:[],mineralFertilisers:[]}]},E=0;b>E;E++)W.crops[0].mineralFertilisers.push({name:"...",date:v+E+"-04-01",method:"Fixed",amount:parseFloat(f.grassland["grassland-N-input"]),no3:1});arableConfigs=[];for(var T="",E=0;E<M.length;E++){var J={simulation:Q,siteAndProd:[]};arableConfigs.push(J);for(var N=0;N<M[E].length;N++)J.siteAndProd.push({site:B,production:M[E][N]});var H=M[E][0].crops.reduce(function(e,a){return e.push(a.species[0].name),e},[]).join(" - ");T+="<p>Arable ("+H+')<p>          <div class="progress">            <div id="progress-arable-'+E+'" class="progress-bar progress-bar-warning" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;">            </div>          </div>\n'}var V={simulation:{time:{startDate:v-1+"-01-01",endDate:dss.weather.date[365*(v-1-1995)+365*(b+1)]},switches:{useSecondaryYieldOn:!1,nitrogenResponseOn:!0,waterDeficitResponseOn:!0,emergenceMoistureControlOn:!1,emergenceFloodingControlOn:!1},init:{percentageFC:1,soilNitrate:.001,soilAmmonium:1e-4}},siteAndProd:[{site:R,production:W}]},Y=({simulation:{time:{startDate:v-1+"-01-01",endDate:dss.weather.date[365*(v-1-1995)+365*(b+1)]},switches:{useSecondaryYieldOn:!1,nitrogenResponseOn:!0,waterDeficitResponseOn:!0,emergenceMoistureControlOn:!1,emergenceFloodingControlOn:!1},init:{percentageFC:1,soilNitrate:.001,soilAmmonium:1e-4}},siteAndProd:[{site:R,production:W}]},[{ha:p*(1-h/100)}]),U=[{ha:p*(h/100)}];$("#progress-dlg .modal-body").empty().html(T+'<p>Grassland<p>          <div class="progress">            <div id="progress-grassland" class="progress-bar progress-bar-success" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;">            </div>          </div>          <p>Pasture<p>          <div class="progress">            <div id="progress-pasture" class="progress-bar progress-bar-success" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;">            </div>          </div>          <p>Diets<p>          <div class="progress">            <div id="progress-diets" class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;">            </div>          </div>'),s.onmessage=function(){var a=$("#progress-pasture");return function(r){e&&console.log(r.data);var t=r.data;a.css("width",t.progress+"%").attr("aria-valuenow",t.progress),t.done&&(_.pasture=t,l()&&d(_))}}(),n.onmessage=function(){var a=$("#progress-grassland");return function(r){e&&console.log(r.data);var t=r.data;a.css("width",t.progress+"%").attr("aria-valuenow",t.progress),t.done&&(_.grassland=t,l()&&d(_))}}();for(var E=0;E<q.length;E++)q[E].onmessage=function(a){var r=$("#progress-arable-"+a);return function(t){e&&console.log(t.data);var s=t.data;r.css("width",s.progress+"%").attr("aria-valuenow",s.progress),s.done&&(_.arable[a]=s,l()&&d(_))}}(E);dss.ui.progress.modal("show"),s.postMessage({weather:dss.weather,debug:e,verbose:a,grassland:{sites:U,monthStart:f.grassland["grazing-start"],monthEnd:f.grassland["grazing-end"],grazingSystem:m,timeAtPasture:y,herd:r,startYear:v},cropConfig:V}),n.postMessage({weather:dss.weather,debug:e,verbose:a,grassland:{sites:Y,cutThreshhold:f.grassland["cut-threshhold"],hayShare:f.grassland["hay-share"]/100,startYear:v},cropConfig:V});for(var E=0;E<q.length;E++)q[E].postMessage({weather:dss.weather,debug:e,verbose:a,grassland:{cutThreshhold:f.grassland["cut-threshhold"],hayShare:f.grassland["hay-share"]/100,startYear:v},cropConfig:arableConfigs[E]})},feedEvaluation:function(e){for(var a=0,r=e.length;r>a;a++){var t=e[a],s={};s.GE=dairy.feed.evaluation.de.GE(t.CP,t.EE,t.CF,t.OM),s.ME=dairy.feed.evaluation.de.ME(t.CP,t.EE,t.EED,t.CF,t.CFD,t.OM,t.OMD),s.E=dairy.feed.evaluation.de.E_f(s.ME,s.GE),s.P=dairy.feed.evaluation.de.uCP(s.ME,t.CP),s.RNB=dairy.feed.evaluation.de.RNB(t.CP,s.P);var n={};n.E="concentrate"===t.type?dairy.feed.evaluation.fi.E_c(t.CP,t.CPD,t.CF,t.CFD,t.EE,t.EED,t.NFE,t.NFED):dairy.feed.evaluation.fi.E_f(t.OMD,t.OM,t.type);var i={};i.E="concentrate"===t.type?dairy.feed.evaluation.gb.E_c(t.OM,t.OMD,!1):dairy.feed.evaluation.gb.E_f(t.OM,t.OMD,"fresh"===t.type||"hay"===t.type);var o={};"concentrate"===t.type?(o.E=dairy.feed.evaluation.fr.E_c(t.OMD,t.OM,t.CP,t.EE,t.CF,t.NDF,t.ash,t.delta_C1,1,1),o.QIL=null,o.FV=null):(o.E=dairy.feed.evaluation.fr.E_f(t.OMD,t.OM,t.CP,t.CF,t.type,t.DM/10,t.delta_FR1_QIL,null,!0,1,1),o.QIL=dairy.feed.evaluation.fr.QIL(t.OMD,t.CP,t.DM,t.type,t.delta_FR1_QIL,t.delta_S1_QIL,t.delta_H1_QIL,t.delta_S2_QIL,t.delta_H2_QIL),o.FV=dairy.intake.FV_f(o.QIL)),t.de=s,t.fi=n,t.gb=i,t.fr=o}return e},purchasedFeed:function(){function e(e){var a=dairy.feed.feeds.reduce(function(a,r){return r.id===e&&a.push(r),a},[])[0];return"object"==typeof a&&null!==a&&(a=JSON.parse(JSON.stringify(a))),a}function a(a){var r=null;a>=500?(r=e(60),r.id=a,r.name_de="Eigenes Futtermittel"):r=e(a),r.amount=0;for(var s=Object.keys(t),n=0,i=s.length;i>n;n++){var o=s[n];if(0===o.indexOf("feed-")){var l=parseInt(o.split("-")[1],10),d=o.split("-")[2],u=t[o];if(l===a)switch(d){case"name":r.name=u;break;case"dm":r.DM=u;break;case"om":r.OM=u,r.ash=1e3-r.OM;break;case"omd":r.OMD=u/100;break;case"cp":r.CP=u;break;case"cpd":r.CPD=u/100;break;case"ee":r.EE=u;break;case"eed":r.EED=u/100;break;case"cf":r.CF=u;break;case"cfd":r.CFD=u/100;break;case"nfe":r.NFE=u;break;case"nfed":r.NFED=u/100;break;case"amount":r.amount=u}}}return r}for(var r=dss.ui.model().model,t=r.feed,s=[],n=Object.keys(t),i=0,o=n.length;o>i;i++){var l=n[i];if(0===l.indexOf("feed-")){var d=-1;l.indexOf("amount")>0&&t[l]>0&&(d=parseInt(l.split("-")[1],10),s.push(a(d)))}}return dss.fn.feedEvaluation(s)},groupCowsForGrazingIntake:function(){var e=dss.ui.model().model,a=e.herd["calving-season"],r=e.feed["eval-system"],t=dss.herd.cows.reduce(function(e,a){return a.isDry?e[3].push(a):e[a.P-1].push(a),e},[[],[],[],[]]);if(0===a){t.reduce(function(e,a,t){return 3>t&&(e[t]=a.reduce(function(e,a){return e.push(a.req[r].total.E/a.req[r].main.E),e},[])),e},[]).reduce(function(e,a){return e.push(ss.jenks(a,3)),e},[])}},groupCowsForTMRfeeding:function(){for(var e=dss.ui.model().model,a=e.herd["no-groups"],r=e.feed["eval-system"],t=[],s=[],n=0,i=dss.herd.cows.length;i>n;n++){var o=dss.herd.cows[n];o.E_density=o.req[r].total.E/o.IC,o.P_density=o.req.de.total.P/o.IC,o.isDry?s.push(o):t.push(o)}if(a>1)dairy.group.get(t,{k:a,runs:15,normalize:!0,xAttribute:"E_density",yAttribute:"P_density"});else for(var l=0;l<t.length;l++)t[l].k=0;if(s.length>2)dairy.group.get(s,{k:2,runs:15,normalize:!0,xAttribute:"E_density",yAttribute:"P_density"});else for(var l=0;l<s.length;l++)s[l].k=0},getAverageTMRcows:function(){for(var e=dss.ui.model().model,a=e.herd["no-groups"],r=dss.herd.cows,t=[],s=[],n=0;a>n;n++)t.push(r.filter(function(e){return e.k===n&&!e.isDry}).reduce(function(e,a,r,t){var s=t.length;return e.no=s,e.IC+=a.IC/s,e.FV_c+=a.FV_c/s,e.parity+=a.P/s,e.req.fi.total.E+=a.req.fi.total.E/s,e.req.de.total.E+=a.req.de.total.E/s,e.req.de.total.P+=a.req.de.total.P/s,e.req.gb.total.E+=a.req.gb.total.E/s,e.req.fr.total.E+=a.req.fr.total.E/s,e.req.fi.main.E+=a.req.fi.main.E/s,e.req.de.main.E+=a.req.de.main.E/s,e.req.de.main.P+=a.req.de.main.P/s,e.req.gb.main.E+=a.req.gb.main.E/s,e.req.fr.main.E+=a.req.fr.main.E/s,e},{IC:0,FV_c:0,no:0,parity:0,req:{de:{total:{E:0,P:0},main:{E:0,P:0}},fi:{total:{E:0},main:{E:0}},gb:{total:{E:0},main:{E:0}},fr:{total:{E:0},main:{E:0}}}}));for(var n=0;2>n;n++)s.push(r.filter(function(e){return e.k===n&&e.isDry}).reduce(function(e,a,r,t){var s=t.length;return e.no=s,e.IC+=a.IC/s,e.FV_c+=a.FV_c/s,e.parity+=a.P/s,e.req.fi.total.E+=a.req.fi.total.E/s,e.req.de.total.E+=a.req.de.total.E/s,e.req.de.total.P+=a.req.de.total.P/s,e.req.gb.total.E+=a.req.gb.total.E/s,e.req.fr.total.E+=a.req.fr.total.E/s,e.req.fi.main.E+=a.req.fi.main.E/s,e.req.de.main.E+=a.req.de.main.E/s,e.req.de.main.P+=a.req.de.main.P/s,e.req.gb.main.E+=a.req.gb.main.E/s,e.req.fr.main.E+=a.req.fr.main.E/s,e},{IC:0,FV_c:0,no:0,parity:0,req:{de:{total:{E:0,P:0},main:{E:0,P:0}},fi:{total:{E:0},main:{E:0}},gb:{total:{E:0},main:{E:0}},fr:{total:{E:0},main:{E:0}}}}));return dss.herd.average={nonDry:t,dry:s},{nonDry:t,dry:s}},runLP:function(e,a,r,t){for(var s=[],n=[],i=!1,o=2,l=1,d=2,u=3,c=4,g=5,f=4,p=5,h=dss.ui.model().model,m=h.rotation.length,y="monthly"===h.simulation["time-step"]?30:14,v=parseInt(h.simulation["start-year"],10),b=Math.floor(365/y),_="Infinity"===h.feed["rnb-ub"]?1/0:parseFloat(h.feed["rnb-ub"]),F="-Infinity"===h.feed["rnb-lb"]?-1/0:parseFloat(h.feed["rnb-lb"]),E=h.feed["concentrate-share"]/100,C=parseFloat(h.feed["straw-max"]),P=h.feed["eval-system"],D=(e.dry.length,e.nonDry.length),O=[],w=0;m>w;w++)O.push(v+w);O.unshift(O.pop());for(var w=0;m>w;w++){var M=O[w],q=[];r.grassSilageFirstCutFromArable[M]&&q.push(r.grassSilageFirstCutFromArable[M]),r.grassSilageLateCutFromArable[M]&&q.push(r.grassSilageLateCutFromArable[M]),r.hayFromArable[M]&&q.push(r.hayFromArable[M]),r.grassSilageFirstCutFromGrassland[M]&&q.push(r.grassSilageFirstCutFromGrassland[M]),r.grassSilageLateCutFromGrassland[M]&&q.push(r.grassSilageLateCutFromGrassland[M]),r.hayFromGrassland[M]&&q.push(r.hayFromGrassland[M]),r.maize[M]&&q.push(r.maize[M]),q.push(r.straw),q=q.concat(r.purchasedFeed);var S={name:"diet",objective:{direction:o,name:"obj",vars:[]},subjectTo:[],bounds:[]},k=S.objective,N=S.subjectTo,x=(S.bounds,l);F===_?x=g:F===-1/0&&1/0===_?x=l:F===-1/0&&1/0>_?x=u:F>-1/0&&1/0===_?x=d:F!=-1/0&&1/0!=_&&(x=c);var I=[];if(r.purchasedFeed.forEach(function(e){I.push({name:"Amount_"+e.lp_name,vars:[],bnds:{type:0===e.amount?g:u,ub:e.amount*e.DM,lb:-1/0}})}),r.grassSilageFirstCutFromArable[M])var A={name:"grassSilageFirstCutFromArable_const",vars:[],bnds:{type:0===r.grassSilageFirstCutFromArable[M]["yield"]?g:u,ub:r.grassSilageFirstCutFromArable[M]["yield"],lb:-1/0}};if(r.grassSilageLateCutFromArable[M])var j={name:"grassSilageLateCutFromArable_const",vars:[],bnds:{type:0===r.grassSilageLateCutFromArable[M]["yield"]?g:u,ub:r.grassSilageLateCutFromArable[M]["yield"],lb:-1/0}};if(r.hayFromArable[M])var z={name:"hayFromArable_const",vars:[],bnds:{type:0===r.hayFromArable[M]["yield"]?g:u,ub:r.hayFromArable[M]["yield"],lb:-1/0}};if(r.grassSilageFirstCutFromGrassland[M])var L={name:"grassSilageFirstCutFromGrassland_const",vars:[],bnds:{type:0===r.grassSilageFirstCutFromGrassland[M]["yield"]?g:u,ub:r.grassSilageFirstCutFromGrassland[M]["yield"],lb:-1/0}};if(r.grassSilageLateCutFromGrassland[M])var G={name:"grassSilageLateCutFromGrassland_const",vars:[],bnds:{type:0===r.grassSilageLateCutFromGrassland[M]["yield"]?g:u,ub:r.grassSilageLateCutFromGrassland[M]["yield"],lb:-1/0}};if(r.hayFromGrassland[M])var B={name:"hayFromGrassland_const",vars:[],bnds:{type:0===r.hayFromGrassland[M]["yield"]?g:u,ub:r.hayFromGrassland[M]["yield"],lb:-1/0}};if(r.maize[M])var Q={name:"maize_const",vars:[],bnds:{type:0===r.maize[M]["yield"]?g:c,ub:r.maize[M]["yield"],lb:-1/0}};for(var R=[],W=0;b>W;W++)for(var T=0;D>T;T++){var J=e.nonDry[T],H=J.no;k.vars.push({name:"dE_"+W+"_"+T,coef:-10*H}),k.vars.push({name:"sE_"+W+"_"+T,coef:-10*H}),k.vars.push({name:"dP_"+W+"_"+T,coef:-1*H}),k.vars.push({name:"sP_"+W+"_"+T,coef:-1*H});var V={name:"E_"+W+"_"+T,vars:[{name:"dE_"+W+"_"+T,coef:1},{name:"sE_"+W+"_"+T,coef:-1}],bnds:{type:g,ub:1,lb:1}},Y={name:"P_"+W+"_"+T,vars:[{name:"dP_"+W+"_"+T,coef:1},{name:"sP_"+W+"_"+T,coef:-1}],bnds:{type:g,ub:1,lb:1}},U={name:"IC_"+W+"_"+T,vars:[],bnds:{type:g,ub:J.IC,lb:J.IC}},X={name:"CC_"+W+"_"+T,vars:[],bnds:{type:u,ub:0,lb:-1/0}},Z={name:"RNB_"+W+"_"+T,vars:[],bnds:{type:x,ub:_,lb:F}},K={name:"STRAW_"+W+"_"+T,vars:[],bnds:{type:c,ub:C,lb:0}};r.purchasedFeed.forEach(function(e,a){I[a].vars.push({name:"F_"+e.lp_name+"_"+W+"_"+T,coef:1*H*y})}),r.grassSilageFirstCutFromArable[M]&&A.vars.push({name:"F_"+r.grassSilageFirstCutFromArable[M].lp_name+"_"+W+"_"+T,coef:1*H*y}),r.grassSilageLateCutFromArable[M]&&j.vars.push({name:"F_"+r.grassSilageLateCutFromArable[M].lp_name+"_"+W+"_"+T,coef:1*H*y}),r.hayFromArable[M]&&z.vars.push({name:"F_"+r.hayFromArable[M].lp_name+"_"+W+"_"+T,coef:1*H*y}),r.grassSilageFirstCutFromGrassland[M]&&L.vars.push({name:"F_"+r.grassSilageFirstCutFromGrassland[M].lp_name+"_"+W+"_"+T,coef:1*H*y}),r.grassSilageLateCutFromGrassland[M]&&G.vars.push({name:"F_"+r.grassSilageLateCutFromGrassland[M].lp_name+"_"+W+"_"+T,coef:1*H*y}),r.hayFromGrassland[M]&&B.vars.push({name:"F_"+r.hayFromGrassland[M].lp_name+"_"+W+"_"+T,coef:1*H*y}),r.maize[M]&&Q.vars.push({name:"F_"+r.maize[M].lp_name+"_"+W+"_"+T,coef:1*H*y});for(var ea=0,aa=q.length;aa>ea;ea++){var ra=q[ea];if(void 0!==ra&&null!==ra){if(void 0===ra.lp_name)throw new Error;V.vars.push({name:"F_"+ra.lp_name+"_"+W+"_"+T,coef:ra[P].E/J.req[P].total.E}),Y.vars.push({name:"F_"+ra.lp_name+"_"+W+"_"+T,coef:ra.de.P/J.req.de.total.P}),Z.vars.push({name:"F_"+ra.lp_name+"_"+W+"_"+T,coef:ra.de.RNB}),"straw"===ra.type&&K.vars.push({name:"F_"+ra.lp_name+"_"+W+"_"+T,coef:1}),"concentrate"===ra.type?(U.vars.push({name:"F_"+ra.lp_name+"_"+W+"_"+T,coef:J.FV_c}),X.vars.push({name:"F_"+ra.lp_name+"_"+W+"_"+T,coef:(1-E)/E})):(U.vars.push({name:"F_"+ra.lp_name+"_"+W+"_"+T,coef:ra.fr.FV}),X.vars.push({name:"F_"+ra.lp_name+"_"+W+"_"+T,coef:-1}))}}R.push({name:"GRAZING_"+W+"_"+T,vars:[{name:"F_grazing_"+W+"_"+T,coef:1}],bnds:{type:g,ub:a.DMI[W][T],lb:a.DMI[W][T]}}),V.vars.push({name:"F_grazing_"+W+"_"+T,coef:a.attr[W][P].E/J.req[P].total.E}),Y.vars.push({name:"F_grazing_"+W+"_"+T,coef:a.attr[W].de.P/J.req.de.total.P}),U.vars.push({name:"F_grazing_"+W+"_"+T,coef:a.FV[W][T]}),X.vars.push({name:"F_grazing_"+W+"_"+T,coef:-1}),Z.vars.push({name:"F_grazing_"+W+"_"+T,coef:a.attr[W].de.RNB}),N.push(V),N.push(Y),0===a.DMI[W][T]&&N.push(Z),N.push(U),E>0&&N.push(X),N.push(K)}S.subjectTo=S.subjectTo.concat(I),S.subjectTo=S.subjectTo.concat(R),r.grassSilageFirstCutFromArable[M]&&S.subjectTo.push(A),r.grassSilageLateCutFromArable[M]&&S.subjectTo.push(j),r.hayFromArable[M]&&S.subjectTo.push(z),r.grassSilageFirstCutFromGrassland[M]&&S.subjectTo.push(L),r.grassSilageLateCutFromGrassland[M]&&S.subjectTo.push(G),r.hayFromGrassland[M]&&S.subjectTo.push(B),r.maize[M]&&S.subjectTo.push(Q),n.push(S)}var ta=$("#progress-diets");dairy.diet.glpk.onmessage=function(e){var a=e.data;if("string"==typeof a)console.log(a);else{a.result.status!==p&&(i=!0,$(dss.ui.alert("Error.","Diet optimization in "+(v+s.length)+" failed.","danger")).prependTo($("body")).delay(6e3).fadeOut(500,function(){$(this).remove()}),dss.ui.failedLP(v+s.length)),s.push(a);var r=s.length/n.length*100;ta.css("width",r+"%").attr("aria-valuenow",r),s.length<n.length?dairy.diet.glpk.postMessage({lp:n[s.length],msg_lev:f}):t(s,b,i)}},dairy.diet.glpk.postMessage({lp:n[0],msg_lev:f})},runModel:function(){var a=dss.ui.model().model,r=function(r){dss.fn.cropGrowth(r,function(t){function s(e,a,r){var t={},s=.75,n=43,i=.61,o="hay"===a?850:350;if(t.GE=dairy.feed.evaluation.de.GE(e.CP,n,e.CF,e.OM),t.ME=dairy.feed.evaluation.de.ME(e.CP,n,i,e.CF,s,e.OM,e.OMD),t.E=dairy.feed.evaluation.de.E_f(t.ME,t.GE),t.P=dairy.feed.evaluation.de.uCP(t.ME,e.CP),t.RNB=dairy.feed.evaluation.de.RNB(e.CP,t.P),isNaN(t.E))throw new Error("isNaN(de.E)");var l={E:dairy.feed.evaluation.fi.E_f(e.OMD,e.OM)},d={E:dairy.feed.evaluation.gb.E_f(e.OM,e.OMD,!1)},u=0,c="grasssilage"===a?-1.4:0,g="grasssilage"===a?1.6:0,f="hay"===a?2.6:0,p="hay"===a?5.5:0,h=dairy.feed.evaluation.fr.QIL(e.OMD,e.CP,o,a,u,c,f,g,p),m={E:dairy.feed.evaluation.fr.E_f(e.OMD,e.OM,e.CP,e.CF,a,o/10,0,null,!0,1,1),FV:dairy.intake.FV_f(h,2)};return{lp_name:r,"yield":e["yield"],OM:e.OM,OMD:e.OMD,CP:e.CP,CF:e.CF,de:t,fi:l,fr:m,gb:d}}function n(e){var a=dairy.feed.feeds.reduce(function(a,r){return r.id===e&&a.push(r),a},[])[0];return"object"==typeof a&&null!==a&&(a=JSON.parse(JSON.stringify(a))),a}l=t;for(var u=dss.model.rotation.length,c="monthly"===a.simulation["time-step"]?30:14,g=0,f=l.pasture,p=f.noCows,h=f.averageCows,m=l.arable,y=l.grassland,v=a.grassland["grassland-area"],b=a.crop["arable-area"],_=a.grassland["pasture-share"]/100,F=a.grassland["hay-share"]/100,E=parseInt(a.simulation["start-year"],10),C=365*u/c|0,P=parseInt(a.herd["no-groups"],10),D=dss.weather.date.slice(365*(E-1995),365*(E+u-1995)),O=["x"],w=0;C>w;w++)O.push(D[w*c+c/2]);if(f)for(var M=f.HI_g,q=f.FV,S=f.OMD_g,k=f.OM_g,N=f.CP_g,x=f.CF_g,I=[],A=[],j=[],z=[],L=[],G=[],B=[];g<M.length;){var Q=M.slice(g,g+c),R=q.slice(g,g+c),W=S.slice(g,g+c),T=k.slice(g,g+c),J=N.slice(g,g+c),H=x.slice(g,g+c),V=Q.reduce(function(e,a){for(var r=0;P>r;r++)a[r]=a[r],void 0===e[r]&&(e[r]=0),void 0!=a[r]&&(e[r]+=a[r]/c),e[r]=parseFloat(e[r].toFixed(1));
return e},[]);I.push(V);var Y=R.reduce(function(e,a){for(var r=0;P>r;r++)void 0===e[r]&&(e[r]=0),void 0!=a[r]&&(e[r]+=a[r]/c);return e},[]);A.push(Y);var U=W.reduce(function(e,a){return void 0!=a&&(e+=a/c),e},0);j.push(U);var X=T.reduce(function(e,a){return void 0!=a&&(e+=a/c),e},0);z.push(X);var Z=J.reduce(function(e,a){return void 0!=a&&(e+=a/c),e},0);L.push(Z);var K=H.reduce(function(e,a){return void 0!=a&&(e+=a/c),e},0);G.push(K);var ea={},aa=.75,ra=43,ta=.61,sa=35;if(ea.GE=dairy.feed.evaluation.de.GE(Z,ra,K,X),ea.ME=dairy.feed.evaluation.de.ME(Z,ra,ta,K,aa,X,U),ea.E=dairy.feed.evaluation.de.E_f(ea.ME,ea.GE),ea.P=dairy.feed.evaluation.de.uCP(ea.ME,Z),ea.RNB=dairy.feed.evaluation.de.RNB(Z,ea.P),isNaN(ea.E))throw new Error("isNaN(de.E)");var na={E:dairy.feed.evaluation.fi.E_f(U,X)},ia={E:dairy.feed.evaluation.gb.E_f(X,U,!1)},oa={E:dairy.feed.evaluation.fr.E_f(U,X,Z,K,"grasssilage",sa,0,null,!0,1,1)};B.push({de:ea,fr:oa,gb:ia,fi:na}),g+=c}var la={},da={},ua={},ca=v*(1-_);Object.keys(y.grasslandDM).forEach(function(e){"object"==typeof y.grasslandDM[e]&&(la[e]=JSON.parse(JSON.stringify(y.grasslandDM[e].firstCut)),la[e]["yield"]*=ca,da[e]=JSON.parse(JSON.stringify(y.grasslandDM[e].lateCut)),da[e]["yield"]*=ca*(1-F),ua[e]=JSON.parse(JSON.stringify(y.grasslandDM[e].lateCut)),ua[e]["yield"]*=ca*F)});for(var ga={grassSilageFirstCutFromArable:{},grassSilageLateCutFromArable:{},hayFromArable:{},maize:{}},fa={},pa=[],ha=[],ma=[],w=0;w<m.length;w++){pa[w]={},ha[w]={},ma[w]={};var ya=b*i[w]/u;m[w].maizeDM.forEach(function(e){Object.keys(e).forEach(function(a){void 0===ga.maize[a]?(ga.maize[a]=e[a]*ya,fa[a]=e[a]*ya):(ga.maize[a]+=e[a]*ya,fa[a]+=e[a]*ya)})});var va=m[w].grasslandDM.reduce(function(e,a){return Object.keys(a).forEach(function(r){"object"==typeof a[r]&&(void 0===e[r]?e[r]={first:a[r].firstCut.DMyield,late:a[r].lateCut.DMyield,count:a[r].firstCut.DMyield>0||a[r].lateCut.DMyield>0?1:0}:(e[r].first+=a[r].firstCut.DMyield,e[r].late+=a[r].lateCut.DMyield,(a[r].firstCut.DMyield>0||a[r].lateCut.DMyield>0)&&(e[r].count=e[r].count+1)))}),e},{});m[w].grasslandDM.forEach(function(e){Object.keys(e).forEach(function(a){if("object"==typeof e[a]){var r=e[a].firstCut.DMyield/va[a].first;isNaN(r)&&(r=0);var t=e[a].lateCut.DMyield/va[a].late;isNaN(t)&&(t=0),void 0===pa[w][a]?pa[w][a]={"yield":e[a].firstCut.DMyield*ya,OMD:e[a].firstCut.OMD*r,OM:e[a].firstCut.OM*r,CP:e[a].firstCut.CP*r,CF:e[a].firstCut.CF*r}:(pa[w][a]["yield"]+=e[a].firstCut.DMyield*ya,pa[w][a].OMD+=e[a].firstCut.OMD*r,pa[w][a].OM+=e[a].firstCut.OM*r,pa[w][a].CP+=e[a].firstCut.CP*r,pa[w][a].CF+=e[a].firstCut.CF*r),void 0===ha[w][a]?ha[w][a]={"yield":e[a].lateCut.DMyield*ya,OMD:e[a].lateCut.OMD*t,OM:e[a].lateCut.OM*t,CP:e[a].lateCut.CP*t,CF:e[a].lateCut.CF*t}:(ha[w][a]["yield"]+=e[a].lateCut.DMyield*ya,ha[w][a].OMD+=e[a].lateCut.OMD*t,ha[w][a].OM+=e[a].lateCut.OM*t,ha[w][a].CP+=e[a].lateCut.CP*t,ha[w][a].CF+=e[a].lateCut.CF*t),void 0===ga.grassSilageFirstCutFromArable[a]?ga.grassSilageFirstCutFromArable[a]=e[a].firstCut.DMyield*ya:ga.grassSilageFirstCutFromArable[a]+=e[a].firstCut.DMyield*ya,void 0===ga.hayFromArable[a]&&(ga.hayFromArable[a]=0),void 0===ga.grassSilageLateCutFromArable[a]&&(ga.grassSilageLateCutFromArable[a]=0)}})}),Object.keys(ha[w]).forEach(function(e){ma[w][e]=JSON.parse(JSON.stringify(ha[w][e])),ma[w][e]["yield"]*=F,ha[w][e]["yield"]*=1-F,ga.hayFromArable[e]+=ma[w][e]["yield"],ga.grassSilageLateCutFromArable[e]+=ha[w][e]["yield"]})}pa=pa.reduce(function(e,a){return Object.keys(a).forEach(function(r){var t=a[r]["yield"]/ga.grassSilageFirstCutFromArable[r];isNaN(t)&&(t=0),void 0===e[r]?e[r]={"yield":a[r]["yield"],OMD:a[r].OMD*t,OM:a[r].OM*t,CP:a[r].CP*t,CF:a[r].CF*t}:(e[r].OMD+=a[r].OMD*t,e[r].OM+=a[r].OM*t,e[r].CP+=a[r].CP*t,e[r].CF+=a[r].CF*t)}),e},{}),ha=ha.reduce(function(e,a){return Object.keys(a).forEach(function(r){var t=a[r]["yield"]/ga.grassSilageLateCutFromArable[r];if(1/0===t)throw new Error;isNaN(t)&&(t=0),void 0===e[r]?e[r]={"yield":a[r]["yield"],OMD:a[r].OMD*t,OM:a[r].OM*t,CP:a[r].CP*t,CF:a[r].CF*t}:(e[r].OMD+=a[r].OMD*t,e[r].OM+=a[r].OM*t,e[r].CP+=a[r].CP*t,e[r].CF+=a[r].CF*t)}),e},{}),ma=ma.reduce(function(e,a){return Object.keys(a).forEach(function(r){var t=a[r]["yield"]/ga.hayFromArable[r];isNaN(t)&&(t=0),void 0===e[r]?e[r]={"yield":a[r]["yield"],OMD:a[r].OMD*t,OM:a[r].OM*t,CP:a[r].CP*t,CF:a[r].CF*t}:(e[r].OMD+=a[r].OMD*t,e[r].OM+=a[r].OM*t,e[r].CP+=a[r].CP*t,e[r].CF+=a[r].CF*t)}),e},{}),Object.keys(pa).forEach(function(e){pa[e]=s(pa[e],"grasssilage","grasssilage-arable-1st")}),Object.keys(ha).forEach(function(e){ha[e]=s(ha[e],"grasssilage","grasssilage-arable-late")}),Object.keys(ma).forEach(function(e){ma[e]=s(ma[e],"hay","hay-arable")}),Object.keys(la).forEach(function(e){la[e]=s(la[e],"grasssilage","grasssilage-1st")}),Object.keys(da).forEach(function(e){da[e]=s(da[e],"grasssilage","grasssilage-late")}),Object.keys(ua).forEach(function(e){ua[e]=s(ua[e],"hay","hay")}),Object.keys(fa).forEach(function(e){fa[e]=s({"yield":fa[e],DM:270,OM:948,OMD:.72,CP:88,CF:212},"maizesilage","maizesilage")});var ba,_a=a.feed["straw-type"];if(ba=(_a="barley")?{id:50,lp_name:"straw",type:"straw",name:"Barley, straw",name_de:"Gerste, Stroh",delta_F1:0,delta_C1:0,delta_FR1_QIL:0,delta_S1_QIL:0,delta_S2_QIL:0,delta_H1_QIL:0,delta_H2_QIL:0,delta_FR1_QIB:0,delta_S1_QIB:0,delta_S2_QIB:0,delta_H1_QIB:0,delta_H2_QIB:0,eco:1,DM:860,ash:59,OM:941,OMD:.5,CP:39,CPD:.1,EE:16,EED:.41,CF:442,CFD:.55,NFE:444,NFED:.48,NDF:798,starch:0,sugar:7}:"oats"===_a?{id:51,lp_name:"straw",type:"straw",name:"Oats, straw",name_de:"Hafer, Stroh",delta_F1:0,delta_C1:0,delta_FR1_QIL:0,delta_S1_QIL:0,delta_S2_QIL:0,delta_H1_QIL:0,delta_H2_QIL:0,delta_FR1_QIB:0,delta_S1_QIB:0,delta_S2_QIB:0,delta_H1_QIB:0,delta_H2_QIB:0,eco:1,DM:860,ash:66,OM:934,OMD:.5,CP:35,CPD:.3,EE:15,EED:.34,CF:440,CFD:.58,NFE:444,NFED:.44,NDF:796,starch:0,sugar:14}:{id:52,lp_name:"straw",type:"straw",name:"Wheat, straw",name_de:"Weizen, Stroh",delta_F1:0,delta_C1:0,delta_FR1_QIL:0,delta_S1_QIL:0,delta_S2_QIL:0,delta_H1_QIL:0,delta_H2_QIL:0,delta_FR1_QIB:0,delta_S1_QIB:0,delta_S2_QIB:0,delta_H1_QIB:0,delta_H2_QIB:0,eco:1,DM:860,ash:78,OM:922,OMD:.47,CP:37,CPD:.27,EE:13,EED:.43,CF:429,CFD:.56,NFE:443,NFED:.42,NDF:798,starch:0,sugar:8},ba=dss.fn.feedEvaluation([ba])[0],ba.fr.FV<1&&(ba.fr.FV=1.5),m.length>0){for(var Fa=[],Ea={},Ca={},Pa=[],w=0;w<m.length;w++){var Da=m[w].yields.reduce(function(e,a){return a.forEach(function(a){void 0===e[a.year]&&(e[a.year]={}),void 0===e[a.year][a.crop]?e[a.year][a.crop]=1:e[a.year][a.crop]+=1,Pa.indexOf(a.crop)<0&&Pa.push(a.crop)}),e},{}),Oa=m[w].yields.reduce(function(e,a){return a.forEach(function(a){void 0===e[a.year]&&(e[a.year]={}),void 0===e[a.year][a.crop]?e[a.year][a.crop]=a["yield"]/Da[a.year][a.crop]:e[a.year][a.crop]+=a["yield"]/Da[a.year][a.crop]}),e},{});Object.keys(Oa).forEach(function(e){void 0===Ca[e]&&(Ca[e]={}),Object.keys(Oa[e]).forEach(function(a){void 0===Ca[e][a]?Ca[e][a]=Oa[e][a]*i[w]*dss.model.crop["arable-area"]:Ca[e][a]+=Oa[e][a]*i[w]*dss.model.crop["arable-area"]})});var wa=m[w].grasslandDM.map(function(e){var a={};return Object.keys(e).forEach(function(r){var t=r.substring(0,4);void 0===a[t]?a[t]=e[r]:a[t]+=e[r]}),a}),Ma={};wa.forEach(function(e){Object.keys(e).forEach(function(e){void 0===Ma[e]?Ma[e]=1:Ma[e]+=1})});var qa=wa.reduce(function(e,a){return Object.keys(a).forEach(function(r){void 0===e[r]?e[r]=a[r]/Ma[r]:e[r]+=a[r]/Ma[r]}),e},{});Fa.push(qa)}Fa.reduce(function(e,a,r){return Object.keys(a).forEach(function(t){void 0===e[t]?e[t]=a[t]*i[r]*dss.model.crop["arable-area"]:e[t]+=a[t]*i[r]*dss.model.crop["arable-area"]}),e},Ea)}y&&Object.keys(y.grasslandDM).forEach(function(e){var a=parseInt(e.substring(0,4),10);a>E&&(void 0===Ea[a]?Ea[a]=y.grasslandDM[e]*v*(1-_):Ea[a]+=y.grasslandDM[e]*v*(1-_))});var Sa=dss.fn.feedEvaluation(dss.fn.purchasedFeed());Pa.push("grasssilage");for(var ka={},w=0;w<Pa.length;w++){var Na=0;switch(Pa[w]){case"wheat":Na=60;break;case"grasssilage":Na=22;break;case"maize-silage":Na=32;break;case"barley":Na=53;break;case"oats":Na=56;break;case"rye":Na=58}if(!(Na>0))throw new Error("Unknown feed");ka[Pa[w]]=dss.fn.feedEvaluation([n(Na)])[0]}for(var xa=[],w=0;w<Sa.length;w++)Sa[w].lp_name=Sa[w].name;var Na=2e3;Object.keys(Ca).sort(function(e,a){return e-a}).forEach(function(e){Object.keys(Ca[e]).forEach(function(a){if("maize-silage"===a){var r=(Ca[e][a],JSON.parse(JSON.stringify(ka[a])));r.id=Na,r.source=e,r.startPeriod=356*(e-E+1)/c|0,r.endPeriod=r.startPeriod+12*d/c|0,r.endPeriod>C&&(r.startPeriod=0,r.endPeriod=r.startPeriod+12*d/c|0),Na--,xa.push(r)}})}),Object.keys(Ea).sort(function(e,a){return e-a}).forEach(function(e){var a=(Ea[e],JSON.parse(JSON.stringify(ka.grasssilage)));a.id=Na,a.source=e,a.startPeriod=-1/0,a.endPeriod=1/0,Na--,xa.push(a)}),dss.fn.runLP(r,{FV:A,DMI:I,attr:B},{grassSilageFirstCutFromArable:pa,grassSilageLateCutFromArable:ha,hayFromArable:ma,grassSilageFirstCutFromGrassland:la,grassSilageLateCutFromGrassland:da,hayFromGrassland:ua,maize:fa,purchasedFeed:Sa,straw:ba},function(a,t,s){$("#result-water-select").empty().selectpicker("refresh");var n="";o.forEach(function(e,a){n+='<optgroup label="Rotation '+(a+1)+'">',e.forEach(function(e,r){n+='<option data-id=\'{"rotation":'+a+', "shift":'+r+"}'>"+e.map(function(e){return e.cropName}).join(" &gt; ")+"</option>"}),n+="</optgroup>"}),$("#result-water-select").append(n).selectpicker("refresh").on("change",function(){var a=$(this).find("option")[$(this).prop("selectedIndex")],r=$(a).data("id"),t=l.arable[r.rotation].paramsAvg[r.shift],s=["x"].concat(t.date),n=["water deficit"].concat(t.waterStress),i=["nitrogen deficit"].concat(t.nitrogenStress),d=["irrigation"].concat(t.irrigation),u=[s,n,i,d];e&&u.push(["biomass"].concat(t.biomass));var c=o[r.rotation][r.shift].map(function(e,a){return{axis:"x",start:e.seed,end:e.harvest,"class":a%2===0?"region-grey1":"region-grey2",opacity:.25}});dss.ui.charts.results.water.load({columns:u}),dss.ui.charts.results.water.regions.remove(),dss.ui.charts.results.water.regions.add(c)}).trigger("change"),$("#result-yield-select").empty().selectpicker("refresh");var n="";o.forEach(function(e,a){n+='<option data-id=\'{"rotation":'+a+"}'>"+e[0].map(function(e){return e.cropName}).join(" &gt; ")+"</option>"}),$("#result-yield-select").append(n).selectpicker("refresh").on("change",function(){var e=$(this).find("option")[$(this).prop("selectedIndex")],a=$(e).data("id"),r=(l.arable[a.rotation].params[a.shift],["x"]),t=[r],s=l.arable[a.rotation].params.reduce(function(e,a){var r=a["yield"].reduce(function(e,a){return void 0===e[a.cropName]?e[a.cropName]=1:e[a.cropName]+=1,e},{});return a["yield"].forEach(function(a,t){void 0===e[a.cropName]&&(e[a.cropName]=[]),void 0===e[a.cropName][t]&&(e[a.cropName][t]=0),e[a.cropName][t]+=Math.round(a.DM/r[a.cropName])}),e},{});Object.keys(s).forEach(function(e){t.push([e].concat(s[e]))});for(var n=0;u>n;n++)r.push(E+n);dss.ui.charts.results["yield"].data().forEach(function(e){e.values.forEach(function(e){e.value=0})}),dss.ui.charts.results["yield"].load({columns:t})}).trigger("change");var i=["intake"].concat(I.map(function(e){return e.reduce(function(e,a,r){return parseFloat((e+a*h[r].no/p).toFixed(1))},0)})),d={columns:[i,O]};if(e){for(var g=[],f=0;P>f;f++)g.push(["FV"+f]);d.columns=d.columns.concat(A.reduce(function(e,a){return a.forEach(function(a,r){e[r].push(a)}),e},g)),d.columns.push(["CP"].concat(L)),d.columns.push(["OMD"].concat(j)),d.columns.push(["CF"].concat(G)),d.axes={FV:"y",OMD:"y",CP:"y2",CF:"y2"},dss.ui.charts.results.intake.axis({y2:{show:!0}})}if(dss.ui.charts.results.intake.load(d),$("#diet-charts").empty(),!s){for(var f=0;P>f;f++)$("#diet-charts").append("<h4>Diets</h4>                    <p></p>                    <p>Group "+(f+1)+'</p>                    <p>Energy and protein deficit and surplus in % requirements</p>                    <p>                      <div id="diet-budget-chart-'+f+'" class="chart"></div>                    </p>                    <p>Diets</p>                    <p>                      <div id="diet-chart-'+f+'" class="chart"></div>                    </p>');for(var m=[],y=[],v=[],b=0;P>b;b++)m.push(["Energy"]),y.push(["Protein"]),v.push({});a.forEach(function(e){var a,r=e.result.vars,s=Object.keys(r);if(5===e.result.status){for(var n=0;t>n;n++)for(var i=0;P>i;i++){var o=r["sP_"+n+"_"+i],l=r["dP_"+n+"_"+i],d=r["sE_"+n+"_"+i],u=r["sE_"+n+"_"+i];y[i].push(Math.round(l?100*-l:100*o)),m[i].push(Math.round(u?100*-u:100*d))}var c=1,g=2,f=3;s.forEach(function(e){{var t=e.split("_");t[g]}"F"===t[0]&&(a=r[e],void 0===v[t[f]][t[c]]&&(v[t[f]][t[c]]=[]),v[t[f]][t[c]].push(parseFloat(a.toFixed(1))))})}}),dss.ui.charts.results.diet.forEach(function(e){e.destroy()}),dss.ui.charts.results.diet=[],dss.ui.charts.results.dietBudget.forEach(function(e){e.destroy()}),dss.ui.charts.results.dietBudget=[],v.forEach(function(e,a){var r=Object.keys(v[a]).map(function(e){return[e].concat(v[a][e])});r.push(O);var t=c3.generate({bindto:"#diet-budget-chart-"+a,data:{x:"x",columns:[m[a],y[a],O],axes:{Energy:"y",Protein:"y2"},type:"line"},axis:{x:{type:"timeseries",tick:{format:"%Y/%m",values:["1995-06-01","1996-06-01","1997-06-01","1998-06-01","1999-06-01","2000-06-01","2001-06-01","2002-06-01","2003-06-01","2004-06-01","2005-06-01","2006-06-01","2007-06-01","2008-06-01","2009-06-01","2010-06-01","2011-06-01","2012-06-01","2013-06-01"]}},y:{show:!0,label:"[%]"},y2:{show:!0,label:"[%]"}},point:{show:!1}});dss.ui.charts.results.dietBudget.push(t);var s=c3.generate({bindto:"#diet-chart-"+a,data:{x:"x",columns:r,types:Object.keys(v[a]).concat(["grazing"]).reduce(function(e,a){return e[a]="area",e},{}),groups:[Object.keys(v[a]).concat(["grazing"])]},axis:{x:{type:"timeseries",tick:{format:"%Y/%m",values:["1995-06-01","1996-06-01","1997-06-01","1998-06-01","1999-06-01","2000-06-01","2001-06-01","2002-06-01","2003-06-01","2004-06-01","2005-06-01","2006-06-01","2007-06-01","2008-06-01","2009-06-01","2010-06-01","2011-06-01","2012-06-01","2013-06-01"]}},y:{show:!0,label:"[kg DM / cow]"}},point:{show:!1}});dss.ui.charts.results.diet.push(s)});for(var _=[],f=0;f<a.length;f++)_.push(E+f);_.unshift(_.pop());var F=v.reduce(function(e,s,n){var i=r.nonDry[n].no;return Object.keys(s).forEach(function(r){if("grazing"!==r){if(void 0===e[r]){e[r]=[];for(var n=0;n<a.length;n++)e[r][n]=0}for(var n=0;n<a.length;n++){for(var o=n*t;(n+1)*t>o;o++)e[r][n]-=s[r][o]*i*c/1e3;e[r][n]=parseFloat(e[r][n].toFixed(1))}}}),e},{}),C=[];Object.keys(F).forEach(function(e){F[e].forEach(function(a,r){var t=_[r];pa[t]&&e===pa[t].lp_name&&(F[e][r]=parseFloat((a+pa[t]["yield"]/1e3).toFixed(1))),ha[t]&&e===ha[t].lp_name&&(F[e][r]=parseFloat((a+ha[t]["yield"]/1e3).toFixed(1))),ma[t]&&e===ma[t].lp_name&&(F[e][r]=parseFloat((a+ma[t]["yield"]/1e3).toFixed(1))),la[t]&&e===la[t].lp_name&&(F[e][r]=parseFloat((a+la[t]["yield"]/1e3).toFixed(1))),da[t]&&e===da[t].lp_name&&(F[e][r]=parseFloat((a+da[t]["yield"]/1e3).toFixed(1))),ua[t]&&e===ua[t].lp_name&&(F[e][r]=parseFloat((a+ua[t]["yield"]/1e3).toFixed(1))),fa[t]&&e===fa[t].lp_name&&(F[e][r]=parseFloat((a+fa[t]["yield"]/1e3).toFixed(1)))}),C.push([e].concat(F[e]))}),_.push(_.shift()),dss.ui.charts.results.feedSurplus.load({columns:C.concat([["x"].concat(_)])}),setTimeout(function(){dss.ui.progress.modal("hide")},1e3)}})})};dss.fn.fitWood(dss.ui.milkYieldData(),function(e){if(Array.isArray(e)){dss.fn.herdStructure(),dss.fn.cowProperties(),dss.fn.groupCowsForTMRfeeding();var a=dss.fn.getAverageTMRcows();if(dss.fn.modelChanged("location")||0===dss.weather.date.length){var t=parseFloat(Number($("#latitude").prop("value")).toFixed(3)),s=parseFloat(Number($("#longitude").prop("value")).toFixed(3));dss.fn.weather(t,s,function(e,t){null===e&&t?$(getAlert("Error.",t.text,"danger")).prependTo($("body")).delay(6e3).fadeOut(500,function(){$(this).remove()}):r(a)})}else r(a)}})}}});