$(function(){var e=!1,a=!1,r=new Worker("lib/zee/zee-worker.js"),t=new Worker("lib/lmfit-worker.js"),s=new Worker("js/pasture-worker.min.js"),i=new Worker("js/grassland-worker.min.js"),n=[],o=[],l=null;s.onerror=function(e){dss.ui.onError(e.message,e.filename,e.lineno)},i.onerror=function(e){dss.ui.onError(e.message,e.filename,e.lineno)};var d=30.5,u={"loamy sand":{sand:80,clay:5,textureClass_DE:"Sl2"},"sandy loam 1":{sand:65,clay:10,textureClass_DE:"Sl3"},"sandy loam 2":{sand:70,clay:15,textureClass_DE:"Sl4"},"sandy loam 3":{sand:55,clay:5,textureClass_DE:"Su4"},"sandy clay loam 1":{sand:65,clay:20,textureClass_DE:"St3"},"sandy clay loam 2":{sand:60,clay:20,textureClass_DE:"Ls4"},"sandy clay loam 3":{sand:50,clay:20,textureClass_DE:"Ls3"},"silt loam 1":{sand:40,clay:5,textureClass_DE:"Us"},"silt loam 2":{sand:25,clay:15,textureClass_DE:"Uls"},"silt loam 3":{sand:10,clay:20,textureClass_DE:"Ut4"},"loam 1":{sand:35,clay:20,textureClass_DE:"Ls2"},"loam 2":{sand:50,clay:15,textureClass_DE:"Ls2"},"clay loam 1":{sand:45,clay:35,textureClass_DE:"Lts"},"clay loam 2":{sand:25,clay:40,textureClass_DE:"Lt2"},"silty clay loam":{sand:10,clay:35,textureClass_DE:"Lu"},"silty clay":{sand:5,clay:50,textureClass_DE:"Tu2"},silt:{sand:5,clay:5,textureClass_DE:"Uu"},"clay 1":{sand:40,clay:50,textureClass_DE:"Ts2"},"clay 2":{sand:20,clay:55,textureClass_DE:"Tl"},"clay 3":{sand:5,clay:60,textureClass_DE:"Tu2"}},c=[];r.onmessage=function(e){if("function"!=typeof c[e.data.callbackID])throw new Error(c[e.data.callbackID]);c[e.data.callbackID](e.data.data),c[e.data.callbackID]=null},dss.parameter={wood:null},dss.herd={},dss.model={location:{},soil:{},herd:{},feed:{},crop:{},rotation:[],grassland:{},fertilizer:{},simulation:{}},dss.schema={location:{},soil:{},herd:{},feed:{},crop:{},grassland:{},fertilizer:{},simulation:{}},dss.weather={tmin:[],tmax:[],tavg:[],globrad:[],wind:[],sunhours:[],relhumid:[],precip:[],ppf:[],daylength:[],f_directrad:[],date:[],doy:[],exrad:[]},dss.feeds=null,dss.fn={updateModel:function(e,a){var r=dss.ui.model().model[e],t=dss.model[e];if(Array.isArray(a))for(var s=0,i=a.length;i>s;s++)t[a[s]]=r[a[s]];else dss.model[e]=r},modelChanged:function(e,a){var r=dss.ui.model().model[e],t=dss.model[e];if("rotation"===e){if("length"===a)return r.length!==t.length}else{var s=Object.keys(r);if(Array.isArray(a)){for(var i=0,n=a.length;n>i;i++)if(!t.hasOwnProperty(a[i])||r[a[i]]!==t[a[i]])return!0}else for(var i=0,n=s.length;n>i;i++)if(!t.hasOwnProperty(s[i])||r[s[i]]!==t[s[i]])return!0}return!1},updateWeather:function(){var e=parseFloat(Number($("#latitude").prop("value")).toFixed(3)),a=parseFloat(Number($("#longitude").prop("value")).toFixed(3));if(dss.fn.modelChanged("location")||dss.fn.modelChanged("rotation","length")||dss.fn.modelChanged("simulation",["start-year"])||!(dss.ui.charts.weather.data().length>0)){dss.fn.updateModel("location"),dss.fn.updateModel("simulation",["start-year"]),dss.fn.updateModel("rotation");{(new Spinner).spin($("#weather-charts")[0])}dss.fn.weather(e,a,function(e,a){if($("#weather-charts .spinner").remove(),null===e&&a)return void $(getAlert("Error.",a.text,"danger")).prependTo($("body")).delay(6e3).fadeOut(500,function(){$(this).remove()});var r=parseInt(dss.model.simulation["start-year"],10),t=365*(r-1995),s=dss.model.rotation.length,i={date:e.date.slice(t,t+365*s),precip:e.precip.slice(t,t+365*s),tavg:e.tavg.slice(t,t+365*s),daylength:e.daylength.slice(t,t+365*s),globrad:e.globrad.slice(t,t+365*s)},n=i.date.reduce(function(e,a){var r=a.substring(0,7);return r+"-01"!==e[e.length-1]&&e.push(r+"-01"),e},["x"]),o=i.precip.reduce(function(e,a,r){var t=i.date[r].substring(0,7);return t+"-01"!==n[e.length-1]?e.push(a):e[e.length-1]+=a,e},["precipitation"]),l=i.tavg.reduce(function(e,a,r){var t=i.date[r].substring(0,7);return 0===e.length||t!==e[e.length-1].month?e.push({month:t,value:a,count:1}):(e[e.length-1].value+=a,e[e.length-1].count+=1),e},[]).reduce(function(e,a){return e.push(a.value/a.count),e},["temperature"]),d=i.globrad.reduce(function(e,a,r){var t=i.date[r].substring(0,7);return 0===e.length||t!==e[e.length-1].month?e.push({month:t,value:a,count:1}):(e[e.length-1].value+=a,e[e.length-1].count+=1),e},[]).reduce(function(e,a){return e.push(a.value/a.count),e},["radiation"]),u=i.daylength.reduce(function(e,a,r){var t=i.date[r].substring(0,7);return 0===e.length||t!==e[e.length-1].month?e.push({month:t,value:a,count:1}):(e[e.length-1].value+=a,e[e.length-1].count+=1),e},[]).reduce(function(e,a){return e.push(a.value/a.count),e},["daylength"]);dss.ui.charts.weather.load({columns:[n,o,l,u,d]})})}},solar:weather.solar,rh:weather.rh,weather:function(e,a,t){function s(e,a,t){r.postMessage({filename:e,data:a,callbackID:c.length}),c.push(t)}for(var i=[.125,.375,.625,.875],n=0,o=0,l=Number("0."+e.toFixed(3).split(".")[1]),d=Number("0."+a.toFixed(3).split(".")[1]),u=0|e,g=0|a,f=0;f<i.length;f++)Math.abs(i[f]-l)<=.125&&(n=Number(u.toString()+"."+i[f].toString().split(".")[1])),Math.abs(i[f]-d)<=.125&&(o=Number(g.toString()+"."+i[f].toString().split(".")[1]));var f=0,m={rr:null,tn:null,tg:null,tx:null},p=["rr_"+n+"_"+o+".json.gz","tn_"+n+"_"+o+".json.gz","tg_"+n+"_"+o+".json.gz","tx_"+n+"_"+o+".json.gz"],h=["https://zalf-lse.github.io/rr/rr_"+n+"_"+o+".json.gz","https://zalf-lse.github.io/tn/tn_"+n+"_"+o+".json.gz","https://zalf-lse.github.io/tg/tg_"+n+"_"+o+".json.gz","https://zalf-lse.github.io/tx/tx_"+n+"_"+o+".json.gz"],y=new XMLHttpRequest;y.open("GET",h[f],!0),y.responseType="arraybuffer",y.onload=function(){200===y.status?(!function(r,t,i){s(p[t],new Uint8Array(y.response),function(s){for(var n="",o=0,l=s.byteLength;l>o;o++)n+=String.fromCharCode(s[o]);if(m[r]=JSON.parse(n),t===h.length-1){var d=dss.weather;Object.keys(d).forEach(function(e){d[e]=[]});for(var u=0;u<m.tx.values.length;u++)d.tmax.push(m.tx.values[u]*m.tx.scale),d.tmin.push(m.tn.values[u]*m.tn.scale),d.tavg.push(m.tg.values[u]*m.tg.scale),d.precip.push(m.rr.values[u]*m.rr.scale),d.tmax[u]<d.tmin[u]&&(d.tmax[u]=2*d.tavg[u]-d.tmin[u]),d.precip[u]<0&&(d.precip[u]=0);for(var c=dss.fn.solar(e,d.tmin,d.tmax,"1995-01-01"),u=0,g=c.PPF.length;g>u;u++)d.globrad[u]=c.R_s[u],d.f_directrad[u]=c.f_s[u],d.daylength[u]=c.N[u],d.sunhours[u]=c.N[u],d.relhumid[u]=dss.fn.rh(d.tmin[u],d.tmax[u]),d.date[u]=c.date[u],d.doy[u]=c.doy[u],d.exrad[u]=c.R_a[u],d.wind[u]=2;dss.model.location.latitude=e,dss.model.location.longitude=a,i&&i(d)}})}(p[f].split("_")[0],f,t),f++,f<h.length&&(y.open("GET",h[f],!0),y.send(null))):t(null,{text:"No weather data available for coordinates: latitude: "+e+" / longitude: "+a})},y.send(null)},fitWood:function(e,a){t.onmessage=function(e){Array.isArray(e.data)&&(dss.parameter.wood=e.data),a&&a(e.data)},t.postMessage({f:{},n:3,par:[17,.149,-.034],m:e.t.length,t:e.t,y:e.y})},wood:function(e,a){return a[0]*Math.pow(e,a[1])*Math.exp(a[2]*e)},herdStructure:function(e){var a=dss.ui.model().model,r=a.herd,t=r["calving-season"];dss.herd=dairy.herd.get({ageFirstCalving:r["age-first-calving"],femaleCalfRate:.47,stillBirthRate:.07,youngStockCullRate:r["young-stock-cull-rate"]/100,replacementRate:r["replacement-rate"]/100,calvingInterval:t>0?12:r["calving-interval"],herdSize:r["herd-size"],dryPeriode:r["dry-periode"]/(30.5/7)}),e&&e([["parity1",dss.herd.cowsPerLac[0]],["parity2",dss.herd.cowsPerLac[1]],["parity3",dss.herd.cowsPerLac[2]],["heifers_in",dss.herd.heifersBought],["heifers_out",dss.herd.heifersSold]])},herdDevelopment:function(){},cowProperties:function(){for(var e=dss.ui.model().model.herd,a=dss.ui.model().model.feed,r=dss.parameter.wood,t=e["is-dual-purpose"],s=e["mature-bodyweight"],i=e["age-first-calving"],n=e["weight-first-calving"],o=e["milk-fat"],l=e["milk-protein"],u=e["calving-interval"],c=e["dry-periode"],g=dairy.body.weightAtBirth(s),f=0===a["concentrate-share"]?1:.5,m=0,p=dss.herd.cows.length;p>m;m++){var h=dss.herd.cows[m];h.req={de:{},fi:{},gb:{},fr:{}},h.d_mx=dairy.milk.d_mx(r[1],r[2],h.P),h.BW=dairy.body.BW(h.DPP,h.d_mx,h.AGE_days,u,s,i,g,n,t),h.BWC=dairy.body.BWC(h.DPP,h.d_mx,h.AGE_days,u,s,i,g,n,t),h.BCS=dairy.body.BCS(h.DPP,u,7*c,h.P,h.d_mx),h.BW_c=dairy.body.BW_c(h.DPP,h.AGE_days,s,i,g,n),h.PLPOT=dairy.milk.milk(r[0],r[1],r[2],h.DPP/7,h.P,h.BW_c,s),h.milk=h.isDry?0:h.PLPOT;var y=dairy.milk.fat_a(o,h.P,h.d_mx/7),v=dairy.milk.protein_a(l,h.P,h.d_mx/7);h.fat=h.isDry?0:dairy.milk.fat(y,h.DIM/7,h.P,h.d_mx/7),h.protein=h.isDry?0:dairy.milk.protein(v,h.DIM/7,h.P,h.d_mx/7),h.milk305=dairy.milk.milk_305(r[0],r[1],r[2],h.P,h.BW_c,s),h.IC=dairy.intake.IC(h.BW,h.milk,h.BCS,h.DIM/7,h.DG/7,h.AGE_days/d,h.P),h.req.fi={main:dairy.requirements.fi.main(h.BW,h.IC,f,h.P),prod:h.isDry?{E:0,P:0}:dairy.requirements.fi.prod(h.milk,h.fat,h.protein,h.P),gest:dairy.requirements.fi.gest(h.DG/7,h.P),weit:dairy.requirements.fi.weit(h.BWC,h.P),total:{E:0,P:0}},h.req.fi.total.E=h.req.fi.main.E+h.req.fi.prod.E+h.req.fi.gest.E+h.req.fi.weit.E,h.req.fi.total.P=h.req.fi.main.P+h.req.fi.prod.P+h.req.fi.gest.P+h.req.fi.weit.P;var b=195;h.req.gb={main:dairy.requirements.gb.main(h.BW,h.IC,b,f,null,null,h.BWC,h.P),prod:h.isDry?{E:0,P:0}:dairy.requirements.gb.prod(h.milk,h.fat,h.protein,h.P),gest:dairy.requirements.gb.gest(h.DG/7,s,h.P),weit:dairy.requirements.gb.weit(h.BWC,h.P),total:{E:0,P:0}},h.req.gb.total.E=h.req.gb.main.E+h.req.gb.prod.E+h.req.gb.gest.E+h.req.gb.weit.E,h.req.gb.total.P=h.req.gb.main.P+h.req.gb.prod.P+h.req.gb.gest.P+h.req.gb.weit.P,h.req.gb.main=dairy.requirements.gb.main(h.BW,h.IC,h.req.gb.total.E,f,null,null,h.BWC,h.P),h.req.gb.total.E=h.req.gb.main.E+h.req.gb.prod.E+h.req.gb.gest.E+h.req.gb.weit.E,h.req.gb.total.P=h.req.gb.main.P+h.req.gb.prod.P+h.req.gb.gest.P+h.req.gb.weit.P,h.req.fr={main:dairy.requirements.fr.main(h.BW,h.IC,f,h.P),prod:h.isDry?{E:0,P:0}:dairy.requirements.fr.prod(h.milk,h.fat,h.protein,h.P),gest:dairy.requirements.fr.gest(h.DG/7,g,h.P),weit:dairy.requirements.fr.weit(h.BW,h.BWC,h.DPP/7,h.P),total:{E:0,P:0}},h.req.fr.total.E=h.req.fr.main.E+h.req.fr.prod.E+h.req.fr.gest.E+h.req.fr.weit.E,h.req.fr.total.P=h.req.fr.main.P+h.req.fr.prod.P+h.req.fr.gest.P+h.req.fr.weit.P,h.req.de={main:dairy.requirements.de.main(h.BW,h.IC,f,h.P),prod:h.isDry?{E:0,P:0}:dairy.requirements.de.prod(h.milk,h.fat,h.protein,h.P),gest:dairy.requirements.de.gest(h.DG/7,h.DIM,h.P),weit:dairy.requirements.de.weit(h.BWC,h.BW,h.P),total:{E:0,P:0}},h.req.de.total.E=h.req.de.main.E+h.req.de.prod.E+h.req.de.gest.E+h.req.de.weit.E,h.req.de.total.P=h.req.de.main.P+h.req.de.prod.P+h.req.de.gest.P+h.req.de.weit.P,h.FV_c=dairy.intake.FV_cs_diet(h.req.fr.total.E,h.IC,settings.CC,h.PLPOT,h.P,h.BWC)}},cropGrowth:function(r,t){function l(){for(var e=!0,a=0;a<_.arable.length;a++)void 0===_.arable[a]&&(e=!1);var r=_.arable.length===q.length;return r&&e&&null!==_.pasture&&null!==_.grassland}function d(){setTimeout(function(){t(_)},1e3)}function c(e,a){return f.rotation[e].filter(function(e){return e.id===a})}function g(e,a,r){if(!(e+1>f.rotation.length-1)){if(a.to.length>1)throw new Error(a);var t=JSON.parse(JSON.stringify(c(e+1>f.rotation.length-1?0:e+1,a.to[0]))),s=JSON.parse(JSON.stringify(t[0].to));t[0].to=[s[0]],r.area=r.area/s.length,r.push(t[0]);for(var i=1;i<s.length;i++){var n=JSON.parse(JSON.stringify(r));n.area=r.area,n[n.length-1].to=[s[i]];var o=F.push(n);g(e+1,n[n.length-1],F[o-1])}g(e+1,t[0],r)}}dss.fn.updateWeather();for(var f=dss.model=dss.ui.model().model,m=f.grassland["grassland-area"],p=f.grassland["pasture-share"],h="rotational",y=f.grassland["time-at-pasture"],v=(f.grassland["cut-threshhold"],f.herd["herd-size"],parseInt(f.simulation["start-year"],10)),b=dss.model.rotation.length,_=(dss.ui.rotation.splitted().length,{pasture:null,grassland:null,arable:[]}),F=[],E=0;E<f.rotation[0].length;E++)for(var C=f.rotation[0][E],D=JSON.parse(JSON.stringify(C.to)),P=0;P<D.length;P++){var w=JSON.parse(JSON.stringify(C));w.to=[D[P]];var M=[w];M.area=1/D.length,F.push(M),g(0,w,M)}F.forEach(function(e){n.push(e.area)});for(var O=[],q=[],S=[],E=0;E<F.length;E++){var x=[];S.push(x);for(var k=0;k<F[E].length;k++)x.push(F[E].slice(k,F[E].length).concat(F[E].slice(0,k)));var N=new Worker("js/arable-worker.min.js");q.push(N),N.onerror=function(e){dss.ui.onError(e.message,e.filename,e.lineno)}}o=[];for(var E=0;E<S.length;E++){x=S[E],O.push([]),o.push([]);for(var k=0;k<x.length;k++){var M=x[k],I=[];O[E].push({crops:I}),o[E].push([]);for(var A=0;A<M.length;A++){var j=M[A].crop;if("grass-legume"!==j.name){var L=[];switch(j.name){case"wheat":default:L=[148,f.crop["wheat-emergence-to-double-ridge"],f.crop["wheat-double-ridge-to-flowering"],f.crop["wheat-flowering-to-begin-grain-filling"],f.crop["wheat-grain-filling"],25];break;case"barley":L=[108,f.crop["barley-emergence-to-double-ridge"],f.crop["barley-double-ridge-to-flowering"],f.crop["barley-flowering-to-begin-grain-filling"],f.crop["barley-grain-filling"],25];break;case"rye":L=[148,f.crop["rye-emergence-to-double-ridge"],f.crop["rye-double-ridge-to-flowering"],f.crop["rye-flowering-to-begin-grain-filling"],f.crop["rye-grain-filling"],25];break;case"oats":L=[100,f.crop["oats-emergence-to-double-ridge"],f.crop["oats-double-ridge-to-flowering"],f.crop["oats-flowering-to-begin-grain-filling"],f.crop["oats-grain-filling"],25];break;case"maize-silage":L=[68,f.crop["maize-emergence-to-shooting"],f.crop["maize-shooting-to-tasseling"],f.crop["maize-tasseling-to-flowering"],f.crop["maize-flowering-to-corn-filling"],f.crop["maize-corn-filling"],25]}I.push({model:"generic",species:[{name:j.name,dryMatterFraction:1}],options:{plantDryWeight:225,pc_StageTemperatureSum:L,autoIrrigationOn:"Yes"===j.parameter.irrigation.value[0]},sowingDate:["beet","soy","maize-silage"].indexOf(j.name)<0?v+A-1+"-10-16":v+A+"-05-15",finalHarvestDate:["beet","soy","maize-silage"].indexOf(j.name)<0?v+A+"-08-01":v+A+"-10-01",harvestDates:[],residuesRemoval:.85,tillageOperations:[],irrigations:[],organicFertilisers:[],mineralFertilisers:[{name:"...",date:["beet","soy","maize-silage"].indexOf(j.name)<0?v+A+"-04-01":v+A+"-05-15",method:"Fixed",amount:parseFloat(j.parameter["N-input"].value),no3:1}]}),o[E][k].push({cropName:j.name,seed:I[I.length-1].sowingDate,harvest:I[I.length-1].finalHarvestDate})}else if(0===A||M[A-1]&&M[A-1].crop.name!==j.name){for(var G=1,z=[{name:"...",date:v+A+"-04-01",method:"Fixed",amount:parseFloat(j.parameter["N-input"].value),no3:1}],P=A+1;P<M.length&&M[P].crop.name===j.name;P++)z.push({name:"...",date:v+P+"-04-01",method:"Fixed",amount:parseFloat(j.parameter["N-input"].value),no3:1}),G++;I.push({model:"grassland",species:[{name:"grass",dryMatterFraction:1-parseFloat(j.parameter["legume-share"].value)/100,constants:{part:{GDD_flower:f.crop["grass-flowering"],"ρ_shoot_ref":.75,"ρ_l_max":.7,"γ_stock":5e-4},d_r_h:.3,d_r_mx:.6}},{name:"red clover",dryMatterFraction:parseFloat(j.parameter["legume-share"].value)/100,constants:{d_r_h:.6,d_r_mx:1.3}}],sowingDate:v+A-1+"-10-02",plantDryWeight:0===A&&M[M.length-1].crop.name===j.name?2e3:800,finalHarvestDate:v+A-1+G+"-09-01",harvestDates:[],residuesRemoval:.85,autoIrrigationOn:"Yes"===j.parameter.irrigation.value[0],tillageOperations:[{date:v+A-1+G+"-09-02",method:"Plough",depth:30}],irrigations:[],organicFertilisers:[],mineralFertilisers:z}),o[E][k].push({cropName:j.name,seed:I[I.length-1].sowingDate,harvest:I[I.length-1].finalHarvestDate})}}}}for(var B=[{thickness:.2,Corg:.01,sand:u[f.soil["topsoil-texture"]].sand/100,clay:u[f.soil["topsoil-texture"]].clay/100,sceleton:0},{thickness:1.8,Corg:.01,sand:u[f.soil["subsoil-texture"]].sand/100,clay:u[f.soil["subsoil-texture"]].clay/100,sceleton:0}],Q=[{thickness:.2,Corg:.025,sand:u[f.soil["topsoil-texture"]].sand/100,clay:u[f.soil["topsoil-texture"]].clay/100,sceleton:0},{thickness:1.8,Corg:.025,sand:u[f.soil["subsoil-texture"]].sand/100,clay:u[f.soil["subsoil-texture"]].clay/100,sceleton:0}],T={latitude:f.location.latitude,slope:0,heightNN:1,horizons:B},W={time:{startDate:v-1+"-01-01",endDate:dss.weather.date[365*(v-1-1995)+365*(b+1)]},switches:{useSecondaryYieldOn:!1,nitrogenResponseOn:!0,waterDeficitResponseOn:!0,emergenceMoistureControlOn:!1,emergenceFloodingControlOn:!1},init:{percentageFC:1,soilNitrate:.001,soilAmmonium:1e-4}},R={latitude:f.location.latitude,slope:0,heightNN:1,horizons:Q},J={crops:[{model:"grassland",species:[{name:"grass",dryMatterFraction:1-parseFloat(f.grassland["grassland-legume-share"])/100,constants:{part:{GDD_flower:f.crop["grass-flowering"],"ρ_shoot_ref":.75,"ρ_l_max":.7,"γ_stock":5e-4}}},{name:"white clover",dryMatterFraction:parseFloat(f.grassland["grassland-legume-share"])/100}],sowingDate:null,plantDryWeight:2e3,finalHarvestDate:null,tillageOperations:[],irrigations:[],organicFertilisers:[],mineralFertilisers:[]}]},E=0;b>E;E++)J.crops[0].mineralFertilisers.push({name:"...",date:v+E+"-03-15",method:"Fixed",amount:parseFloat(f.grassland["grassland-N-input"])/2,no3:1}),J.crops[0].mineralFertilisers.push({name:"...",date:v+E+"-05-15",method:"Fixed",amount:parseFloat(f.grassland["grassland-N-input"])/2,no3:1});arableConfigs=[];for(var V="",E=0;E<O.length;E++){var H={simulation:W,siteAndProd:[]};arableConfigs.push(H);for(var k=0;k<O[E].length;k++)H.siteAndProd.push({site:T,production:O[E][k]});var Y=O[E][0].crops.reduce(function(e,a){return e.push(a.species[0].name),e},[]).join(" - ");V+="<p>Arable ("+Y+')<p>          <div class="progress">            <div id="progress-arable-'+E+'" class="progress-bar progress-bar-warning" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;">            </div>          </div>\n'}var U={simulation:{time:{startDate:v-2+"-01-01",endDate:dss.weather.date[365*(v-1-1995)+365*(b+1)]},switches:{useSecondaryYieldOn:!1,nitrogenResponseOn:!0,waterDeficitResponseOn:!0,emergenceMoistureControlOn:!1,emergenceFloodingControlOn:!1},init:{percentageFC:1,soilNitrate:.001,soilAmmonium:1e-4}},siteAndProd:[{site:R,production:J}]},X=JSON.parse(JSON.stringify(U)),Z=[{ha:m*(1-p/100)}],K=[{ha:m*(p/100)}];$("#progress-dlg .modal-body").empty().html(V+'<p>Grassland<p>          <div class="progress">            <div id="progress-grassland" class="progress-bar progress-bar-success" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;">            </div>          </div>          <p>Pasture<p>          <div class="progress">            <div id="progress-pasture" class="progress-bar progress-bar-success" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;">            </div>          </div>          <p>Diets<p>          <div class="progress">            <div id="progress-diets" class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;">            </div>          </div>'),s.onmessage=function(){var e=$("#progress-pasture");return function(a){var r=a.data;e.css("width",r.progress+"%").attr("aria-valuenow",r.progress),r.done&&(_.pasture=r,l()&&d(_))}}(),i.onmessage=function(){var e=$("#progress-grassland");return function(a){var r=a.data;e.css("width",r.progress+"%").attr("aria-valuenow",r.progress),r.done&&(_.grassland=r,l()&&d(_))}}();for(var E=0;E<q.length;E++)q[E].onmessage=function(a){var r=$("#progress-arable-"+a);return function(t){var s=t.data;e&&console.log(s),r.css("width",s.progress+"%").attr("aria-valuenow",s.progress),s.done&&(_.arable[a]=s,l()&&d(_))}}(E);dss.ui.progress.modal("show"),s.postMessage({weather:dss.weather,debug:e,verbose:a,grassland:{sites:K,monthStart:f.grassland["grazing-start"],monthEnd:f.grassland["grazing-end"],grazingSystem:h,timeAtPasture:y,herd:r,startYear:v},cropConfig:X}),i.postMessage({weather:dss.weather,debug:e,verbose:a,grassland:{sites:Z,cutThreshhold:f.grassland["cut-threshhold"],hayShare:f.grassland["hay-share"]/100,startYear:v},cropConfig:U});for(var E=0;E<q.length;E++)q[E].postMessage({weather:dss.weather,debug:e,verbose:a,grassland:{cutThreshhold:f.grassland["cut-threshhold"],hayShare:f.grassland["hay-share"]/100,startYear:v},cropConfig:arableConfigs[E]})},feedEvaluation:function(e){for(var a=0,r=e.length;r>a;a++){var t=e[a],s={};s.GE=dairy.feed.evaluation.de.GE(t.CP,t.EE,t.CF,t.OM),s.ME=dairy.feed.evaluation.de.ME(t.CP,t.EE,t.EED,t.CF,t.CFD,t.OM,t.OMD),s.E=dairy.feed.evaluation.de.E_f(s.ME,s.GE),s.P=dairy.feed.evaluation.de.uCP(s.ME,t.CP),s.RNB=dairy.feed.evaluation.de.RNB(t.CP,s.P);var i={};i.E="concentrate"===t.type?dairy.feed.evaluation.fi.E_c(t.CP,t.CPD,t.CF,t.CFD,t.EE,t.EED,t.NFE,t.NFED):dairy.feed.evaluation.fi.E_f(t.OMD,t.OM,t.type);var n={};n.E="concentrate"===t.type?dairy.feed.evaluation.gb.E_c(t.OM,t.OMD,!1):dairy.feed.evaluation.gb.E_f(t.OM,t.OMD,"fresh"===t.type||"hay"===t.type);var o={};"concentrate"===t.type?(o.E=dairy.feed.evaluation.fr.E_c(t.OMD,t.OM,t.CP,t.EE,t.CF,t.NDF,t.ash,t.delta_C1,1,1),o.QIL=null,o.FV=null):(o.E=dairy.feed.evaluation.fr.E_f(t.OMD,t.OM,t.CP,t.CF,t.type,t.DM/10,t.delta_FR1_QIL,null,!0,1,1),o.QIL=dairy.feed.evaluation.fr.QIL(t.OMD,t.CP,t.DM,t.type,t.delta_FR1_QIL,t.delta_S1_QIL,t.delta_H1_QIL,t.delta_S2_QIL,t.delta_H2_QIL),o.FV=dairy.intake.FV_f(o.QIL,1)),t.de=s,t.fi=i,t.gb=n,t.fr=o}return e},purchasedFeed:function(){function e(e){var a=dairy.feed.feeds.reduce(function(a,r){return r.id===e&&a.push(r),a},[])[0];return"object"==typeof a&&null!==a&&(a=JSON.parse(JSON.stringify(a))),a}function a(a){var r=null;a>=500?(r=e(60),r.id=a,r.name_de="Eigenes Futtermittel"):r=e(a),r.amount=0;for(var s=Object.keys(t),i=0,n=s.length;n>i;i++){var o=s[i];if(0===o.indexOf("feed-")){var l=parseInt(o.split("-")[1],10),d=o.split("-")[2],u=t[o];if(l===a)switch(d){case"name":r.name=u;break;case"dm":r.DM=u;break;case"om":r.OM=u,r.ash=1e3-r.OM;break;case"omd":r.OMD=u/100;break;case"cp":r.CP=u;break;case"cpd":r.CPD=u/100;break;case"ee":r.EE=u;break;case"eed":r.EED=u/100;break;case"cf":r.CF=u;break;case"cfd":r.CFD=u/100;break;case"nfe":r.NFE=u;break;case"nfed":r.NFED=u/100;break;case"amount":r.amount=u}}}return r}for(var r=dss.ui.model().model,t=r.feed,s=[],i=Object.keys(t),n=0,o=i.length;o>n;n++){var l=i[n];if(0===l.indexOf("feed-")){var d=-1;l.indexOf("amount")>0&&t[l]>0&&(d=parseInt(l.split("-")[1],10),s.push(a(d)))}}return dss.fn.feedEvaluation(s)},groupCowsForGrazingIntake:function(){var e=dss.ui.model().model,a=e.herd["calving-season"],r=e.feed["eval-system"],t=dss.herd.cows.reduce(function(e,a){return a.isDry?e[3].push(a):e[a.P-1].push(a),e},[[],[],[],[]]);if(0===a){t.reduce(function(e,a,t){return 3>t&&(e[t]=a.reduce(function(e,a){return e.push(a.req[r].total.E/a.req[r].main.E),e},[])),e},[]).reduce(function(e,a){return e.push(ss.jenks(a,3)),e},[])}},groupCowsForTMRfeeding:function(){for(var e=dss.ui.model().model,a=e.herd["no-groups"],r=e.feed["eval-system"],t=[],s=[],i=0,n=dss.herd.cows.length;n>i;i++){var o=dss.herd.cows[i];o.E_density=o.req[r].total.E/o.IC,o.P_density=o.req.de.total.P/o.IC,o.isDry?s.push(o):t.push(o)}if(a>1)dairy.group.get(t,{k:a,runs:15,normalize:!0,xAttribute:"E_density",yAttribute:"P_density"});else for(var l=0;l<t.length;l++)t[l].k=0;if(s.length>2)dairy.group.get(s,{k:2,runs:15,normalize:!0,xAttribute:"E_density",yAttribute:"P_density"});else for(var l=0;l<s.length;l++)s[l].k=0},getAverageTMRcows:function(){for(var e=dss.ui.model().model,a=e.herd["no-groups"],r=dss.herd.cows,t=[],s=[],i=0;a>i;i++)t.push(r.filter(function(e){return e.k===i&&!e.isDry}).reduce(function(e,a,r,t){var s=t.length;return e.no=s,e.IC+=a.IC/s,e.FV_c+=a.FV_c/s,e.parity+=a.P/s,e.req.fi.total.E+=a.req.fi.total.E/s,e.req.de.total.E+=a.req.de.total.E/s,e.req.de.total.P+=a.req.de.total.P/s,e.req.gb.total.E+=a.req.gb.total.E/s,e.req.fr.total.E+=a.req.fr.total.E/s,e.req.fi.main.E+=a.req.fi.main.E/s,e.req.de.main.E+=a.req.de.main.E/s,e.req.de.main.P+=a.req.de.main.P/s,e.req.gb.main.E+=a.req.gb.main.E/s,e.req.fr.main.E+=a.req.fr.main.E/s,e},{IC:0,FV_c:0,no:0,parity:0,req:{de:{total:{E:0,P:0},main:{E:0,P:0}},fi:{total:{E:0},main:{E:0}},gb:{total:{E:0},main:{E:0}},fr:{total:{E:0},main:{E:0}}}}));for(var i=0;2>i;i++)s.push(r.filter(function(e){return e.k===i&&e.isDry}).reduce(function(e,a,r,t){var s=t.length;return e.no=s,e.IC+=a.IC/s,e.FV_c+=a.FV_c/s,e.parity+=a.P/s,e.req.fi.total.E+=a.req.fi.total.E/s,e.req.de.total.E+=a.req.de.total.E/s,e.req.de.total.P+=a.req.de.total.P/s,e.req.gb.total.E+=a.req.gb.total.E/s,e.req.fr.total.E+=a.req.fr.total.E/s,e.req.fi.main.E+=a.req.fi.main.E/s,e.req.de.main.E+=a.req.de.main.E/s,e.req.de.main.P+=a.req.de.main.P/s,e.req.gb.main.E+=a.req.gb.main.E/s,e.req.fr.main.E+=a.req.fr.main.E/s,e},{IC:0,FV_c:0,no:0,parity:0,req:{de:{total:{E:0,P:0},main:{E:0,P:0}},fi:{total:{E:0},main:{E:0}},gb:{total:{E:0},main:{E:0}},fr:{total:{E:0},main:{E:0}}}}));return dss.herd.average={nonDry:t,dry:s},{nonDry:t,dry:s}},runLP:function(e,a,r,t){for(var s=[],i=[],n=!1,o=2,l=1,d=2,u=3,c=4,g=5,f=4,m=5,p=dss.ui.model().model,h=p.rotation.length,y="monthly"===p.simulation["time-step"]?30:14,v=parseInt(p.simulation["start-year"],10),b=Math.floor(365/y),_="Infinity"===p.feed["rnb-ub"]?1/0:parseFloat(p.feed["rnb-ub"]),F="-Infinity"===p.feed["rnb-lb"]?-1/0:parseFloat(p.feed["rnb-lb"]),E=parseFloat(p.feed["concentrate-share"])/100,C=parseFloat(p.feed["straw-max"]),D=p.feed["eval-system"],P=(e.dry.length,e.nonDry.length),w=[],M=0;h>M;M++)w.push(v+M);w.unshift(w.pop());for(var M=0;h>M;M++){var O=w[M],q=[];r.grassSilageFirstCutFromArable[O]&&r.grassSilageFirstCutFromArable[O]["yield"]>0&&q.push(r.grassSilageFirstCutFromArable[O]),r.grassSilageLateCutFromArable[O]&&r.grassSilageLateCutFromArable[O]["yield"]>0&&q.push(r.grassSilageLateCutFromArable[O]),r.hayFromArable[O]&&r.hayFromArable[O]["yield"]>0&&q.push(r.hayFromArable[O]),r.grassSilageFirstCutFromGrassland[O]&&r.grassSilageFirstCutFromGrassland[O]["yield"]>0&&q.push(r.grassSilageFirstCutFromGrassland[O]),r.grassSilageLateCutFromGrassland[O]&&r.grassSilageLateCutFromGrassland[O]["yield"]>0&&q.push(r.grassSilageLateCutFromGrassland[O]),r.hayFromGrassland[O]&&r.hayFromGrassland[O]["yield"]>0&&q.push(r.hayFromGrassland[O]),r.maize[O]&&r.maize[O]["yield"]>0&&q.push(r.maize[O]),q.push(r.straw),q=q.concat(r.purchasedFeed);var S={name:"diet",objective:{direction:o,name:"obj",vars:[]},subjectTo:[],bounds:[]},x=S.objective,k=S.subjectTo,N=(S.bounds,l);F===_?N=g:F===-1/0&&1/0===_?N=l:F===-1/0&&1/0>_?N=u:F>-1/0&&1/0===_?N=d:F!=-1/0&&1/0!=_&&(N=c);var I=[];if(r.purchasedFeed.forEach(function(e){I.push({name:"Amount_"+e.lp_name,vars:[],bnds:{type:0===e.amount?g:u,ub:e.amount*e.DM,lb:-1/0}})}),r.grassSilageFirstCutFromArable[O]&&r.grassSilageFirstCutFromArable[O]["yield"]>0)var A={name:"grassSilageFirstCutFromArable_const",vars:[],bnds:{type:0===r.grassSilageFirstCutFromArable[O]["yield"]?g:u,ub:r.grassSilageFirstCutFromArable[O]["yield"],lb:-1/0}};if(r.grassSilageLateCutFromArable[O]&&r.grassSilageLateCutFromArable[O]["yield"]>0)var j={name:"grassSilageLateCutFromArable_const",vars:[],bnds:{type:0===r.grassSilageLateCutFromArable[O]["yield"]?g:u,ub:r.grassSilageLateCutFromArable[O]["yield"],lb:-1/0}};if(r.hayFromArable[O]&&r.hayFromArable[O]["yield"]>0)var L={name:"hayFromArable_const",vars:[],bnds:{type:0===r.hayFromArable[O]["yield"]?g:u,ub:r.hayFromArable[O]["yield"],lb:-1/0}};if(r.grassSilageFirstCutFromGrassland[O]&&r.grassSilageFirstCutFromGrassland[O]["yield"]>0)var G={name:"grassSilageFirstCutFromGrassland_const",vars:[],bnds:{type:0===r.grassSilageFirstCutFromGrassland[O]["yield"]?g:u,ub:r.grassSilageFirstCutFromGrassland[O]["yield"],lb:-1/0}};if(r.grassSilageLateCutFromGrassland[O]&&r.grassSilageLateCutFromGrassland[O]["yield"]>0)var z={name:"grassSilageLateCutFromGrassland_const",vars:[],bnds:{type:0===r.grassSilageLateCutFromGrassland[O]["yield"]?g:u,ub:r.grassSilageLateCutFromGrassland[O]["yield"],lb:-1/0}};if(r.hayFromGrassland[O]&&r.hayFromGrassland[O]["yield"]>0)var B={name:"hayFromGrassland_const",vars:[],bnds:{type:0===r.hayFromGrassland[O]["yield"]?g:u,ub:r.hayFromGrassland[O]["yield"],lb:-1/0}};if(r.maize[O]&&r.maize[O]["yield"]>0)var Q={name:"maize_const",vars:[],bnds:{type:0===r.maize[O]["yield"]?g:c,ub:r.maize[O]["yield"],lb:-1/0}};for(var T=[],W=0;b>W;W++)for(var R=0;P>R;R++){var J=e.nonDry[R],V=J.no;x.vars.push({name:"dE_"+W+"_"+R,coef:-10*V}),x.vars.push({name:"sE_"+W+"_"+R,coef:-10*V}),x.vars.push({name:"dP_"+W+"_"+R,coef:-1*V}),x.vars.push({name:"sP_"+W+"_"+R,coef:-1*V});var H={name:"E_"+W+"_"+R,vars:[{name:"dE_"+W+"_"+R,coef:1},{name:"sE_"+W+"_"+R,coef:-1}],bnds:{type:g,ub:1,lb:1}},Y={name:"P_"+W+"_"+R,vars:[{name:"dP_"+W+"_"+R,coef:1},{name:"sP_"+W+"_"+R,coef:-1}],bnds:{type:g,ub:1,lb:1}},U={name:"IC_"+W+"_"+R,vars:[],bnds:{type:g,ub:J.IC,lb:J.IC}},X={name:"CC_"+W+"_"+R,vars:[],bnds:{type:u,ub:0,lb:-1/0}},Z={name:"RNB_"+W+"_"+R,vars:[],bnds:{type:N,ub:_,lb:F}},K={name:"CF_"+W+"_"+R,vars:[],bnds:{type:d,ub:1/0,lb:0}},ea={name:"STRAW_"+W+"_"+R,vars:[],bnds:{type:c,ub:C,lb:0}};r.purchasedFeed.forEach(function(e,a){I[a].vars.push({name:"F_"+e.lp_name+"_"+W+"_"+R,coef:1*V*y})}),r.grassSilageFirstCutFromArable[O]&&r.grassSilageFirstCutFromArable[O]["yield"]>0&&A.vars.push({name:"F_"+r.grassSilageFirstCutFromArable[O].lp_name+"_"+W+"_"+R,coef:1*V*y}),r.grassSilageLateCutFromArable[O]&&r.grassSilageLateCutFromArable[O]["yield"]>0&&j.vars.push({name:"F_"+r.grassSilageLateCutFromArable[O].lp_name+"_"+W+"_"+R,coef:1*V*y}),r.hayFromArable[O]&&r.hayFromArable[O]["yield"]>0&&L.vars.push({name:"F_"+r.hayFromArable[O].lp_name+"_"+W+"_"+R,coef:1*V*y}),r.grassSilageFirstCutFromGrassland[O]&&r.grassSilageFirstCutFromGrassland[O]["yield"]>0&&G.vars.push({name:"F_"+r.grassSilageFirstCutFromGrassland[O].lp_name+"_"+W+"_"+R,coef:1*V*y}),r.grassSilageLateCutFromGrassland[O]&&r.grassSilageLateCutFromGrassland[O]["yield"]>0&&z.vars.push({name:"F_"+r.grassSilageLateCutFromGrassland[O].lp_name+"_"+W+"_"+R,coef:1*V*y}),r.hayFromGrassland[O]&&r.hayFromGrassland[O]["yield"]>0&&B.vars.push({name:"F_"+r.hayFromGrassland[O].lp_name+"_"+W+"_"+R,coef:1*V*y}),r.maize[O]&&r.maize[O]["yield"]>0&&Q.vars.push({name:"F_"+r.maize[O].lp_name+"_"+W+"_"+R,coef:1*V*y});for(var aa=0,ra=q.length;ra>aa;aa++){var ta=q[aa];if(void 0!==ta&&null!==ta){if(void 0===ta.lp_name)throw new Error;H.vars.push({name:"F_"+ta.lp_name+"_"+W+"_"+R,coef:ta[D].E/J.req[D].total.E}),Y.vars.push({name:"F_"+ta.lp_name+"_"+W+"_"+R,coef:ta.de.P/J.req.de.total.P}),Z.vars.push({name:"F_"+ta.lp_name+"_"+W+"_"+R,coef:ta.de.RNB}),K.vars.push({name:"F_"+ta.lp_name+"_"+W+"_"+R,coef:ta.CF/1e3-.25}),"straw"===ta.type&&ea.vars.push({name:"F_"+ta.lp_name+"_"+W+"_"+R,coef:1}),"concentrate"===ta.type?(U.vars.push({name:"F_"+ta.lp_name+"_"+W+"_"+R,coef:J.FV_c}),X.vars.push({name:"F_"+ta.lp_name+"_"+W+"_"+R,coef:(1-E)/E})):(U.vars.push({name:"F_"+ta.lp_name+"_"+W+"_"+R,coef:ta.fr.FV}),X.vars.push({name:"F_"+ta.lp_name+"_"+W+"_"+R,coef:-1}))}}T.push({name:"GRAZING_"+W+"_"+R,vars:[{name:"F_grazing_"+W+"_"+R,coef:1}],bnds:{type:g,ub:void 0===a.DMI[W][R]?0:a.DMI[W][R],lb:void 0===a.DMI[W][R]?0:a.DMI[W][R]}}),H.vars.push({name:"F_grazing_"+W+"_"+R,coef:void 0===a.DMI[W][R]?0:a.attr[W][D].E/J.req[D].total.E}),Y.vars.push({name:"F_grazing_"+W+"_"+R,coef:void 0===a.DMI[W][R]?0:a.attr[W].de.P/J.req.de.total.P}),U.vars.push({name:"F_grazing_"+W+"_"+R,coef:void 0===a.DMI[W][R]?0:a.FV[W][R]}),X.vars.push({name:"F_grazing_"+W+"_"+R,coef:-1}),Z.vars.push({name:"F_grazing_"+W+"_"+R,coef:void 0===a.DMI[W][R]?0:a.attr[W].de.RNB}),k.push(H),k.push(Y),0===a.DMI[W][R]&&k.push(Z),k.push(U),k.push(X),k.push(ea),k.push(K)}S.subjectTo=S.subjectTo.concat(I),S.subjectTo=S.subjectTo.concat(T),r.grassSilageFirstCutFromArable[O]&&r.grassSilageFirstCutFromArable[O]["yield"]>0&&S.subjectTo.push(A),r.grassSilageLateCutFromArable[O]&&r.grassSilageLateCutFromArable[O]["yield"]>0&&S.subjectTo.push(j),r.hayFromArable[O]&&r.hayFromArable[O]["yield"]>0&&S.subjectTo.push(L),r.grassSilageFirstCutFromGrassland[O]&&r.grassSilageFirstCutFromGrassland[O]["yield"]>0&&S.subjectTo.push(G),r.grassSilageLateCutFromGrassland[O]&&r.grassSilageLateCutFromGrassland[O]["yield"]>0&&S.subjectTo.push(z),r.hayFromGrassland[O]&&r.hayFromGrassland[O]["yield"]>0&&S.subjectTo.push(B),r.maize[O]&&r.maize[O]["yield"]>0&&S.subjectTo.push(Q),i.push(S)
}var sa=$("#progress-diets"),ia=[];dairy.diet.glpk.onmessage=function(e){var a=e.data;if("string"==typeof a)console.log(a);else{a.result.status!==m&&(n=!0,ia.push(v+s.length)),s.push(a);var r=s.length/i.length*100;sa.css("width",r+"%").attr("aria-valuenow",r),s.length<i.length?dairy.diet.glpk.postMessage({lp:i[s.length],msg_lev:f}):(n&&dss.ui.failedLP(ia),t(s,b,n))}},dairy.diet.glpk.postMessage({lp:i[0],msg_lev:f})},runModel:function(){var a=dss.ui.model().model,r=function(r){dss.fn.cropGrowth(r,function(t){function s(e,a,r){var t={},s=.8,i=43,n=.61,o="hay"===a?850:350;if(t.GE=dairy.feed.evaluation.de.GE(e.CP,i,e.CF,e.OM),t.ME=dairy.feed.evaluation.de.ME(e.CP,i,n,e.CF,s,e.OM,e.OMD),t.E=dairy.feed.evaluation.de.E_f(t.ME,t.GE),t.P=dairy.feed.evaluation.de.uCP(t.ME,e.CP),t.RNB=dairy.feed.evaluation.de.RNB(e.CP,t.P),isNaN(t.E))throw new Error("isNaN(de.E)");var l={E:dairy.feed.evaluation.fi.E_f(e.OMD,e.OM)},d={E:dairy.feed.evaluation.gb.E_f(e.OM,e.OMD,!1)},u=0,c="grasssilage"===a?-1.4:0,g="grasssilage"===a?1.6:0,f="hay"===a?2.6:0,m="hay"===a?5.5:0,p=dairy.feed.evaluation.fr.QIL(e.OMD,e.CP,o,a,u,c,f,g,m),h={E:dairy.feed.evaluation.fr.E_f(e.OMD,e.OM,e.CP,e.CF,a,o/10,0,null,!0,1,1),FV:dairy.intake.FV_f(p,2)};return{lp_name:r,"yield":e["yield"],OM:e.OM,OMD:e.OMD,CP:e.CP,CF:e.CF,de:t,fi:l,fr:h,gb:d}}function i(e){var a=dairy.feed.feeds.reduce(function(a,r){return r.id===e&&a.push(r),a},[])[0];return"object"==typeof a&&null!==a&&(a=JSON.parse(JSON.stringify(a))),a}l=t;for(var u=dss.model.rotation.length,c="monthly"===a.simulation["time-step"]?30:14,g=0,f=l.pasture,m=f.noCows,p=f.averageCows,h=l.arable,y=l.grassland,v=a.grassland["grassland-area"],b=a.crop["arable-area"],_=a.grassland["pasture-share"]/100,F=a.grassland["hay-share"]/100,E=parseInt(a.simulation["start-year"],10),C=365*u/c|0,D=parseInt(a.herd["no-groups"],10),P=dss.weather.date.slice(365*(E-1995),365*(E+u-1995)),w=["x"],M=0;C>M;M++)w.push(P[M*c+c/2]);if(f)for(var O=f.HI_g,q=f.FV,S=f.OMD_g,x=f.OM_g,k=f.CP_g,N=f.CF_g,I=[],A=[],j=[],L=[],G=[],z=[],B=[];g<O.length;){var Q=O.slice(g,g+c),T=q.slice(g,g+c),W=S.slice(g,g+c),R=x.slice(g,g+c),J=k.slice(g,g+c),V=N.slice(g,g+c),H=Q.reduce(function(e,a){for(var r=0;D>r;r++)a[r]=a[r],void 0===e[r]&&(e[r]=0),void 0!=a[r]&&(e[r]+=a[r]/c),e[r]=parseFloat(e[r].toFixed(1));return e},[]);I.push(H);var Y=T.reduce(function(e,a){for(var r=0;D>r;r++)void 0===e[r]&&(e[r]=0),void 0!=a[r]&&(e[r]+=a[r]/c);return e},[]);A.push(Y);var U=W.reduce(function(e,a){return void 0!=a&&(e+=a/c),e},0);j.push(U);var X=R.reduce(function(e,a){return void 0!=a&&(e+=a/c),e},0);L.push(X);var Z=J.reduce(function(e,a){return void 0!=a&&(e+=a/c),e},0);G.push(Z);var K=V.reduce(function(e,a){return void 0!=a&&(e+=a/c),e},0);z.push(K);var ea={},aa=.82,ra=43,ta=.61,sa=18;if(ea.GE=dairy.feed.evaluation.de.GE(Z,ra,K,X),ea.ME=dairy.feed.evaluation.de.ME(Z,ra,ta,K,aa,X,U),ea.E=dairy.feed.evaluation.de.E_f(ea.ME,ea.GE),ea.P=dairy.feed.evaluation.de.uCP(ea.ME,Z),ea.RNB=dairy.feed.evaluation.de.RNB(Z,ea.P),isNaN(ea.E))throw new Error("isNaN(de.E)");var ia={E:dairy.feed.evaluation.fi.E_f(U,X)},na={E:dairy.feed.evaluation.gb.E_f(X,U,!1)},oa={E:dairy.feed.evaluation.fr.E_f(U,X,Z,K,"grasssilage",sa,0,null,!0,1,1)};B.push({de:ea,fr:oa,gb:na,fi:ia}),g+=c}var la={},da={},ua={},ca=v*(1-_);Object.keys(y.grasslandDM).forEach(function(e){"object"==typeof y.grasslandDM[e]&&(la[e]=JSON.parse(JSON.stringify(y.grasslandDM[e].firstCut)),la[e]["yield"]*=ca,da[e]=JSON.parse(JSON.stringify(y.grasslandDM[e].lateCut)),da[e]["yield"]*=ca*(1-F),ua[e]=JSON.parse(JSON.stringify(y.grasslandDM[e].lateCut)),ua[e]["yield"]*=ca*F)});for(var ga={grassSilageFirstCutFromArable:{},grassSilageLateCutFromArable:{},hayFromArable:{},maize:{}},fa={},ma=[],pa=[],ha=[],M=0;M<h.length;M++){ma[M]={},pa[M]={},ha[M]={};var ya=b*n[M]/u;h[M].maizeDM.forEach(function(e){Object.keys(e).forEach(function(a){void 0===ga.maize[a]?(ga.maize[a]=e[a]*ya,fa[a]=e[a]*ya):(ga.maize[a]+=e[a]*ya,fa[a]+=e[a]*ya)})});var va=h[M].grasslandDM.reduce(function(e,a){return Object.keys(a).forEach(function(r){"object"==typeof a[r]&&(void 0===e[r]?e[r]={first:a[r].firstCut.DMyield,late:a[r].lateCut.DMyield,count:a[r].firstCut.DMyield>0||a[r].lateCut.DMyield>0?1:0}:(e[r].first+=a[r].firstCut.DMyield,e[r].late+=a[r].lateCut.DMyield,(a[r].firstCut.DMyield>0||a[r].lateCut.DMyield>0)&&(e[r].count=e[r].count+1)))}),e},{});h[M].grasslandDM.forEach(function(e){Object.keys(e).forEach(function(a){if("object"==typeof e[a]){var r=e[a].firstCut.DMyield/va[a].first;isNaN(r)&&(r=0);var t=e[a].lateCut.DMyield/va[a].late;isNaN(t)&&(t=0),void 0===ma[M][a]?ma[M][a]={"yield":e[a].firstCut.DMyield*ya,OMD:e[a].firstCut.OMD*r,OM:e[a].firstCut.OM*r,CP:e[a].firstCut.CP*r,CF:e[a].firstCut.CF*r}:(ma[M][a]["yield"]+=e[a].firstCut.DMyield*ya,ma[M][a].OMD+=e[a].firstCut.OMD*r,ma[M][a].OM+=e[a].firstCut.OM*r,ma[M][a].CP+=e[a].firstCut.CP*r,ma[M][a].CF+=e[a].firstCut.CF*r),void 0===pa[M][a]?pa[M][a]={"yield":e[a].lateCut.DMyield*ya,OMD:e[a].lateCut.OMD*t,OM:e[a].lateCut.OM*t,CP:e[a].lateCut.CP*t,CF:e[a].lateCut.CF*t}:(pa[M][a]["yield"]+=e[a].lateCut.DMyield*ya,pa[M][a].OMD+=e[a].lateCut.OMD*t,pa[M][a].OM+=e[a].lateCut.OM*t,pa[M][a].CP+=e[a].lateCut.CP*t,pa[M][a].CF+=e[a].lateCut.CF*t),void 0===ga.grassSilageFirstCutFromArable[a]?ga.grassSilageFirstCutFromArable[a]=e[a].firstCut.DMyield*ya:ga.grassSilageFirstCutFromArable[a]+=e[a].firstCut.DMyield*ya,void 0===ga.hayFromArable[a]&&(ga.hayFromArable[a]=0),void 0===ga.grassSilageLateCutFromArable[a]&&(ga.grassSilageLateCutFromArable[a]=0)}})}),Object.keys(pa[M]).forEach(function(e){ha[M][e]=JSON.parse(JSON.stringify(pa[M][e])),ha[M][e]["yield"]*=F,pa[M][e]["yield"]*=1-F,ga.hayFromArable[e]+=ha[M][e]["yield"],ga.grassSilageLateCutFromArable[e]+=pa[M][e]["yield"]})}ma=ma.reduce(function(e,a){return Object.keys(a).forEach(function(r){var t=a[r]["yield"]/ga.grassSilageFirstCutFromArable[r];isNaN(t)&&(t=0),void 0===e[r]?e[r]={"yield":a[r]["yield"],OMD:a[r].OMD*t,OM:a[r].OM*t,CP:a[r].CP*t,CF:a[r].CF*t}:(e[r].OMD+=a[r].OMD*t,e[r].OM+=a[r].OM*t,e[r].CP+=a[r].CP*t,e[r].CF+=a[r].CF*t)}),e},{}),pa=pa.reduce(function(e,a){return Object.keys(a).forEach(function(r){var t=a[r]["yield"]/ga.grassSilageLateCutFromArable[r];if(1/0===t)throw new Error;isNaN(t)&&(t=0),void 0===e[r]?e[r]={"yield":a[r]["yield"],OMD:a[r].OMD*t,OM:a[r].OM*t,CP:a[r].CP*t,CF:a[r].CF*t}:(e[r].OMD+=a[r].OMD*t,e[r].OM+=a[r].OM*t,e[r].CP+=a[r].CP*t,e[r].CF+=a[r].CF*t)}),e},{}),ha=ha.reduce(function(e,a){return Object.keys(a).forEach(function(r){var t=a[r]["yield"]/ga.hayFromArable[r];isNaN(t)&&(t=0),void 0===e[r]?e[r]={"yield":a[r]["yield"],OMD:a[r].OMD*t,OM:a[r].OM*t,CP:a[r].CP*t,CF:a[r].CF*t}:(e[r].OMD+=a[r].OMD*t,e[r].OM+=a[r].OM*t,e[r].CP+=a[r].CP*t,e[r].CF+=a[r].CF*t)}),e},{}),Object.keys(ma).forEach(function(e){ma[e]=s(ma[e],"grasssilage","grasssilage-arable-1st")}),Object.keys(pa).forEach(function(e){pa[e]=s(pa[e],"grasssilage","grasssilage-arable-late")}),Object.keys(ha).forEach(function(e){ha[e]=s(ha[e],"hay","hay-arable")}),Object.keys(la).forEach(function(e){la[e]=s(la[e],"grasssilage","grasssilage-1st")}),Object.keys(da).forEach(function(e){da[e]=s(da[e],"grasssilage","grasssilage-late")}),Object.keys(ua).forEach(function(e){ua[e]=s(ua[e],"hay","hay")}),Object.keys(fa).forEach(function(e){fa[e]=s({"yield":fa[e],DM:270,OM:948,OMD:.75,CP:88,CF:190},"maizesilage","maizesilage")});var ba,_a=a.feed["straw-type"];if(ba=(_a="barley")?{id:50,lp_name:"straw",type:"straw",name:"Barley, straw",name_de:"Gerste, Stroh",delta_F1:0,delta_C1:0,delta_FR1_QIL:0,delta_S1_QIL:0,delta_S2_QIL:0,delta_H1_QIL:0,delta_H2_QIL:0,delta_FR1_QIB:0,delta_S1_QIB:0,delta_S2_QIB:0,delta_H1_QIB:0,delta_H2_QIB:0,eco:1,DM:860,ash:59,OM:941,OMD:.5,CP:39,CPD:.1,EE:16,EED:.41,CF:442,CFD:.55,NFE:444,NFED:.48,NDF:798,starch:0,sugar:7}:"oats"===_a?{id:51,lp_name:"straw",type:"straw",name:"Oats, straw",name_de:"Hafer, Stroh",delta_F1:0,delta_C1:0,delta_FR1_QIL:0,delta_S1_QIL:0,delta_S2_QIL:0,delta_H1_QIL:0,delta_H2_QIL:0,delta_FR1_QIB:0,delta_S1_QIB:0,delta_S2_QIB:0,delta_H1_QIB:0,delta_H2_QIB:0,eco:1,DM:860,ash:66,OM:934,OMD:.5,CP:35,CPD:.3,EE:15,EED:.34,CF:440,CFD:.58,NFE:444,NFED:.44,NDF:796,starch:0,sugar:14}:{id:52,lp_name:"straw",type:"straw",name:"Wheat, straw",name_de:"Weizen, Stroh",delta_F1:0,delta_C1:0,delta_FR1_QIL:0,delta_S1_QIL:0,delta_S2_QIL:0,delta_H1_QIL:0,delta_H2_QIL:0,delta_FR1_QIB:0,delta_S1_QIB:0,delta_S2_QIB:0,delta_H1_QIB:0,delta_H2_QIB:0,eco:1,DM:860,ash:78,OM:922,OMD:.47,CP:37,CPD:.27,EE:13,EED:.43,CF:429,CFD:.56,NFE:443,NFED:.42,NDF:798,starch:0,sugar:8},ba=dss.fn.feedEvaluation([ba])[0],h.length>0){for(var Fa=[],Ea={},Ca={},Da=[],M=0;M<h.length;M++){var Pa=h[M].yields.reduce(function(e,a){return a.forEach(function(a){void 0===e[a.year]&&(e[a.year]={}),void 0===e[a.year][a.crop]?e[a.year][a.crop]=1:e[a.year][a.crop]+=1,Da.indexOf(a.crop)<0&&Da.push(a.crop)}),e},{}),wa=h[M].yields.reduce(function(e,a){return a.forEach(function(a){void 0===e[a.year]&&(e[a.year]={}),void 0===e[a.year][a.crop]?e[a.year][a.crop]=a["yield"]/Pa[a.year][a.crop]:e[a.year][a.crop]+=a["yield"]/Pa[a.year][a.crop]}),e},{});Object.keys(wa).forEach(function(e){void 0===Ca[e]&&(Ca[e]={}),Object.keys(wa[e]).forEach(function(a){void 0===Ca[e][a]?Ca[e][a]=wa[e][a]*n[M]*dss.model.crop["arable-area"]:Ca[e][a]+=wa[e][a]*n[M]*dss.model.crop["arable-area"]})});var Ma=h[M].grasslandDM.map(function(e){var a={};return Object.keys(e).forEach(function(r){var t=r.substring(0,4);void 0===a[t]?a[t]=e[r]:a[t]+=e[r]}),a}),Oa={};Ma.forEach(function(e){Object.keys(e).forEach(function(e){void 0===Oa[e]?Oa[e]=1:Oa[e]+=1})});var qa=Ma.reduce(function(e,a){return Object.keys(a).forEach(function(r){void 0===e[r]?e[r]=a[r]/Oa[r]:e[r]+=a[r]/Oa[r]}),e},{});Fa.push(qa)}Fa.reduce(function(e,a,r){return Object.keys(a).forEach(function(t){void 0===e[t]?e[t]=a[t]*n[r]*dss.model.crop["arable-area"]:e[t]+=a[t]*n[r]*dss.model.crop["arable-area"]}),e},Ea)}y&&Object.keys(y.grasslandDM).forEach(function(e){var a=parseInt(e.substring(0,4),10);a>E&&(void 0===Ea[a]?Ea[a]=y.grasslandDM[e]*v*(1-_):Ea[a]+=y.grasslandDM[e]*v*(1-_))});var Sa=parseFloat(a.feed["concentrate-share"])>0?dss.fn.feedEvaluation(dss.fn.purchasedFeed()):[];Da.push("grasssilage");for(var xa={},M=0;M<Da.length;M++){var ka=0;switch(Da[M]){case"wheat":ka=60;break;case"grasssilage":ka=22;break;case"maize-silage":ka=32;break;case"barley":ka=53;break;case"oats":ka=56;break;case"rye":ka=58}if(!(ka>0))throw new Error("Unknown feed");xa[Da[M]]=dss.fn.feedEvaluation([i(ka)])[0]}for(var Na=[],M=0;M<Sa.length;M++)Sa[M].lp_name=Sa[M].name;var ka=2e3;if(Object.keys(Ca).sort(function(e,a){return e-a}).forEach(function(e){Object.keys(Ca[e]).forEach(function(a){if("maize-silage"===a){var r=(Ca[e][a],JSON.parse(JSON.stringify(xa[a])));r.id=ka,r.source=e,r.startPeriod=356*(e-E+1)/c|0,r.endPeriod=r.startPeriod+12*d/c|0,r.endPeriod>C&&(r.startPeriod=0,r.endPeriod=r.startPeriod+12*d/c|0),ka--,Na.push(r)}})}),Object.keys(Ea).sort(function(e,a){return e-a}).forEach(function(e){var a=(Ea[e],JSON.parse(JSON.stringify(xa.grasssilage)));a.id=ka,a.source=e,a.startPeriod=-1/0,a.endPeriod=1/0,ka--,Na.push(a)}),r.dry.length>0){var Ia=JSON.parse(JSON.stringify(r.dry[0]));if(2===r.dry.length){var Aa=r.dry[1],ja=Ia.no+Aa.no;Ia.FV_c=Ia.FV_c*Ia.no/ja+Aa.FV_c*Aa.no/ja,Ia.IC=Ia.IC*Ia.no/ja+Aa.IC*Aa.no/ja,Ia.parity=Math.round(Ia.parity*Ia.no/ja+Aa.parity*Aa.no/ja),Ia.req.de.main.E=Ia.req.de.main.E*Ia.no/ja+Aa.req.de.main.E*Aa.no/ja,Ia.req.de.main.P=Ia.req.de.main.P*Ia.no/ja+Aa.req.de.main.P*Aa.no/ja,Ia.req.de.total.E=Ia.req.de.total.E*Ia.no/ja+Aa.req.de.total.E*Aa.no/ja,Ia.req.de.total.P=Ia.req.de.total.P*Ia.no/ja+Aa.req.de.total.P*Aa.no/ja,Ia.req.fi.main.E=Ia.req.fi.main.E*Ia.no/ja+Aa.req.fi.main.E*Aa.no/ja,Ia.req.fi.total.E=Ia.req.fi.total.E*Ia.no/ja+Aa.req.fi.total.E*Aa.no/ja,Ia.req.gb.main.E=Ia.req.gb.main.E*Ia.no/ja+Aa.req.gb.main.E*Aa.no/ja,Ia.req.gb.total.E=Ia.req.gb.total.E*Ia.no/ja+Aa.req.gb.total.E*Aa.no/ja,Ia.req.fr.main.E=Ia.req.fr.main.E*Ia.no/ja+Aa.req.fr.main.E*Aa.no/ja,Ia.req.fr.total.E=Ia.req.fr.total.E*Ia.no/ja+Aa.req.fr.total.E*Aa.no/ja,Ia.no=ja}r.nonDry.push(Ia),D+=1}dss.fn.runLP(r,{FV:A,DMI:I,attr:B},{grassSilageFirstCutFromArable:ma,grassSilageLateCutFromArable:pa,hayFromArable:ha,grassSilageFirstCutFromGrassland:la,grassSilageLateCutFromGrassland:da,hayFromGrassland:ua,maize:fa,purchasedFeed:Sa,straw:ba},function(a,t,s){$("#result-water-select").empty().selectpicker("refresh");var i="";o.forEach(function(e,a){i+='<optgroup label="Rotation '+(a+1)+'">',e.forEach(function(e,r){i+='<option data-id=\'{"rotation":'+a+', "shift":'+r+"}'>"+e.map(function(e){return e.cropName}).join(" &gt; ")+"</option>"}),i+="</optgroup>"}),$("#result-water-select").append(i).selectpicker("refresh").on("change",function(){var a=$(this).find("option")[$(this).prop("selectedIndex")],r=$(a).data("id"),t=l.arable[r.rotation].paramsAvg[r.shift],s=["x"].concat(t.date),i=["water deficit"].concat(t.waterStress),n=["nitrogen deficit"].concat(t.nitrogenStress),d=["irrigation"].concat(t.irrigation),u=[s,i,n,d];e&&u.push(["biomass"].concat(t.biomass));var c=o[r.rotation][r.shift].map(function(e,a){return{axis:"x",start:e.seed,end:e.harvest,"class":a%2===0?"region-grey1":"region-grey2",opacity:.25}});dss.ui.charts.results.water.load({columns:u}),dss.ui.charts.results.water.regions.remove(),dss.ui.charts.results.water.regions.add(c)}).trigger("change"),$("#result-yield-select").empty().selectpicker("refresh");var i="";o.forEach(function(e,a){i+='<option data-id=\'{"rotation":'+a+"}'>"+e[0].map(function(e){return e.cropName}).join(" &gt; ")+"</option>"}),dss.ui.charts.results["yield"].destroy(),dss.ui.charts.results["yield"]=c3.generate({bindto:"#yield-chart",data:{x:"x",columns:[],type:"bar"},bar:{width:{ratio:.5}},axis:{y:{show:!0,label:"[kg DM / ha]"}},regions:[],point:{show:!1}}),$("#result-yield-select").append(i).selectpicker("refresh").on("change",function(){var e=$(this).find("option")[$(this).prop("selectedIndex")],a=$(e).data("id"),r=["x"],t=[r],s=l.arable[a.rotation].params.reduce(function(e,a){var r=a["yield"].reduce(function(e,a){return void 0===e[a.cropName]?e[a.cropName]=1:e[a.cropName]+=1,e},{});return a["yield"].forEach(function(a,t){void 0===e[a.cropName]&&(e[a.cropName]=[]),void 0===e[a.cropName][t]&&(e[a.cropName][t]=0),e[a.cropName][t]+=Math.round(a.DM/r[a.cropName])}),e},{});Object.keys(s).forEach(function(e){for(var a=0;a<s[e].length;a++)s[e][a]=void 0===s[e][a]?0:s[e][a];s[e]=s[e].map(function(e){return void 0===e?0:e}),t.push([e].concat(s[e]))});for(var i=0;u>i;i++)r.push(E+i);dss.ui.charts.results["yield"].data().forEach(function(e){e.values.forEach(function(e){e.value=0})}),dss.ui.charts.results["yield"].load({columns:t})}).trigger("change");for(var n=[["x"],["grasssilage-1st"],["grasssilage-late"],["hay"]],d=E;E+u>d;d++)n[0].push(d),n[1].push(parseFloat((la[d]["yield"]/ca).toFixed(2))),n[2].push(parseFloat((da[d]["yield"]/ca).toFixed(2))),n[3].push(parseFloat((ua[d]["yield"]/ca).toFixed(2)));dss.ui.charts.results.yieldGrassland.load({columns:n});var g=["intake"].concat(I.map(function(e){return e.reduce(function(e,a,r){return parseFloat((e+a*p[r].no/m).toFixed(1))},0)})),f={columns:[g,w]};if(e){for(var h=[],d=0;D>d;d++)h.push(["FV"+d]);f.columns=f.columns.concat(A.reduce(function(e,a){return a.forEach(function(a,r){e[r].push(a)}),e},h)),f.columns.push(["CP"].concat(G)),f.columns.push(["OMD"].concat(j)),f.columns.push(["CF"].concat(z)),f.axes={FV:"y",OMD:"y",CP:"y2",CF:"y2"},dss.ui.charts.results.intake.axis({y2:{show:!0}})}if(dss.ui.charts.results.intake.load(f),$("#diet-charts").empty(),!s){for(var d=0;D>d;d++)$("#diet-charts").append("<h4>Group "+(d+1===D?"Dry":d+1)+", "+r.nonDry[d].no+' cows</h4>                    <p></p>                    <p>Energy and protein deficit and surplus in % requirements</p>                    <p>                      <div id="diet-budget-chart-'+d+'" class="chart"></div>                    </p>                    <p>Total mixed ration</p>                    <p>                      <div id="diet-chart-'+d+'" class="chart"></div>                    </p>');for(var y=[],v=[],b=[],_=0;D>_;_++)y.push(["Energy"]),v.push(["Protein"]),b.push({});a.forEach(function(e,a){var r,s=e.result.vars,i=Object.keys(s);if(5===e.result.status){for(var n=0;t>n;n++)for(var o=0;D>o;o++){var l=s["sP_"+n+"_"+o],d=s["dP_"+n+"_"+o],u=s["sE_"+n+"_"+o],c=s["dE_"+n+"_"+o];v[o].push(Math.round(0===d?100*l:-100*d)),y[o].push(Math.round(0===c?100*u:-100*c))}var g=1,f=2,m=3;i.forEach(function(e){var i=e.split("_"),n=parseInt(i[f],10);"F"===i[0]&&(r=s[e],void 0===b[i[m]][i[g]]&&(b[i[m]][i[g]]=[]),b[i[m]][i[g]][n+a*t]=parseFloat(r.toFixed(1)))})}});var F=t*u;b.forEach(function(e){Object.keys(e).forEach(function(a){for(var r=0;F>r;r++)void 0===e[a][r]&&(e[a][r]=0)})}),dss.ui.charts.results.diet.forEach(function(e){e.destroy()}),dss.ui.charts.results.diet=[],dss.ui.charts.results.dietBudget.forEach(function(e){e.destroy()}),dss.ui.charts.results.dietBudget=[],b.forEach(function(e,a){var r=Object.keys(b[a]).map(function(e){return[e].concat(b[a][e])});r.push(w);var t=c3.generate({bindto:"#diet-budget-chart-"+a,data:{x:"x",columns:[y[a],v[a],w],axes:{Energy:"y",Protein:"y2"},type:"line"},axis:{x:{type:"timeseries",tick:{format:"%Y/%m",values:["1995-06-01","1996-06-01","1997-06-01","1998-06-01","1999-06-01","2000-06-01","2001-06-01","2002-06-01","2003-06-01","2004-06-01","2005-06-01","2006-06-01","2007-06-01","2008-06-01","2009-06-01","2010-06-01","2011-06-01","2012-06-01","2013-06-01"]}},y:{show:!0,label:"[%]"},y2:{show:!0,label:"[%]"}},point:{show:!1}});dss.ui.charts.results.dietBudget.push(t);var s=c3.generate({bindto:"#diet-chart-"+a,data:{x:"x",columns:r,types:Object.keys(b[a]).concat(["grazing"]).reduce(function(e,a){return e[a]="area",e},{}),groups:[Object.keys(b[a]).concat(["grazing"])]},axis:{x:{type:"timeseries",tick:{format:"%Y/%m",values:["1995-06-01","1996-06-01","1997-06-01","1998-06-01","1999-06-01","2000-06-01","2001-06-01","2002-06-01","2003-06-01","2004-06-01","2005-06-01","2006-06-01","2007-06-01","2008-06-01","2009-06-01","2010-06-01","2011-06-01","2012-06-01","2013-06-01"]}},y:{show:!0,label:"[kg DM / cow]"}},point:{show:!1}});dss.ui.charts.results.diet.push(s)});for(var C=[],d=0;d<a.length;d++)C.push(E+d);C.unshift(C.pop());var P=b.reduce(function(e,s,i){var n=r.nonDry[i].no;return Object.keys(s).forEach(function(r){if("grazing"!==r){if(void 0===e[r]){e[r]=[];for(var i=0;i<a.length;i++)e[r][i]=0}for(var i=0;i<a.length;i++){for(var o=i*t;(i+1)*t>o;o++)e[r][i]-=s[r][o]*n*c/1e3;e[r][i]=parseFloat(e[r][i].toFixed(1))}}}),e},{}),M=[];Object.keys(P).forEach(function(e){P[e].forEach(function(a,r){var t=C[r];ma[t]&&e===ma[t].lp_name&&(P[e][r]=parseFloat((a+ma[t]["yield"]/1e3).toFixed(1))),pa[t]&&e===pa[t].lp_name&&(P[e][r]=parseFloat((a+pa[t]["yield"]/1e3).toFixed(1))),ha[t]&&e===ha[t].lp_name&&(P[e][r]=parseFloat((a+ha[t]["yield"]/1e3).toFixed(1))),la[t]&&e===la[t].lp_name&&(P[e][r]=parseFloat((a+la[t]["yield"]/1e3).toFixed(1))),da[t]&&e===da[t].lp_name&&(P[e][r]=parseFloat((a+da[t]["yield"]/1e3).toFixed(1))),ua[t]&&e===ua[t].lp_name&&(P[e][r]=parseFloat((a+ua[t]["yield"]/1e3).toFixed(1))),fa[t]&&e===fa[t].lp_name&&(P[e][r]=parseFloat((a+fa[t]["yield"]/1e3).toFixed(1)))}),M.push([e].concat(P[e]))}),C.push(C.shift()),dss.ui.charts.results.feedSurplus.destroy(),dss.ui.charts.results.feedSurplus=c3.generate({bindto:"#feed-surplus-chart",data:{x:"x",columns:M.concat([["x"].concat(C)]),type:"bar",bar:{width:{ratio:.9}}},axis:{y:{show:!0,label:"[tonne DM / year]"}}}),setTimeout(function(){dss.ui.progress.modal("hide")},1e3)}})})};dss.fn.fitWood(dss.ui.milkYieldData(),function(e){if(Array.isArray(e)){dss.fn.herdStructure(),dss.fn.cowProperties(),dss.fn.groupCowsForTMRfeeding();var a=dss.fn.getAverageTMRcows(),t=dss.ui.model().model.feed["eval-system"],s=[],i=a.nonDry.reduce(function(e,a,r){return e[0].push(Math.round(a.req[t].total.E)),e[1].push(Math.round(a.req.de.total.P)),s.push("Group "+(r+1)),e},[["Energy"],["Protein"]]);if(dss.ui.charts.requirements.axis.labels({y:"Energy ["+("de"===t?"MJ NEL":"fr"===t?"UFL":"MJ ME")+" / cow]",y2:"Protein [g uCP]"}),dss.ui.charts.requirements.load({columns:i,categories:s}),dss.fn.modelChanged("location")||0===dss.weather.date.length){var n=parseFloat(Number($("#latitude").prop("value")).toFixed(3)),o=parseFloat(Number($("#longitude").prop("value")).toFixed(3));dss.fn.weather(n,o,function(e,t){null===e&&t?$(getAlert("Error.",t.text,"danger")).prependTo($("body")).delay(6e3).fadeOut(500,function(){$(this).remove()}):r(a)})}else r(a)}})}};var g=window.location.search.substring(1).split("&"),f="",m=!1;if(g.forEach(function(e){var a=e.split("=");"file"===a[0]?f=a[1]:"action"===a[0]&&"run"===a[1]&&(m=!0)}),f.length>0){var p=location.href.substr(0,location.href.lastIndexOf("/"))+"/examples/"+f+".json";$.ajax({type:"GET",url:p,dataType:"json",success:function(e){try{var a=e;"string"==typeof e&&(a=JSON.parse(a)),a.location&&dss.ui.map.fireEvent("click",{latlng:L.latLng(a.location.latitude,a.location.longitude)}),dss.ui.setModel(a),m&&$("#run-btn").trigger("click")}catch(r){console.log(r)}},error:function(){$(getAlert("","Could not load file '"+filename+"'","warning")).prependTo($("body")).delay(6e3).fadeOut(500,function(){$(this).remove()})}})}});